<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:TheCabin.Maui.ViewModels"
             xmlns:models="clr-namespace:TheCabin.Maui.Models"
             xmlns:converters="clr-namespace:TheCabin.Maui.Converters"
             x:Class="TheCabin.Maui.MainPage"
             x:DataType="vm:MainViewModel"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToColorConverter x:Key="BoolToRecordingColor" 
                                             TrueColor="#F44336" 
                                             FalseColor="#2196F3" />
            <converters:NarrativeTypeToColorConverter x:Key="NarrativeTypeToColor" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto,Auto,Auto" Padding="16">
        
        <!-- Stats Bar -->
        <Border Grid.Row="0" 
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Stroke="{DynamicResource PrimaryColor}"
                StrokeThickness="1"
                Padding="12,8"
                Margin="0,0,0,8">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8"/>
            </Border.StrokeShape>
            <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                <Label Grid.Column="0" 
                       Text="{Binding CurrentLocation}"
                       FontSize="16"
                       FontAttributes="Bold"
                       TextColor="{DynamicResource PrimaryTextColor}"/>
                <HorizontalStackLayout Grid.Column="1" Spacing="8" Margin="12,0,0,0">
                    <Label Text="❤️" FontSize="16"/>
                    <Label Text="{Binding PlayerHealth}" 
                           FontSize="14"
                           TextColor="{DynamicResource PrimaryTextColor}"/>
                </HorizontalStackLayout>
                <HorizontalStackLayout Grid.Column="2" Spacing="8" Margin="12,0,0,0">
                    <Label Text="💡" FontSize="16"/>
                    <Label Text="{Binding LightLevel}" 
                           FontSize="14"
                           TextColor="{DynamicResource PrimaryTextColor}"/>
                </HorizontalStackLayout>
                <HorizontalStackLayout Grid.Column="3" Spacing="8" Margin="12,0,0,0">
                    <Label Text="🕐" FontSize="16"/>
                    <Label Text="{Binding GameTime}" 
                           FontSize="14"
                           TextColor="{DynamicResource PrimaryTextColor}"/>
                </HorizontalStackLayout>
            </Grid>
        </Border>
        
        <!-- Story Feed -->
        <Border Grid.Row="1" 
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Stroke="{DynamicResource PrimaryColor}"
                StrokeThickness="1"
                Padding="16">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8"/>
            </Border.StrokeShape>
            <CollectionView ItemsSource="{Binding StoryFeed}"
                           VerticalScrollBarVisibility="Always">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:NarrativeEntry">
                        <Grid Padding="0,8">
                            <Label Text="{Binding Text}"
                                   TextColor="{Binding Type, Converter={StaticResource NarrativeTypeToColor}}"
                                   FontSize="16"
                                   LineBreakMode="WordWrap"
                                   FontAttributes="{Binding IsImportant, Converter={StaticResource BoolToFontAttributes}}"/>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="32"
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center">
                        <Label Text="🏚️"
                               FontSize="64"
                               HorizontalOptions="Center"/>
                        <Label Text="Welcome to The Cabin"
                               FontSize="20"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               Margin="0,16,0,8"
                               TextColor="{DynamicResource PrimaryTextColor}"/>
                        <Label Text="Tap the microphone to begin your adventure"
                               FontSize="14"
                               HorizontalOptions="Center"
                               TextColor="{DynamicResource SecondaryTextColor}"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Border>
        
        <!-- Transcript Preview -->
        <Border Grid.Row="2"
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Stroke="{DynamicResource AccentColor}"
                StrokeThickness="1"
                Padding="12"
                Margin="0,8"
                IsVisible="{Binding IsListening}">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8"/>
            </Border.StrokeShape>
            <HorizontalStackLayout Spacing="8">
                <Label Text="🎤" FontSize="16"/>
                <Label Text="{Binding TranscriptText}"
                       FontSize="14"
                       TextColor="{DynamicResource SecondaryTextColor}"/>
            </HorizontalStackLayout>
        </Border>
        
        <!-- Voice Control Button -->
        <Grid Grid.Row="3" 
              Padding="0,16"
              HorizontalOptions="Center">
            <Button Command="{Binding ToggleListeningCommand}"
                    HeightRequest="80"
                    WidthRequest="80"
                    CornerRadius="40"
                    BackgroundColor="{Binding IsListening, Converter={StaticResource BoolToRecordingColor}}"
                    BorderWidth="3"
                    BorderColor="{DynamicResource PrimaryColor}"
                    Text="🎙️"
                    FontSize="32"
                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InvertedBoolConverter}}"
                    SemanticProperties.Description="Tap to speak a command"
                    SemanticProperties.Hint="Records your voice command for the game"/>
            
            <!-- Processing Indicator -->
            <ActivityIndicator IsRunning="{Binding IsProcessing}"
                             IsVisible="{Binding IsProcessing}"
                             Color="{DynamicResource PrimaryColor}"
                             HeightRequest="80"
                             WidthRequest="80"
                             InputTransparent="True"/>
        </Grid>
        
        <!-- Bottom Navigation -->
        <Border Grid.Row="4" 
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Stroke="{DynamicResource PrimaryColor}"
                StrokeThickness="1"
                Padding="8">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8"/>
            </Border.StrokeShape>
            <Grid ColumnDefinitions="*,*,*">
                <Button Grid.Column="0"
                        Text="🎒 Inventory"
                        Command="{Binding ShowInventoryCommand}"
                        FontSize="12"
                        BackgroundColor="Transparent"
                        TextColor="{DynamicResource PrimaryTextColor}"/>
                <Button Grid.Column="1"
                        Text="📖 Menu"
                        Command="{Binding ShowMenuCommand}"
                        FontSize="12"
                        BackgroundColor="Transparent"
                        TextColor="{DynamicResource PrimaryTextColor}"/>
                <Button Grid.Column="2"
                        Text="⚙️ Settings"
                        Command="{Binding ShowSettingsCommand}"
                        FontSize="12"
                        BackgroundColor="Transparent"
                        TextColor="{DynamicResource PrimaryTextColor}"/>
            </Grid>
        </Border>
        
    </Grid>
</ContentPage>
