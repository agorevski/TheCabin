[{"role":"user","content":[{"type":"text","text":"<task>\n'docs' (see below for file content) \n\nPlease plan and design an android app given the documentation in the above folder\n</task>\n\n<file_content path=\"docs\">\n├── 01-project-overview.md\n├── 02-system-architecture.md\n├── 03-technical-stack.md\n├── 04-data-models.md\n├── 05-voice-pipeline.md\n├── 06-game-engine.md\n├── 07-ui-ux-design.md\n├── 08-maui-implementation.md\n├── 09-content-management.md\n├── 10-deployment-strategy.md\n└── 11-future-roadmap.md\n\n<file_content path=\"docs/01-project-overview.md\">\n# 01 - Project Overview\r\n\r\n## Executive Summary\r\n\r\n**The Cabin** is a voice-controlled interactive fiction game for Android, built using .NET MAUI. Players explore mysterious environments by speaking commands, experiencing an immersive narrative-driven adventure that combines classic text adventure gameplay with modern speech recognition and AI-powered natural language processing.\r\n\r\n## Project Goals\r\n\r\n### Primary Objectives\r\n\r\n1. **Voice-First Experience**: Create a hands-free gaming experience using speech recognition and text-to-speech\r\n2. **Cross-Platform Foundation**: Leverage .NET MAUI for potential future iOS support while initially targeting Android\r\n3. **AI-Enhanced Gameplay**: Integrate LLM-based command parsing for natural language understanding\r\n4. **Rich Narrative Content**: Support multiple thematic story packs with extensible content system\r\n5. **Offline Capability**: Ensure core gameplay functions without internet connectivity\r\n\r\n### Success Criteria\r\n\r\n- Speech recognition accuracy > 90% for common commands\r\n- Command processing latency < 2 seconds\r\n- Smooth 60 FPS UI performance\r\n- Support for 5+ thematic story packs\r\n- Battery consumption < 15% per hour of gameplay\r\n\r\n## Scope\r\n\r\n### In Scope\r\n\r\n- Android application (API Level 23+, Android 6.0+)\r\n- Voice input and output\r\n- 5 pre-built thematic story packs\r\n- Local game state persistence\r\n- Offline speech recognition option\r\n- Online LLM integration for command parsing\r\n- Text-based gameplay with voice narration\r\n- Inventory and puzzle systems\r\n- Save/load functionality\r\n\r\n### Out of Scope (MVP)\r\n\r\n- iOS implementation\r\n- Multiplayer functionality\r\n- AR/VR features\r\n- Smart speaker integration\r\n- Real-time voice synthesis during gameplay\r\n- User-generated content tools\r\n- Cloud save synchronization\r\n\r\n### Future Considerations\r\n\r\n- iOS version via MAUI\r\n- Procedurally generated content\r\n- Community content marketplace\r\n- Accessibility features (visual impairment support)\r\n- Localization and multi-language support\r\n\r\n## Technology Stack Justification\r\n\r\n### .NET MAUI\r\n\r\n**Chosen for:**\r\n\r\n- Native Android performance\r\n- C# language benefits (strong typing, async/await, LINQ)\r\n- Extensive library ecosystem\r\n- Future cross-platform expansion (iOS, Windows)\r\n- Mature MVVM framework support\r\n- Microsoft backing and long-term support\r\n\r\n**Alternatives Considered:**\r\n\r\n- Native Kotlin: Limited to Android only\r\n- Flutter: Dart language less familiar to .NET developers\r\n- React Native: Performance concerns for real-time audio\r\n- Xamarin.Forms: Deprecated in favor of MAUI\r\n\r\n### Android Target Platform\r\n\r\n**Minimum SDK**: API Level 23 (Android 6.0 Marshmallow)\r\n\r\n- 95%+ device coverage\r\n- Runtime permissions model support\r\n- Modern speech recognition APIs\r\n\r\n**Target SDK**: API Level 34 (Android 14)\r\n\r\n- Latest security and performance features\r\n- Predictive back gesture support\r\n- Enhanced privacy controls\r\n\r\n## Key Technical Challenges\r\n\r\n### 1. Speech Recognition Accuracy\r\n\r\n**Challenge**: Ambient noise, accents, and command variations\r\n**Mitigation**:\r\n\r\n- Confidence threshold filtering\r\n- Context-aware re-prompting\r\n- Multiple recognition engine support\r\n- User calibration option\r\n\r\n### 2. LLM Integration Latency\r\n\r\n**Challenge**: Network delays affecting gameplay flow\r\n**Mitigation**:\r\n\r\n- Command caching for common actions\r\n- Local fallback parser for basic commands\r\n- Async processing with loading indicators\r\n- Optimistic UI updates\r\n\r\n### 3. Battery Consumption\r\n\r\n**Challenge**: Continuous microphone and CPU usage\r\n**Mitigation**:\r\n\r\n- Push-to-talk option alongside voice activation\r\n- Efficient audio processing\r\n- TTS caching\r\n- Background processing optimization\r\n\r\n### 4. Offline Functionality\r\n\r\n**Challenge**: LLM dependency for command parsing\r\n**Mitigation**:\r\n\r\n- Local rule-based parser for standard commands\r\n- Offline-capable ML model integration (optional)\r\n- Graceful degradation of features\r\n- Clear online/offline mode indicators\r\n\r\n## Project Timeline (Estimated)\r\n\r\n### Phase 1: Foundation (4-6 weeks)\r\n\r\n- Project setup and architecture\r\n- Core MAUI application structure\r\n- Basic UI implementation\r\n- Data models and storage layer\r\n\r\n### Phase 2: Voice Pipeline (4-6 weeks)\r\n\r\n- Speech recognition integration\r\n- LLM parser implementation\r\n- TTS integration\r\n- Command processing engine\r\n\r\n### Phase 3: Game Engine (6-8 weeks)\r\n\r\n- State machine implementation\r\n- Room navigation system\r\n- Inventory and puzzle mechanics\r\n- Story pack loader\r\n\r\n### Phase 4: Polish & Testing (4-6 weeks)\r\n\r\n- UI/UX refinement\r\n- Performance optimization\r\n- Testing and bug fixes\r\n- Documentation\r\n\r\n### Phase 5: Deployment (2-3 weeks)\r\n\r\n- Google Play preparation\r\n- Beta testing\r\n- Release preparation\r\n\r\n**Total Estimated Timeline**: 20-29 weeks (5-7 months)\r\n\r\n## Success Metrics\r\n\r\n### Technical Metrics\r\n\r\n- App startup time < 3 seconds\r\n- Memory usage < 150 MB\r\n- APK size < 50 MB\r\n- Crash rate < 1%\r\n\r\n### User Experience Metrics\r\n\r\n- Voice command success rate > 85%\r\n- Average session length > 15 minutes\r\n- Game completion rate > 40%\r\n- User rating target: 4.0+ stars\r\n\r\n### Performance Metrics\r\n\r\n- 60 FPS UI rendering\r\n- Audio latency < 200ms\r\n- Command processing < 2 seconds\r\n- Battery drain < 15% per hour\r\n\r\n## Risk Assessment\r\n\r\n| Risk | Probability | Impact | Mitigation |\r\n|------|-------------|--------|------------|\r\n| Speech recognition accuracy insufficient | Medium | High | Multiple engine support, fallback text input |\r\n| LLM costs too high | Medium | Medium | Local parser fallback, command caching |\r\n| Battery drain excessive | Low | High | Push-to-talk mode, optimization |\r\n| Content creation bottleneck | Medium | Medium | AI-assisted content generation tools |\r\n| Android fragmentation issues | Medium | Medium | Extensive device testing, graceful degradation |\r\n\r\n## Team Structure Requirements\r\n\r\n### Core Team\r\n\r\n- **Lead Developer/Architect**: MAUI & Android expertise\r\n- **ML/AI Engineer**: Speech recognition & LLM integration\r\n- **Game Designer**: Narrative and puzzle design\r\n- **UI/UX Designer**: Voice interface patterns\r\n- **QA Engineer**: Mobile testing expertise\r\n\r\n### Supporting Roles\r\n\r\n- Technical Writer (documentation)\r\n- Sound Designer (audio feedback)\r\n- Content Writer (story packs)\r\n\r\n## Next Steps\r\n\r\n1. Review and approve architecture documents (02-11)\r\n2. Set up development environment and project structure\r\n3. Implement proof-of-concept for voice pipeline\r\n4. Design and validate data models\r\n5. Create first MVP iteration\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Status**: Draft for Review\r\n\n</file_content>\n\n<file_content path=\"docs/02-system-architecture.md\">\n# 02 - System Architecture\r\n\r\n## High-Level Architecture\r\n\r\nThe Cabin follows a layered architecture pattern optimized for .NET MAUI mobile applications, emphasizing separation of concerns, testability, and maintainability.\r\n\r\n```text\r\n┌─────────────────────────────────────────────────────────────┐\r\n│                    PRESENTATION LAYER                       │\r\n│  ┌────────────┐  ┌────────────┐  ┌────────────────────┐     │\r\n│  │   Views    │  │ ViewModels │  │  Value Converters  │     │\r\n│  │  (XAML/C#) │◄─┤   (MVVM)   │  │    Behaviors       │     │\r\n│  └────────────┘  └────────────┘  └────────────────────┘     │\r\n└─────────────────────────────────────────────────────────────┘\r\n                            │\r\n                            ▼\r\n┌─────────────────────────────────────────────────────────────┐\r\n│                   APPLICATION LAYER                         │\r\n│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐    │\r\n│  │   Services   │  │ Orchestrators│  │   State Mgmt    │    │\r\n│  │ (Business    │  │  (Game Flow) │  │   (Game State)  │    │\r\n│  │  Logic)      │  └──────────────┘  └─────────────────┘    │\r\n│  └──────────────┘                                           │\r\n└─────────────────────────────────────────────────────────────┘\r\n                            │\r\n                            ▼\r\n┌─────────────────────────────────────────────────────────────┐\r\n│                     DOMAIN LAYER                            │\r\n│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐    │\r\n│  │ Game Engine  │  │ Command      │  │  Story Pack     │    │\r\n│  │ (Core Logic) │  │ Processor    │  │  Loader         │    │\r\n│  └──────────────┘  └──────────────┘  └─────────────────┘    │\r\n└─────────────────────────────────────────────────────────────┘\r\n                            │\r\n                            ▼\r\n┌─────────────────────────────────────────────────────────────┐\r\n│                 INFRASTRUCTURE LAYER                        │\r\n│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐    │\r\n│  │Voice Services│  │ Data Access  │  │  External APIs  │    │\r\n│  │ (STT/TTS)    │  │ (Repository) │  │  (LLM)          │    │\r\n│  └──────────────┘  └──────────────┘  └─────────────────┘    │\r\n└─────────────────────────────────────────────────────────────┘\r\n                            │\r\n                            ▼\r\n┌─────────────────────────────────────────────────────────────┐\r\n│                    PLATFORM LAYER                           │\r\n│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐    │\r\n│  │Android APIs  │  │  File System │  │   Database      │    │\r\n│  │(Native)      │  │   Storage    │  │   (SQLite)      │    │\r\n│  └──────────────┘  └──────────────┘  └─────────────────┘    │\r\n└─────────────────────────────────────────────────────────────┘\r\n```\r\n\r\n## Core Components\r\n\r\n### 1. Presentation Layer\r\n\r\n#### Views (XAML + Code-Behind)\r\n\r\n- **MainPage**: Primary game interface\r\n- **InventoryPage**: Item management\r\n- **SettingsPage**: Configuration options\r\n- **StoryPackSelectorPage**: Theme selection\r\n- **LoadGamePage**: Save game management\r\n\r\n#### ViewModels (MVVM Pattern)\r\n\r\n- **MainViewModel**: Orchestrates game flow and UI state\r\n- **InventoryViewModel**: Manages inventory display\r\n- **SettingsViewModel**: Configuration management\r\n- **StoryPackViewModel**: Theme selection logic\r\n\r\n#### UI Components\r\n\r\n- **VoiceControlPanel**: Microphone button, waveform animation\r\n- **NarrativeTextView**: Story text display with scrolling\r\n- **StatsBar**: Health, light level, time indicators\r\n- **TranscriptPreview**: Real-time speech recognition feedback\r\n\r\n### 2. Application Layer\r\n\r\n#### Services\r\n\r\n```csharp\r\n// Service interfaces\r\npublic interface IVoiceRecognitionService\r\npublic interface ITextToSpeechService\r\npublic interface ICommandParserService\r\npublic interface IGameStateService\r\npublic interface IStoryPackService\r\npublic interface ISettingsService\r\n```\r\n\r\n#### Orchestrators\r\n\r\n- **GameFlowOrchestrator**: Coordinates voice → parse → execute → respond cycle\r\n- **SaveGameOrchestrator**: Manages game state persistence\r\n- **ThemeOrchestrator**: Handles theme switching\r\n\r\n### 3. Domain Layer\r\n\r\n#### Game Engine\r\n\r\n- **GameStateMachine**: Core state management and room transitions\r\n- **ActionExecutor**: Processes validated commands\r\n- **PuzzleEngine**: Handles puzzle logic and state\r\n- **InventoryManager**: Item collection and usage\r\n\r\n#### Command Processing\r\n\r\n- **CommandParser**: Converts parsed JSON to domain commands\r\n- **CommandValidator**: Validates commands against game state\r\n- **ContextManager**: Maintains conversation history\r\n\r\n#### Models (See Document 04 for details)\r\n\r\n- Room, Object, Player, Inventory, Command structures\r\n\r\n### 4. Infrastructure Layer\r\n\r\n#### Voice Services\r\n\r\n- **AndroidSpeechRecognizer**: Platform-specific STT\r\n- **WhisperService**: Offline speech recognition (optional)\r\n- **TtsService**: Text-to-speech implementation\r\n- **AudioManager**: Audio resource management\r\n\r\n#### Data Access\r\n\r\n- **StoryPackRepository**: Loads theme JSON files\r\n- **GameStateRepository**: Saves/loads game progress\r\n- **CacheRepository**: Stores parsed command cache\r\n\r\n#### External Services\r\n\r\n- **LlmApiClient**: OpenAI/Azure OpenAI integration\r\n- **LocalParserService**: Fallback rule-based parser\r\n\r\n### 5. Platform Layer (Android-Specific)\r\n\r\n#### Android Services\r\n\r\n- Permission management (RECORD_AUDIO, etc.)\r\n- Background service support\r\n- Notification handling\r\n- Battery optimization handling\r\n\r\n## Data Flow Diagrams\r\n\r\n### Primary Game Loop Flow\r\n\r\n```text\r\n┌─────────────┐\r\n│   Player    │\r\n│   Speaks    │\r\n└──────┬──────┘\r\n       │\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  VoiceRecognitionService            │\r\n│  - Activates microphone             │\r\n│  - Records audio                    │\r\n│  - Calls Android SpeechRecognizer   │\r\n└──────┬──────────────────────────────┘\r\n       │ (Audio → Text)\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  TranscriptPreview (UI Update)      │\r\n│  \"You said: take the lantern\"       │\r\n└──────┬──────────────────────────────┘\r\n       │\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  CommandParserService               │\r\n│  - Checks cache first               │\r\n│  - Falls back to LLM API            │\r\n│  - Returns structured JSON          │\r\n└──────┬──────────────────────────────┘\r\n       │ (Text → Command)\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  GameStateMachine                   │\r\n│  - Validates command                │\r\n│  - Checks game state                │\r\n│  - Executes action                  │\r\n│  - Updates state                    │\r\n└──────┬──────────────────────────────┘\r\n       │ (Command → Result)\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  NarrativeTextView (UI Update)      │\r\n│  \"You pick up the dusty lantern\"    │\r\n└──────┬──────────────────────────────┘\r\n       │\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  TextToSpeechService (Optional)     │\r\n│  - Synthesizes narration            │\r\n│  - Plays audio                      │\r\n└─────────────────────────────────────┘\r\n```\r\n\r\n### Command Parsing Flow\r\n\r\n```text\r\nRaw Text Input: \"Pick up the lantern on the table\"\r\n       │\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  Cache Check                        │\r\n│  Key: hash(text + context)          │\r\n└──────┬──────────────────────────────┘\r\n       │\r\n       ├─ Cache Hit ─────────┐\r\n       │                     │\r\n       ├─ Cache Miss         │\r\n       │      ▼              │\r\n       │  ┌────────────┐     │\r\n       │  │ LLM API    │     │\r\n       │  │ Call       │     │\r\n       │  └─────┬──────┘     │\r\n       │        │            │\r\n       ▼        ▼            ▼\r\n┌─────────────────────────────────────┐\r\n│  Parsed Command JSON                │\r\n│  {                                  │\r\n│    \"verb\": \"take\",                  │\r\n│    \"object\": \"lantern\",             │\r\n│    \"context\": \"table\",              │\r\n│    \"confidence\": 0.95               │\r\n│  }                                  │\r\n└──────┬──────────────────────────────┘\r\n       │\r\n       ▼\r\n┌─────────────────────────────────────┐\r\n│  Command Validator                  │\r\n│  - Object exists in current room?   │\r\n│  - Action allowed in current state? │\r\n│  - Required items in inventory?     │\r\n└──────┬──────────────────────────────┘\r\n       │\r\n       ├─ Valid ──────────────┐\r\n       │                      │\r\n       ├─ Invalid             │\r\n       │      ▼               │\r\n       │  ┌────────────┐      │\r\n       │  │ Error      │      │\r\n       │  │ Response   │      │\r\n       │  └────────────┘      │\r\n       │                      │\r\n       ▼                      ▼\r\n┌─────────────────────────────────────┐\r\n│  ActionExecutor                     │\r\n│  - Execute game logic               │\r\n│  - Update game state                │\r\n│  - Generate response text           │\r\n└─────────────────────────────────────┘\r\n```\r\n\r\n## MVVM Pattern Implementation\r\n\r\n### ViewModel Structure\r\n\r\n```csharp\r\npublic class MainViewModel : BaseViewModel\r\n{\r\n    // Services (injected)\r\n    private readonly IVoiceRecognitionService _voiceService;\r\n    private readonly ICommandParserService _parserService;\r\n    private readonly IGameStateService _gameStateService;\r\n    private readonly ITextToSpeechService _ttsService;\r\n    \r\n    // Observable Properties\r\n    public ObservableCollection<NarrativeEntry> StoryFeed { get; }\r\n    public string CurrentLocation { get; set; }\r\n    public int PlayerHealth { get; set; }\r\n    public string LightLevel { get; set; }\r\n    public string TranscriptText { get; set; }\r\n    public bool IsListening { get; set; }\r\n    public bool IsProcessing { get; set; }\r\n    \r\n    // Commands (ICommand)\r\n    public ICommand StartListeningCommand { get; }\r\n    public ICommand StopListeningCommand { get; }\r\n    public ICommand ShowInventoryCommand { get; }\r\n    public ICommand SaveGameCommand { get; }\r\n    \r\n    // Methods\r\n    public async Task ProcessVoiceCommandAsync();\r\n    private async Task ExecuteGameCommandAsync(ParsedCommand cmd);\r\n    private void UpdateUIState();\r\n}\r\n```\r\n\r\n### Dependency Injection Setup\r\n\r\n```csharp\r\n// MauiProgram.cs\r\npublic static class MauiProgram\r\n{\r\n    public static MauiApp CreateMauiApp()\r\n    {\r\n        var builder = MauiApp.CreateBuilder();\r\n        \r\n        builder\r\n            .UseMauiApp<App>()\r\n            .ConfigureFonts(fonts => { /* ... */ });\r\n        \r\n        // Register Services\r\n        builder.Services.AddSingleton<IVoiceRecognitionService, AndroidSpeechRecognizer>();\r\n        builder.Services.AddSingleton<ITextToSpeechService, MauiTtsService>();\r\n        builder.Services.AddSingleton<ICommandParserService, LlmCommandParser>();\r\n        builder.Services.AddSingleton<IGameStateService, GameStateService>();\r\n        builder.Services.AddSingleton<IStoryPackService, StoryPackService>();\r\n        \r\n        // Register ViewModels\r\n        builder.Services.AddTransient<MainViewModel>();\r\n        builder.Services.AddTransient<InventoryViewModel>();\r\n        builder.Services.AddTransient<SettingsViewModel>();\r\n        \r\n        // Register Views\r\n        builder.Services.AddTransient<MainPage>();\r\n        builder.Services.AddTransient<InventoryPage>();\r\n        builder.Services.AddTransient<SettingsPage>();\r\n        \r\n        return builder.Build();\r\n    }\r\n}\r\n```\r\n\r\n## State Management\r\n\r\n### Game State Hierarchy\r\n\r\n```text\r\nGameState (Root)\r\n├── PlayerState\r\n│   ├── CurrentLocation\r\n│   ├── Health\r\n│   ├── Inventory[]\r\n│   └── StatusEffects[]\r\n├── WorldState\r\n│   ├── CurrentTheme\r\n│   ├── Rooms[]\r\n│   │   ├── RoomState\r\n│   │   └── Objects[]\r\n│   └── GlobalVariables{}\r\n├── ProgressState\r\n│   ├── CompletedPuzzles[]\r\n│   ├── UnlockedAreas[]\r\n│   └── StoryFlags{}\r\n└── MetaState\r\n    ├── PlayTime\r\n    ├── SaveTimestamp\r\n    └── Version\r\n```\r\n\r\n### State Persistence Strategy\r\n\r\n1. **In-Memory State**: Active game state held in `GameStateService`\r\n2. **Auto-Save**: State persisted every significant action\r\n3. **Manual Save**: Player-triggered save to named slots\r\n4. **Checkpoint System**: Automatic checkpoints at major story points\r\n\r\n## Communication Patterns\r\n\r\n### Event Aggregator Pattern\r\n\r\n```csharp\r\npublic interface IEventAggregator\r\n{\r\n    void Subscribe<T>(Action<T> handler);\r\n    void Publish<T>(T eventData);\r\n}\r\n\r\n// Events\r\npublic class GameStateChangedEvent { }\r\npublic class InventoryUpdatedEvent { }\r\npublic class LocationChangedEvent { }\r\npublic class CommandProcessedEvent { }\r\n```\r\n\r\n### Message Flow\r\n\r\n```text\r\nView → ViewModel → Service → Domain → Repository\r\n  ↑                                        ↓\r\n  └──────── Events/Notifications ──────────┘\r\n```\r\n\r\n## Error Handling Strategy\r\n\r\n### Layered Error Handling\r\n\r\n1. **UI Layer**: User-friendly error messages\r\n2. **Service Layer**: Retry logic and fallbacks\r\n3. **Domain Layer**: Business rule validation\r\n4. **Infrastructure Layer**: Exception logging\r\n\r\n### Specific Strategies\r\n\r\n```csharp\r\n// Voice Recognition Errors\r\ntry\r\n{\r\n    var result = await _voiceService.RecognizeSpeechAsync();\r\n}\r\ncatch (PermissionException ex)\r\n{\r\n    // Prompt user for microphone permission\r\n}\r\ncatch (SpeechRecognitionException ex)\r\n{\r\n    // Show \"Didn't catch that, please try again\"\r\n}\r\n\r\n// LLM API Errors\r\ntry\r\n{\r\n    var parsed = await _llmService.ParseCommandAsync(text);\r\n}\r\ncatch (ApiException ex)\r\n{\r\n    // Fall back to local parser\r\n    var parsed = await _localParser.ParseCommandAsync(text);\r\n}\r\ncatch (NetworkException ex)\r\n{\r\n    // Queue command for retry or offer offline mode\r\n}\r\n```\r\n\r\n## Performance Considerations\r\n\r\n### Optimization Strategies\r\n\r\n1. **Lazy Loading**: Load story packs on demand\r\n2. **Object Pooling**: Reuse audio buffers and UI elements\r\n3. **Async/Await**: Non-blocking operations for all I/O\r\n4. **Caching**: Command cache, TTS audio cache, image cache\r\n5. **Virtual Scrolling**: For long story text feeds\r\n6. **Background Processing**: Parse commands off UI thread\r\n\r\n### Memory Management\r\n\r\n- Dispose audio resources properly\r\n- Clear old story text beyond certain threshold\r\n- Unload unused theme assets\r\n- Monitor memory pressure events\r\n\r\n## Security Considerations\r\n\r\n### Data Protection\r\n\r\n1. **API Keys**: Stored in secure storage, never in code\r\n2. **Permissions**: Runtime permission requests\r\n3. **Network Security**: HTTPS only for API calls\r\n4. **Data Encryption**: Encrypt save files (optional)\r\n\r\n### Privacy\r\n\r\n- Voice data processed locally or transmitted securely\r\n- No persistent audio recording storage\r\n- Clear privacy policy for any telemetry\r\n\r\n## Testing Architecture\r\n\r\n### Test Pyramid\r\n\r\n```text\r\n        ┌───────────┐\r\n        │    E2E    │  (10%)\r\n        ├───────────┤\r\n        │Integration│  (20%)\r\n        ├───────────┤\r\n        │   Unit    │  (70%)\r\n        └───────────┘\r\n```\r\n\r\n### Test Strategy\r\n\r\n1. **Unit Tests**: Services, ViewModels, Domain Logic\r\n2. **Integration Tests**: Service interactions, Data access\r\n3. **UI Tests**: Critical user flows\r\n4. **Manual Tests**: Voice recognition accuracy, Device compatibility\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 03-technical-stack.md, 04-data-models.md, 08-maui-implementation.md\r\n\n</file_content>\n\n<file_content path=\"docs/03-technical-stack.md\">\n# 03 - Technical Stack\r\n\r\n## Overview\r\n\r\nThis document details the complete technology stack for The Cabin, including frameworks, libraries, tools, and platform-specific components required for Android development using .NET MAUI.\r\n\r\n## Core Framework\r\n\r\n### .NET MAUI (Multi-platform App UI)\r\n\r\n**Version**: .NET 8.0 or higher  \r\n**Target Frameworks**: `net8.0-android`\r\n\r\n**Key Features Utilized**:\r\n\r\n- Single project structure\r\n- XAML-based UI with C# code-behind\r\n- Platform-specific code via conditional compilation\r\n- Hot reload for rapid development\r\n- Native Android API access via bindings\r\n\r\n**MAUI Advantages**:\r\n\r\n- Unified codebase with platform customization\r\n- Native performance\r\n- Direct Android API access\r\n- Extensive community and Microsoft support\r\n- Familiar C# development experience\r\n\r\n## Development Environment\r\n\r\n### Required Tools\r\n\r\n| Tool | Version | Purpose |\r\n|------|---------|---------|\r\n| Visual Studio 2022 | 17.8+ | Primary IDE |\r\n| .NET SDK | 8.0+ | Runtime and libraries |\r\n| Android SDK | API 23-34 | Android development |\r\n| Android Emulator | Latest | Testing |\r\n| Git | 2.40+ | Version control |\r\n\r\n### Optional Tools\r\n\r\n| Tool | Purpose |\r\n|------|---------|\r\n| Visual Studio Code | Alternative editor |\r\n| Android Studio | Advanced Android debugging |\r\n| Postman | API testing |\r\n| DB Browser for SQLite | Database inspection |\r\n\r\n### Build Configuration\r\n\r\n```xml\r\n<!-- .csproj settings -->\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n  <PropertyGroup>\r\n    <TargetFrameworks>net8.0-android</TargetFrameworks>\r\n    <OutputType>Exe</OutputType>\r\n    <RootNamespace>TheCabin</RootNamespace>\r\n    <UseMaui>true</UseMaui>\r\n    <SingleProject>true</SingleProject>\r\n    \r\n    <!-- Android specific -->\r\n    <SupportedOSPlatformVersion Condition=\"$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'android'\">23.0</SupportedOSPlatformVersion>\r\n    <AndroidEnableProfiledAot>true</AndroidEnableProfiledAot>\r\n    <AndroidPackageFormat>apk</AndroidPackageFormat>\r\n    \r\n    <!-- App info -->\r\n    <ApplicationTitle>The Cabin</ApplicationTitle>\r\n    <ApplicationId>com.thecabin.voiceadventure</ApplicationId>\r\n    <ApplicationDisplayVersion>1.0</ApplicationDisplayVersion>\r\n    <ApplicationVersion>1</ApplicationVersion>\r\n  </PropertyGroup>\r\n</Project>\r\n```\r\n\r\n## NuGet Packages\r\n\r\n### Core MAUI Packages\r\n\r\n```xml\r\n<!-- Included by default with MAUI -->\r\n<PackageReference Include=\"Microsoft.Maui.Controls\" Version=\"8.0.0\" />\r\n<PackageReference Include=\"Microsoft.Maui.Controls.Compatibility\" Version=\"8.0.0\" />\r\n<PackageReference Include=\"Microsoft.Extensions.Logging.Debug\" Version=\"8.0.0\" />\r\n```\r\n\r\n### Speech Recognition\r\n\r\n#### Option 1: Android SpeechRecognizer (Built-in)\r\n\r\n```csharp\r\n// Platform API - No package required\r\n// Use: Android.Speech.SpeechRecognizer\r\n```\r\n\r\n#### Option 2: Whisper.NET (Offline Alternative)\r\n\r\n```xml\r\n<PackageReference Include=\"Whisper.net\" Version=\"1.5.0\" />\r\n<PackageReference Include=\"Whisper.net.Runtime\" Version=\"1.5.0\" />\r\n```\r\n\r\n**Whisper Model Options**:\r\n\r\n- `tiny`: 75 MB, fastest, lower accuracy\r\n- `base`: 142 MB, good balance\r\n- `small`: 466 MB, better accuracy\r\n- Recommended: **base** model for mobile\r\n\r\n### Text-to-Speech\r\n\r\n#### MAUI Built-in TTS\r\n\r\n```csharp\r\n// Platform API included with MAUI\r\n// Use: Microsoft.Maui.Media.TextToSpeech\r\n```\r\n\r\n#### Alternative: Azure Cognitive Services TTS\r\n\r\n```xml\r\n<PackageReference Include=\"Microsoft.CognitiveServices.Speech\" Version=\"1.34.0\" />\r\n```\r\n\r\n### LLM Integration\r\n\r\n#### OpenAI API Client\r\n\r\n```xml\r\n<PackageReference Include=\"Azure.AI.OpenAI\" Version=\"1.0.0-beta.12\" />\r\n```\r\n\r\n**Alternative**:\r\n\r\n```xml\r\n<PackageReference Include=\"OpenAI\" Version=\"1.10.0\" />\r\n```\r\n\r\n#### HTTP Client Extensions\r\n\r\n```xml\r\n<PackageReference Include=\"Microsoft.Extensions.Http\" Version=\"8.0.0\" />\r\n<PackageReference Include=\"Microsoft.Extensions.Http.Polly\" Version=\"8.0.0\" />\r\n```\r\n\r\n### Data Storage\r\n\r\n#### SQLite (Recommended)\r\n\r\n```xml\r\n<PackageReference Include=\"sqlite-net-pcl\" Version=\"1.8.116\" />\r\n<PackageReference Include=\"SQLitePCLRaw.bundle_green\" Version=\"2.1.7\" />\r\n```\r\n\r\n#### JSON Serialization\r\n\r\n```xml\r\n<PackageReference Include=\"System.Text.Json\" Version=\"8.0.0\" />\r\n<!-- or -->\r\n<PackageReference Include=\"Newtonsoft.Json\" Version=\"13.0.3\" />\r\n```\r\n\r\n### MVVM Framework\r\n\r\n#### CommunityToolkit.Mvvm (Recommended)\r\n\r\n```xml\r\n<PackageReference Include=\"CommunityToolkit.Mvvm\" Version=\"8.2.2\" />\r\n```\r\n\r\n**Features**:\r\n\r\n- Source generators for MVVM boilerplate\r\n- `ObservableProperty` attribute\r\n- `RelayCommand` attribute\r\n- Messenger for loosely coupled communication\r\n\r\n#### Alternative: ReactiveUI\r\n\r\n```xml\r\n<PackageReference Include=\"ReactiveUI.Maui\" Version=\"19.5.31\" />\r\n```\r\n\r\n### UI Enhancements\r\n\r\n```xml\r\n<!-- Additional UI controls -->\r\n<PackageReference Include=\"CommunityToolkit.Maui\" Version=\"7.0.0\" />\r\n\r\n<!-- Animations -->\r\n<PackageReference Include=\"Microsoft.Maui.Graphics\" Version=\"8.0.0\" />\r\n\r\n<!-- Icons -->\r\n<PackageReference Include=\"Plugin.Maui.Audio\" Version=\"2.0.0\" />\r\n```\r\n\r\n### Utilities\r\n\r\n```xml\r\n<!-- Dependency Injection -->\r\n<PackageReference Include=\"Microsoft.Extensions.DependencyInjection\" Version=\"8.0.0\" />\r\n\r\n<!-- Configuration -->\r\n<PackageReference Include=\"Microsoft.Extensions.Configuration.Json\" Version=\"8.0.0\" />\r\n\r\n<!-- Logging -->\r\n<PackageReference Include=\"Serilog.Extensions.Logging\" Version=\"8.0.0\" />\r\n<PackageReference Include=\"Serilog.Sinks.File\" Version=\"5.0.0\" />\r\n\r\n<!-- Caching -->\r\n<PackageReference Include=\"Microsoft.Extensions.Caching.Memory\" Version=\"8.0.0\" />\r\n\r\n<!-- Polly (Resilience) -->\r\n<PackageReference Include=\"Polly\" Version=\"8.2.0\" />\r\n```\r\n\r\n## Speech-to-Text Options\r\n\r\n### Option 1: Android SpeechRecognizer (Default)\r\n\r\n**Pros**:\r\n\r\n- Built into Android platform\r\n- No additional dependencies\r\n- Low memory footprint\r\n- Regular updates from Google\r\n- Supports multiple languages\r\n\r\n**Cons**:\r\n\r\n- Requires internet connection for best accuracy\r\n- Limited customization\r\n- Privacy concerns (data sent to Google)\r\n\r\n**Implementation**:\r\n\r\n```csharp\r\nusing Android.Speech;\r\nusing Android.Content;\r\n\r\npublic class AndroidSpeechRecognizer : IVoiceRecognitionService\r\n{\r\n    private SpeechRecognizer _recognizer;\r\n    private Intent _recognizerIntent;\r\n    \r\n    public async Task<string> RecognizeSpeechAsync()\r\n    {\r\n        _recognizerIntent = new Intent(RecognizerIntent.ActionRecognizeSpeech);\r\n        _recognizerIntent.PutExtra(RecognizerIntent.ExtraLanguageModel, \r\n            RecognizerIntent.LanguageModelFreeForm);\r\n        _recognizerIntent.PutExtra(RecognizerIntent.ExtraCallingPackage, \r\n            Package);\r\n        _recognizerIntent.PutExtra(RecognizerIntent.ExtraMaxResults, 1);\r\n        \r\n        _recognizer.StartListening(_recognizerIntent);\r\n        // Return recognized text\r\n    }\r\n}\r\n```\r\n\r\n### Option 2: Whisper.NET (Offline)\r\n\r\n**Pros**:\r\n\r\n- Fully offline functionality\r\n- High accuracy\r\n- Privacy-focused (on-device)\r\n- Multiple model sizes\r\n- Open source\r\n\r\n**Cons**:\r\n\r\n- Large model files (75-466 MB)\r\n- Higher CPU/battery usage\r\n- Slower than cloud solutions\r\n- Requires model download/bundling\r\n\r\n**Implementation**:\r\n\r\n```csharp\r\nusing Whisper.net;\r\n\r\npublic class WhisperRecognitionService : IVoiceRecognitionService\r\n{\r\n    private WhisperFactory _factory;\r\n    private WhisperProcessor _processor;\r\n    \r\n    public async Task InitializeAsync()\r\n    {\r\n        var modelPath = Path.Combine(FileSystem.AppDataDirectory, \r\n            \"ggml-base.bin\");\r\n        _factory = WhisperFactory.FromPath(modelPath);\r\n        _processor = _factory.CreateBuilder().Build();\r\n    }\r\n    \r\n    public async Task<string> RecognizeSpeechAsync(string audioFile)\r\n    {\r\n        await foreach (var result in _processor.ProcessAsync(audioFile))\r\n        {\r\n            return result.Text;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### Option 3: Azure Cognitive Services\r\n\r\n**Pros**:\r\n\r\n- Excellent accuracy\r\n- Real-time streaming\r\n- Custom models available\r\n- Extensive language support\r\n\r\n**Cons**:\r\n\r\n- Requires internet\r\n- Usage costs\r\n- Additional SDK size\r\n- Azure account needed\r\n\r\n**Cost Estimate**: ~$1 per hour of audio (Standard tier)\r\n\r\n## LLM Integration Options\r\n\r\n### Option 1: OpenAI GPT-4o-mini (Recommended)\r\n\r\n**API Endpoint**: `https://api.openai.com/v1/chat/completions`\r\n\r\n**Model**: `gpt-4o-mini`\r\n\r\n**Pricing**:\r\n\r\n- Input: $0.150 per 1M tokens\r\n- Output: $0.600 per 1M tokens\r\n- Est. cost per command: $0.0001-0.0003\r\n\r\n**Estimated Monthly Cost** (1000 active users):\r\n\r\n- Avg. 50 commands/user/month = 50,000 commands\r\n- Cost: ~$5-15/month\r\n\r\n**Implementation**:\r\n\r\n```csharp\r\nusing Azure.AI.OpenAI;\r\n\r\npublic class OpenAICommandParser : ICommandParserService\r\n{\r\n    private readonly OpenAIClient _client;\r\n    \r\n    public async Task<ParsedCommand> ParseAsync(string input, string context)\r\n    {\r\n        var messages = new[]\r\n        {\r\n            new ChatRequestSystemMessage(\r\n                \"Parse player commands into JSON: {verb, object, context}\"),\r\n            new ChatRequestUserMessage($\"Context: {context}\\nCommand: {input}\")\r\n        };\r\n        \r\n        var response = await _client.GetChatCompletionsAsync(\r\n            new ChatCompletionsOptions(\"gpt-4o-mini\", messages)\r\n            {\r\n                Temperature = 0.3f,\r\n                MaxTokens = 100\r\n            });\r\n        \r\n        return JsonSerializer.Deserialize<ParsedCommand>(\r\n            response.Value.Choices[0].Message.Content);\r\n    }\r\n}\r\n```\r\n\r\n### Option 2: Azure OpenAI Service\r\n\r\n**Benefits**:\r\n\r\n- Enterprise features\r\n- Data residency control\r\n- Private endpoint support\r\n- SLA guarantees\r\n\r\n**Pricing**: Similar to OpenAI, with added Azure fees\r\n\r\n### Option 3: Local LLM (Phi-3, Llama)\r\n\r\n**Options**:\r\n\r\n- Phi-3 Mini (3.8B parameters, ~2GB)\r\n- Llama 3.2 (3B parameters, ~2GB)\r\n\r\n**Implementation** (using LLamaSharp):\r\n\r\n```xml\r\n<PackageReference Include=\"LLamaSharp\" Version=\"0.10.0\" />\r\n<PackageReference Include=\"LLamaSharp.Backend.Cpu\" Version=\"0.10.0\" />\r\n```\r\n\r\n**Pros**:\r\n\r\n- No API costs\r\n- Full offline support\r\n- Privacy\r\n\r\n**Cons**:\r\n\r\n- Large app size (2-4GB)\r\n- High memory usage\r\n- Slower inference\r\n- Battery drain\r\n\r\n### Option 4: Hybrid Approach (Recommended)\r\n\r\n```csharp\r\npublic class HybridCommandParser : ICommandParserService\r\n{\r\n    private readonly ILocalCommandParser _localParser;\r\n    private readonly ILlmApiClient _cloudParser;\r\n    private readonly IConnectivity _connectivity;\r\n    \r\n    public async Task<ParsedCommand> ParseAsync(string input, string context)\r\n    {\r\n        // Try cached result first\r\n        if (TryGetCached(input, out var cached))\r\n            return cached;\r\n        \r\n        // Check for simple/common commands\r\n        if (_localParser.CanHandle(input))\r\n            return await _localParser.ParseAsync(input, context);\r\n        \r\n        // Use cloud LLM for complex commands\r\n        if (_connectivity.NetworkAccess == NetworkAccess.Internet)\r\n        {\r\n            try\r\n            {\r\n                return await _cloudParser.ParseAsync(input, context);\r\n            }\r\n            catch\r\n            {\r\n                // Fallback to local\r\n                return await _localParser.ParseAsync(input, context);\r\n            }\r\n        }\r\n        \r\n        // Offline fallback\r\n        return await _localParser.ParseAsync(input, context);\r\n    }\r\n}\r\n```\r\n\r\n## Text-to-Speech Options\r\n\r\n### Option 1: MAUI TextToSpeech (Default)\r\n\r\n**Implementation**:\r\n\r\n```csharp\r\nusing Microsoft.Maui.Media;\r\n\r\npublic class MauiTtsService : ITextToSpeechService\r\n{\r\n    public async Task SpeakAsync(string text)\r\n    {\r\n        var locales = await TextToSpeech.Default.GetLocalesAsync();\r\n        var settings = new SpeechOptions\r\n        {\r\n            Pitch = 1.0f,\r\n            Volume = 1.0f,\r\n            Locale = locales.FirstOrDefault()\r\n        };\r\n        \r\n        await TextToSpeech.Default.SpeakAsync(text, settings);\r\n    }\r\n}\r\n```\r\n\r\n**Pros**:\r\n\r\n- Built-in, no extra packages\r\n- Works offline\r\n- Low battery usage\r\n\r\n**Cons**:\r\n\r\n- Robotic voice quality\r\n- Limited voice options\r\n- No emotion/expression\r\n\r\n### Option 2: Azure Cognitive Services TTS\r\n\r\n**Best Voices**: Neural TTS with SSML support\r\n\r\n**Implementation**:\r\n\r\n```csharp\r\nusing Microsoft.CognitiveServices.Speech;\r\n\r\npublic class AzureTtsService : ITextToSpeechService\r\n{\r\n    private SpeechSynthesizer _synthesizer;\r\n    \r\n    public async Task SpeakAsync(string text)\r\n    {\r\n        var ssml = $@\"\r\n            <speak version='1.0' xml:lang='en-US'>\r\n                <voice name='en-US-JennyNeural'>\r\n                    <prosody rate='0.9' pitch='0%'>\r\n                        {text}\r\n                    </prosody>\r\n                </voice>\r\n            </speak>\";\r\n        \r\n        await _synthesizer.SpeakSsmlAsync(ssml);\r\n    }\r\n}\r\n```\r\n\r\n**Pricing**: $16 per 1M characters (Neural voices)\r\n\r\n### Option 3: ElevenLabs (Premium)\r\n\r\n**Pros**:\r\n\r\n- Most realistic voices\r\n- Emotion control\r\n- Voice cloning\r\n\r\n**Cons**:\r\n\r\n- Expensive ($5-330/month)\r\n- Requires internet\r\n- Latency\r\n\r\n## Database Options\r\n\r\n### SQLite - Recommended\r\n\r\n**Why SQLite**:\r\n\r\n- Embedded database\r\n- No server required\r\n- Small footprint (~1MB)\r\n- ACID compliant\r\n- Wide platform support\r\n\r\n**Schema Example**:\r\n\r\n```sql\r\n-- Game saves\r\nCREATE TABLE GameSaves (\r\n    Id INTEGER PRIMARY KEY,\r\n    Name TEXT NOT NULL,\r\n    ThemeId TEXT NOT NULL,\r\n    GameStateJson TEXT NOT NULL,\r\n    Timestamp INTEGER NOT NULL\r\n);\r\n\r\n-- Command cache\r\nCREATE TABLE CommandCache (\r\n    CommandHash TEXT PRIMARY KEY,\r\n    ContextHash TEXT NOT NULL,\r\n    ParsedJson TEXT NOT NULL,\r\n    Confidence REAL,\r\n    Timestamp INTEGER\r\n);\r\n\r\n-- Settings\r\nCREATE TABLE Settings (\r\n    Key TEXT PRIMARY KEY,\r\n    Value TEXT NOT NULL\r\n);\r\n```\r\n\r\n### Alternative: LiteDB\r\n\r\n```xml\r\n<PackageReference Include=\"LiteDB\" Version=\"5.0.17\" />\r\n```\r\n\r\n**Pros**:\r\n\r\n- NoSQL document database\r\n- No SQL required\r\n- Simple API\r\n- Good for JSON storage\r\n\r\n## Android Permissions\r\n\r\n### Required Permissions\r\n\r\n```xml\r\n<!-- AndroidManifest.xml -->\r\n<uses-permission android:name=\"android.permission.INTERNET\" />\r\n<uses-permission android:name=\"android.permission.RECORD_AUDIO\" />\r\n<uses-permission android:name=\"android.permission.MODIFY_AUDIO_SETTINGS\" />\r\n<uses-permission android:name=\"android.permission.WAKE_LOCK\" />\r\n\r\n<!-- Optional -->\r\n<uses-permission android:name=\"android.permission.VIBRATE\" />\r\n```\r\n\r\n### Runtime Permission Handling\r\n\r\n```csharp\r\npublic async Task<bool> RequestMicrophonePermissionAsync()\r\n{\r\n    var status = await Permissions.CheckStatusAsync<Permissions.Microphone>();\r\n    \r\n    if (status != PermissionStatus.Granted)\r\n    {\r\n        status = await Permissions.RequestAsync<Permissions.Microphone>();\r\n    }\r\n    \r\n    return status == PermissionStatus.Granted;\r\n}\r\n```\r\n\r\n## Build and Deployment\r\n\r\n### Android Build Configurations\r\n\r\n**Debug**:\r\n\r\n```xml\r\n<PropertyGroup Condition=\"'$(Configuration)' == 'Debug'\">\r\n    <AndroidEnableProfiledAot>false</AndroidEnableProfiledAot>\r\n    <AndroidLinkMode>None</AndroidLinkMode>\r\n    <DebugSymbols>true</DebugSymbols>\r\n</PropertyGroup>\r\n```\r\n\r\n**Release**:\r\n\r\n```xml\r\n<PropertyGroup Condition=\"'$(Configuration)' == 'Release'\">\r\n    <AndroidEnableProfiledAot>true</AndroidEnableProfiledAot>\r\n    <AndroidLinkMode>SdkOnly</AndroidLinkMode>\r\n    <AndroidUseAapt2>true</AndroidUseAapt2>\r\n    <AndroidCreatePackagePerAbi>false</AndroidCreatePackagePerAbi>\r\n    <EnableLLVM>false</EnableLLVM>\r\n</PropertyGroup>\r\n```\r\n\r\n### APK Size Optimization\r\n\r\n1. **Enable ProGuard/R8 shrinking**\r\n2. **Use APK splits for different architectures**\r\n3. **Compress assets**\r\n4. **Remove unused resources**\r\n5. **Use vector drawables instead of PNGs**\r\n\r\n**Target Size**: < 50 MB (without Whisper model)\r\n\r\n## Development Workflow\r\n\r\n### Recommended Git Workflow\r\n\r\n```bash\r\nmain (production)\r\n  ├─ develop (integration)\r\n  │   ├─ feature/voice-pipeline\r\n  │   ├─ feature/game-engine\r\n  │   └─ feature/ui-components\r\n  └─ hotfix/* (urgent fixes)\r\n```\r\n\r\n### CI/CD Considerations\r\n\r\n- GitHub Actions or Azure DevOps\r\n- Automated testing on every PR\r\n- APK builds on merge to develop\r\n- Release builds tagged in main\r\n\r\n## Performance Profiling Tools\r\n\r\n- Android Studio Profiler\r\n- Visual Studio Performance Profiler\r\n- dotTrace (JetBrains)\r\n- MAUI Blazor DevTools\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 02-system-architecture.md, 05-voice-pipeline.md, 08-maui-implementation.md\r\n\n</file_content>\n\n<file_content path=\"docs/04-data-models.md\">\n# 04 - Data Models\r\n\r\n## Overview\r\n\r\nThis document defines all data models, entities, and data transfer objects (DTOs) used throughout The Cabin application. Models are organized by layer and purpose.\r\n\r\n## Domain Models\r\n\r\n### Room Model\r\n\r\nRepresents a physical location in the game world.\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Models\r\n{\r\n    public class Room\r\n    {\r\n        public string Id { get; set; }\r\n        public string Description { get; set; }\r\n        public List<string> ObjectIds { get; set; }\r\n        public Dictionary<string, string> Exits { get; set; }\r\n        public RoomState State { get; set; }\r\n        public bool IsVisited { get; set; }\r\n        public string AmbientSound { get; set; }\r\n        public LightLevel LightLevel { get; set; }\r\n        \r\n        public Room()\r\n        {\r\n            ObjectIds = new List<string>();\r\n            Exits = new Dictionary<string, string>();\r\n            State = new RoomState();\r\n        }\r\n    }\r\n    \r\n    public class RoomState\r\n    {\r\n        public bool IsLocked { get; set; }\r\n        public Dictionary<string, bool> Flags { get; set; }\r\n        public List<string> VisibleObjectIds { get; set; }\r\n        \r\n        public RoomState()\r\n        {\r\n            Flags = new Dictionary<string, bool>();\r\n            VisibleObjectIds = new List<string>();\r\n        }\r\n    }\r\n    \r\n    public enum LightLevel\r\n    {\r\n        Bright,\r\n        Normal,\r\n        Dim,\r\n        Dark,\r\n        PitchBlack\r\n    }\r\n}\r\n```\r\n\r\n**JSON Schema**:\r\n\r\n```json\r\n{\r\n  \"id\": \"cabin_main\",\r\n  \"description\": \"You stand in a dimly lit wooden cabin...\",\r\n  \"objects\": [\"lantern\", \"door\", \"table\"],\r\n  \"exits\": {\r\n    \"north\": \"forest_edge\",\r\n    \"up\": \"cabin_loft\"\r\n  },\r\n  \"state\": {\r\n    \"isLocked\": false,\r\n    \"flags\": {\r\n      \"fire_lit\": false\r\n    },\r\n    \"visibleObjectIds\": [\"lantern\", \"door\"]\r\n  },\r\n  \"isVisited\": false,\r\n  \"ambientSound\": \"wind_howling.mp3\",\r\n  \"lightLevel\": \"Dim\"\r\n}\r\n```\r\n\r\n### Object Model\r\n\r\nRepresents interactive items in the game world.\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Models\r\n{\r\n    public class GameObject\r\n    {\r\n        public string Id { get; set; }\r\n        public string Name { get; set; }\r\n        public string Description { get; set; }\r\n        public ObjectType Type { get; set; }\r\n        public ObjectState State { get; set; }\r\n        public Dictionary<string, ActionDefinition> Actions { get; set; }\r\n        public List<string> RequiredItems { get; set; }\r\n        public bool IsCollectable { get; set; }\r\n        public bool IsVisible { get; set; }\r\n        public int Weight { get; set; }\r\n        \r\n        public GameObject()\r\n        {\r\n            Actions = new Dictionary<string, ActionDefinition>();\r\n            RequiredItems = new List<string>();\r\n            State = new ObjectState();\r\n        }\r\n    }\r\n    \r\n    public class ObjectState\r\n    {\r\n        public string CurrentState { get; set; }\r\n        public Dictionary<string, bool> Flags { get; set; }\r\n        public int UsageCount { get; set; }\r\n        \r\n        public ObjectState()\r\n        {\r\n            CurrentState = \"default\";\r\n            Flags = new Dictionary<string, bool>();\r\n            UsageCount = 0;\r\n        }\r\n    }\r\n    \r\n    public enum ObjectType\r\n    {\r\n        Item,\r\n        Tool,\r\n        Furniture,\r\n        Door,\r\n        Container,\r\n        Light,\r\n        Puzzle,\r\n        Decoration\r\n    }\r\n    \r\n    public class ActionDefinition\r\n    {\r\n        public string Verb { get; set; }\r\n        public string SuccessMessage { get; set; }\r\n        public string FailureMessage { get; set; }\r\n        public List<StateChange> StateChanges { get; set; }\r\n        public List<string> RequiredFlags { get; set; }\r\n        public bool ConsumesItem { get; set; }\r\n        \r\n        public ActionDefinition()\r\n        {\r\n            StateChanges = new List<StateChange>();\r\n            RequiredFlags = new List<string>();\r\n        }\r\n    }\r\n    \r\n    public class StateChange\r\n    {\r\n        public string Target { get; set; }  // \"self\", \"room\", or object ID\r\n        public string Property { get; set; }\r\n        public object NewValue { get; set; }\r\n    }\r\n}\r\n```\r\n\r\n**JSON Schema**:\r\n\r\n```json\r\n{\r\n  \"id\": \"lantern\",\r\n  \"name\": \"Rusty Lantern\",\r\n  \"description\": \"An old brass lantern covered in rust and cobwebs\",\r\n  \"type\": \"Light\",\r\n  \"state\": {\r\n    \"currentState\": \"unlit\",\r\n    \"flags\": {\r\n      \"has_oil\": true\r\n    },\r\n    \"usageCount\": 0\r\n  },\r\n  \"actions\": {\r\n    \"take\": {\r\n      \"verb\": \"take\",\r\n      \"successMessage\": \"You pick up the lantern. It feels heavy with oil.\",\r\n      \"failureMessage\": \"You can't take that.\",\r\n      \"stateChanges\": [\r\n        {\r\n          \"target\": \"self\",\r\n          \"property\": \"isVisible\",\r\n          \"newValue\": false\r\n        }\r\n      ],\r\n      \"requiredFlags\": [],\r\n      \"consumesItem\": false\r\n    },\r\n    \"light\": {\r\n      \"verb\": \"light\",\r\n      \"successMessage\": \"The lantern flickers to life, casting dancing shadows.\",\r\n      \"failureMessage\": \"You need something to light it with.\",\r\n      \"stateChanges\": [\r\n        {\r\n          \"target\": \"self\",\r\n          \"property\": \"currentState\",\r\n          \"newValue\": \"lit\"\r\n        },\r\n        {\r\n          \"target\": \"room\",\r\n          \"property\": \"lightLevel\",\r\n          \"newValue\": \"Bright\"\r\n        }\r\n      ],\r\n      \"requiredFlags\": [\"has_oil\"],\r\n      \"consumesItem\": false\r\n    }\r\n  },\r\n  \"requiredItems\": [],\r\n  \"isCollectable\": true,\r\n  \"isVisible\": true,\r\n  \"weight\": 3\r\n}\r\n```\r\n\r\n### Player Model\r\n\r\nRepresents the player's state and inventory.\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Models\r\n{\r\n    public class Player\r\n    {\r\n        public string Name { get; set; }\r\n        public string CurrentLocationId { get; set; }\r\n        public int Health { get; set; }\r\n        public int MaxHealth { get; set; }\r\n        public Inventory Inventory { get; set; }\r\n        public PlayerStats Stats { get; set; }\r\n        public List<StatusEffect> StatusEffects { get; set; }\r\n        public int CarryCapacity { get; set; }\r\n        \r\n        public Player()\r\n        {\r\n            Health = 100;\r\n            MaxHealth = 100;\r\n            CarryCapacity = 20;\r\n            Inventory = new Inventory();\r\n            Stats = new PlayerStats();\r\n            StatusEffects = new List<StatusEffect>();\r\n        }\r\n    }\r\n    \r\n    public class Inventory\r\n    {\r\n        public List<GameObject> Items { get; set; }\r\n        public int TotalWeight { get; set; }\r\n        public int MaxCapacity { get; set; }\r\n        \r\n        public Inventory()\r\n        {\r\n            Items = new List<GameObject>();\r\n            MaxCapacity = 20;\r\n        }\r\n        \r\n        public bool CanAdd(GameObject item)\r\n        {\r\n            return TotalWeight + item.Weight <= MaxCapacity;\r\n        }\r\n        \r\n        public bool HasItem(string itemId)\r\n        {\r\n            return Items.Any(i => i.Id == itemId);\r\n        }\r\n        \r\n        public GameObject GetItem(string itemId)\r\n        {\r\n            return Items.FirstOrDefault(i => i.Id == itemId);\r\n        }\r\n    }\r\n    \r\n    public class PlayerStats\r\n    {\r\n        public TimeSpan PlayTime { get; set; }\r\n        public int CommandsExecuted { get; set; }\r\n        public int RoomsExplored { get; set; }\r\n        public int ItemsCollected { get; set; }\r\n        public int PuzzlesSolved { get; set; }\r\n        public DateTime StartTime { get; set; }\r\n    }\r\n    \r\n    public class StatusEffect\r\n    {\r\n        public string Id { get; set; }\r\n        public string Name { get; set; }\r\n        public string Description { get; set; }\r\n        public int Duration { get; set; }  // In turns/actions\r\n        public EffectType Type { get; set; }\r\n        public int Magnitude { get; set; }\r\n    }\r\n    \r\n    public enum EffectType\r\n    {\r\n        Health,\r\n        Speed,\r\n        Vision,\r\n        Strength\r\n    }\r\n}\r\n```\r\n\r\n### Command Models\r\n\r\nRepresents player commands and their parsed structure.\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Models\r\n{\r\n    public class ParsedCommand\r\n    {\r\n        public string Verb { get; set; }\r\n        public string Object { get; set; }\r\n        public string Target { get; set; }\r\n        public string Context { get; set; }\r\n        public double Confidence { get; set; }\r\n        public string RawInput { get; set; }\r\n        public DateTime Timestamp { get; set; }\r\n        \r\n        public ParsedCommand()\r\n        {\r\n            Timestamp = DateTime.UtcNow;\r\n        }\r\n    }\r\n    \r\n    public class CommandResult\r\n    {\r\n        public bool Success { get; set; }\r\n        public string Message { get; set; }\r\n        public List<string> AdditionalMessages { get; set; }\r\n        public GameStateChange StateChange { get; set; }\r\n        public CommandResultType Type { get; set; }\r\n        \r\n        public CommandResult()\r\n        {\r\n            AdditionalMessages = new List<string>();\r\n        }\r\n    }\r\n    \r\n    public enum CommandResultType\r\n    {\r\n        Success,\r\n        Failure,\r\n        InvalidCommand,\r\n        RequirementsNotMet,\r\n        AmbiguousCommand,\r\n        SystemMessage\r\n    }\r\n    \r\n    public class GameStateChange\r\n    {\r\n        public string LocationChanged { get; set; }\r\n        public List<string> ItemsAdded { get; set; }\r\n        public List<string> ItemsRemoved { get; set; }\r\n        public int HealthChange { get; set; }\r\n        public Dictionary<string, bool> FlagsChanged { get; set; }\r\n        \r\n        public GameStateChange()\r\n        {\r\n            ItemsAdded = new List<string>();\r\n            ItemsRemoved = new List<string>();\r\n            FlagsChanged = new Dictionary<string, bool>();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### Story Pack Model\r\n\r\nRepresents a complete theme/story package.\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Models\r\n{\r\n    public class StoryPack\r\n    {\r\n        public string Id { get; set; }\r\n        public string Theme { get; set; }\r\n        public string Description { get; set; }\r\n        public string Version { get; set; }\r\n        public string Author { get; set; }\r\n        public List<Room> Rooms { get; set; }\r\n        public Dictionary<string, GameObject> Objects { get; set; }\r\n        public StoryMetadata Metadata { get; set; }\r\n        public string StartingRoomId { get; set; }\r\n        public List<Achievement> Achievements { get; set; }\r\n        \r\n        public StoryPack()\r\n        {\r\n            Rooms = new List<Room>();\r\n            Objects = new Dictionary<string, GameObject>();\r\n            Achievements = new List<Achievement>();\r\n        }\r\n    }\r\n    \r\n    public class StoryMetadata\r\n    {\r\n        public Difficulty Difficulty { get; set; }\r\n        public int EstimatedPlayTime { get; set; }  // In minutes\r\n        public List<string> Tags { get; set; }\r\n        public string CoverImage { get; set; }\r\n        public string ThemeColor { get; set; }\r\n        public DateTime CreatedDate { get; set; }\r\n        public DateTime ModifiedDate { get; set; }\r\n        \r\n        public StoryMetadata()\r\n        {\r\n            Tags = new List<string>();\r\n        }\r\n    }\r\n    \r\n    public enum Difficulty\r\n    {\r\n        Easy,\r\n        Medium,\r\n        Hard,\r\n        Expert\r\n    }\r\n    \r\n    public class Achievement\r\n    {\r\n        public string Id { get; set; }\r\n        public string Name { get; set; }\r\n        public string Description { get; set; }\r\n        public List<string> RequiredFlags { get; set; }\r\n        public bool IsUnlocked { get; set; }\r\n    }\r\n}\r\n```\r\n\r\n## Game State Models\r\n\r\n### Complete Game State\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Models\r\n{\r\n    public class GameState\r\n    {\r\n        public Guid Id { get; set; }\r\n        public string SaveName { get; set; }\r\n        public Player Player { get; set; }\r\n        public WorldState World { get; set; }\r\n        public ProgressState Progress { get; set; }\r\n        public MetaState Meta { get; set; }\r\n        public List<NarrativeEntry> StoryLog { get; set; }\r\n        \r\n        public GameState()\r\n        {\r\n            Id = Guid.NewGuid();\r\n            Player = new Player();\r\n            World = new WorldState();\r\n            Progress = new ProgressState();\r\n            Meta = new MetaState();\r\n            StoryLog = new List<NarrativeEntry>();\r\n        }\r\n    }\r\n    \r\n    public class WorldState\r\n    {\r\n        public string CurrentThemeId { get; set; }\r\n        public Dictionary<string, Room> Rooms { get; set; }\r\n        public Dictionary<string, GameObject> Objects { get; set; }\r\n        public Dictionary<string, object> GlobalVariables { get; set; }\r\n        public int TurnNumber { get; set; }\r\n        \r\n        public WorldState()\r\n        {\r\n            Rooms = new Dictionary<string, Room>();\r\n            Objects = new Dictionary<string, GameObject>();\r\n            GlobalVariables = new Dictionary<string, object>();\r\n        }\r\n    }\r\n    \r\n    public class ProgressState\r\n    {\r\n        public List<string> CompletedPuzzles { get; set; }\r\n        public List<string> UnlockedAreas { get; set; }\r\n        public List<string> DiscoveredSecrets { get; set; }\r\n        public Dictionary<string, bool> StoryFlags { get; set; }\r\n        public int Score { get; set; }\r\n        public List<string> UnlockedAchievements { get; set; }\r\n        \r\n        public ProgressState()\r\n        {\r\n            CompletedPuzzles = new List<string>();\r\n            UnlockedAreas = new List<string>();\r\n            DiscoveredSecrets = new List<string>();\r\n            StoryFlags = new Dictionary<string, bool>();\r\n            UnlockedAchievements = new List<string>();\r\n        }\r\n    }\r\n    \r\n    public class MetaState\r\n    {\r\n        public DateTime SaveTimestamp { get; set; }\r\n        public string Version { get; set; }\r\n        public TimeSpan TotalPlayTime { get; set; }\r\n        public int SaveCount { get; set; }\r\n        public string DeviceId { get; set; }\r\n        \r\n        public MetaState()\r\n        {\r\n            SaveTimestamp = DateTime.UtcNow;\r\n            Version = \"1.0.0\";\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## UI Models\r\n\r\n### Narrative Entry\r\n\r\n```csharp\r\nnamespace TheCabin.Presentation.Models\r\n{\r\n    public class NarrativeEntry\r\n    {\r\n        public Guid Id { get; set; }\r\n        public string Text { get; set; }\r\n        public NarrativeType Type { get; set; }\r\n        public DateTime Timestamp { get; set; }\r\n        public string SpeakerName { get; set; }\r\n        public Color TextColor { get; set; }\r\n        public bool IsImportant { get; set; }\r\n        \r\n        public NarrativeEntry()\r\n        {\r\n            Id = Guid.NewGuid();\r\n            Timestamp = DateTime.Now;\r\n        }\r\n    }\r\n    \r\n    public enum NarrativeType\r\n    {\r\n        Description,\r\n        PlayerCommand,\r\n        SystemMessage,\r\n        Success,\r\n        Failure,\r\n        Dialogue,\r\n        Discovery\r\n    }\r\n}\r\n```\r\n\r\n### Voice Recognition Models\r\n\r\n```csharp\r\nnamespace TheCabin.Services.Models\r\n{\r\n    public class VoiceRecognitionResult\r\n    {\r\n        public bool Success { get; set; }\r\n        public string TranscribedText { get; set; }\r\n        public double Confidence { get; set; }\r\n        public List<string> Alternatives { get; set; }\r\n        public TimeSpan Duration { get; set; }\r\n        public string ErrorMessage { get; set; }\r\n        \r\n        public VoiceRecognitionResult()\r\n        {\r\n            Alternatives = new List<string>();\r\n        }\r\n    }\r\n    \r\n    public class VoiceSettings\r\n    {\r\n        public bool IsEnabled { get; set; }\r\n        public bool AutoListen { get; set; }\r\n        public bool UsePushToTalk { get; set; }\r\n        public float ConfidenceThreshold { get; set; }\r\n        public string PreferredEngine { get; set; }\r\n        public bool OfflineMode { get; set; }\r\n        \r\n        public VoiceSettings()\r\n        {\r\n            IsEnabled = true;\r\n            AutoListen = false;\r\n            UsePushToTalk = true;\r\n            ConfidenceThreshold = 0.75f;\r\n            PreferredEngine = \"Android\";\r\n            OfflineMode = false;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### TTS Models\r\n\r\n```csharp\r\nnamespace TheCabin.Services.Models\r\n{\r\n    public class TtsSettings\r\n    {\r\n        public bool IsEnabled { get; set; }\r\n        public float SpeechRate { get; set; }\r\n        public float Pitch { get; set; }\r\n        public float Volume { get; set; }\r\n        public string PreferredVoice { get; set; }\r\n        public bool AutoNarrate { get; set; }\r\n        \r\n        public TtsSettings()\r\n        {\r\n            IsEnabled = true;\r\n            SpeechRate = 1.0f;\r\n            Pitch = 1.0f;\r\n            Volume = 1.0f;\r\n            AutoNarrate = false;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Database Models (SQLite)\r\n\r\n### Save Game Table\r\n\r\n```csharp\r\nnamespace TheCabin.Data.Models\r\n{\r\n    [Table(\"GameSaves\")]\r\n    public class GameSaveEntity\r\n    {\r\n        [PrimaryKey, AutoIncrement]\r\n        public int Id { get; set; }\r\n        \r\n        [MaxLength(100)]\r\n        public string Name { get; set; }\r\n        \r\n        [MaxLength(50)]\r\n        public string ThemeId { get; set; }\r\n        \r\n        public string GameStateJson { get; set; }\r\n        \r\n        public long Timestamp { get; set; }\r\n        \r\n        [MaxLength(20)]\r\n        public string Version { get; set; }\r\n        \r\n        public int PlayTimeMinutes { get; set; }\r\n        \r\n        public byte[] Thumbnail { get; set; }\r\n    }\r\n}\r\n```\r\n\r\n### Command Cache Table\r\n\r\n```csharp\r\nnamespace TheCabin.Data.Models\r\n{\r\n    [Table(\"CommandCache\")]\r\n    public class CommandCacheEntity\r\n    {\r\n        [PrimaryKey, MaxLength(64)]\r\n        public string CommandHash { get; set; }\r\n        \r\n        [MaxLength(64)]\r\n        public string ContextHash { get; set; }\r\n        \r\n        public string ParsedJson { get; set; }\r\n        \r\n        public float Confidence { get; set; }\r\n        \r\n        public long Timestamp { get; set; }\r\n        \r\n        public int HitCount { get; set; }\r\n        \r\n        [Indexed]\r\n        public long ExpiryTimestamp { get; set; }\r\n    }\r\n}\r\n```\r\n\r\n### Settings Table\r\n\r\n```csharp\r\nnamespace TheCabin.Data.Models\r\n{\r\n    [Table(\"Settings\")]\r\n    public class SettingEntity\r\n    {\r\n        [PrimaryKey, MaxLength(50)]\r\n        public string Key { get; set; }\r\n        \r\n        public string Value { get; set; }\r\n        \r\n        public string Type { get; set; }\r\n        \r\n        public long ModifiedTimestamp { get; set; }\r\n    }\r\n}\r\n```\r\n\r\n## API Models (LLM Integration)\r\n\r\n### LLM Request\r\n\r\n```csharp\r\nnamespace TheCabin.Services.Models\r\n{\r\n    public class LlmParseRequest\r\n    {\r\n        public string Input { get; set; }\r\n        public string CurrentLocation { get; set; }\r\n        public List<string> VisibleObjects { get; set; }\r\n        public List<string> InventoryItems { get; set; }\r\n        public List<string> RecentCommands { get; set; }\r\n        public Dictionary<string, bool> GameFlags { get; set; }\r\n        \r\n        public LlmParseRequest()\r\n        {\r\n            VisibleObjects = new List<string>();\r\n            InventoryItems = new List<string>();\r\n            RecentCommands = new List<string>();\r\n            GameFlags = new Dictionary<string, bool>();\r\n        }\r\n    }\r\n    \r\n    public class LlmParseResponse\r\n    {\r\n        public string Verb { get; set; }\r\n        public string Object { get; set; }\r\n        public string Target { get; set; }\r\n        public string Context { get; set; }\r\n        public double Confidence { get; set; }\r\n        public string Reasoning { get; set; }\r\n        public List<string> AlternativeInterpretations { get; set; }\r\n        \r\n        public LlmParseResponse()\r\n        {\r\n            AlternativeInterpretations = new List<string>();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Validation and Constraints\r\n\r\n### Command Verbs (Standard Set)\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Constants\r\n{\r\n    public static class CommandVerbs\r\n    {\r\n        // Movement\r\n        public const string Go = \"go\";\r\n        public const string Move = \"move\";\r\n        public const string Walk = \"walk\";\r\n        public const string Run = \"run\";\r\n        \r\n        // Interaction\r\n        public const string Take = \"take\";\r\n        public const string Drop = \"drop\";\r\n        public const string Use = \"use\";\r\n        public const string Open = \"open\";\r\n        public const string Close = \"close\";\r\n        public const string Push = \"push\";\r\n        public const string Pull = \"pull\";\r\n        \r\n        // Examination\r\n        public const string Look = \"look\";\r\n        public const string Examine = \"examine\";\r\n        public const string Search = \"search\";\r\n        public const string Read = \"read\";\r\n        \r\n        // Inventory\r\n        public const string Inventory = \"inventory\";\r\n        public const string Equipment = \"equipment\";\r\n        \r\n        // System\r\n        public const string Help = \"help\";\r\n        public const string Save = \"save\";\r\n        public const string Load = \"load\";\r\n        public const string Quit = \"quit\";\r\n        \r\n        public static readonly HashSet<string> AllVerbs = new()\r\n        {\r\n            Go, Move, Walk, Run,\r\n            Take, Drop, Use, Open, Close, Push, Pull,\r\n            Look, Examine, Search, Read,\r\n            Inventory, Equipment,\r\n            Help, Save, Load, Quit\r\n        };\r\n    }\r\n}\r\n```\r\n\r\n## Model Relationships Diagram\r\n\r\n```text\r\nStoryPack\r\n    ├─ Rooms[]\r\n    │   ├─ Objects[] (references)\r\n    │   └─ Exits{} → Room IDs\r\n    └─ Objects{} (dictionary)\r\n\r\nGameState\r\n    ├─ Player\r\n    │   ├─ Inventory\r\n    │   │   └─ Items[] (GameObject references)\r\n    │   └─ StatusEffects[]\r\n    ├─ WorldState\r\n    │   ├─ Rooms{}\r\n    │   └─ Objects{}\r\n    ├─ ProgressState\r\n    └─ MetaState\r\n\r\nParsedCommand → CommandResult → GameStateChange\r\n```\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 02-system-architecture.md, 06-game-engine.md, 09-content-management.md\r\n\n</file_content>\n\n<file_content path=\"docs/05-voice-pipeline.md\">\n# 05 - Voice Pipeline\r\n\r\n## Overview\r\n\r\nThe voice pipeline is the core feature of The Cabin, enabling hands-free gameplay through speech recognition and natural language processing. This document details the complete voice-to-command workflow.\r\n\r\n## Voice Pipeline Architecture\r\n\r\n```text\r\n┌─────────────────────────────────────────────────────────────┐\r\n│                     VOICE PIPELINE                          │\r\n└─────────────────────────────────────────────────────────────┘\r\n\r\n1. CAPTURE                    5. VALIDATION\r\n   ┌──────────┐                 ┌──────────┐\r\n   │Microphone│                 │Validator │\r\n   │  Input   │                 │  Engine  │\r\n   └────┬─────┘                 └────┬─────┘\r\n        │                             │\r\n2. TRANSCRIBE              6. EXECUTION\r\n   ┌────▼─────┐                 ┌────▼─────┐\r\n   │   STT    │                 │  Game    │\r\n   │  Engine  │                 │  Engine  │\r\n   └────┬─────┘                 └────┬─────┘\r\n        │                             │\r\n3. PARSE                   7. RESPONSE\r\n   ┌────▼─────┐                 ┌────▼─────┐\r\n   │   LLM    │                 │Narrative │\r\n   │  Parser  │                 │Generator │\r\n   └────┬─────┘                 └────┬─────┘\r\n        │                             │\r\n4. CACHE CHECK             8. NARRATION\r\n   ┌────▼─────┐                 ┌────▼─────┐\r\n   │  Cache   │                 │   TTS    │\r\n   │  Layer   │                 │  Engine  │\r\n   └──────────┘                 └──────────┘\r\n```\r\n\r\n## Component Details\r\n\r\n### 1. Voice Capture\r\n\r\n#### Android Speech Recognizer Implementation\r\n\r\n```csharp\r\nnamespace TheCabin.Platforms.Android.Services\r\n{\r\n    public class AndroidVoiceRecognitionService : IVoiceRecognitionService\r\n    {\r\n        private readonly SpeechRecognizer _recognizer;\r\n        private readonly TaskCompletionSource<VoiceRecognitionResult> _tcs;\r\n        private readonly ILogger<AndroidVoiceRecognitionService> _logger;\r\n        \r\n        public AndroidVoiceRecognitionService(ILogger<AndroidVoiceRecognitionService> logger)\r\n        {\r\n            _logger = logger;\r\n            _recognizer = SpeechRecognizer.CreateSpeechRecognizer(\r\n                Platform.AppContext);\r\n            _recognizer.SetRecognitionListener(new RecognitionListener(this));\r\n        }\r\n        \r\n        public async Task<VoiceRecognitionResult> RecognizeSpeechAsync(\r\n            CancellationToken cancellationToken = default)\r\n        {\r\n            _tcs = new TaskCompletionSource<VoiceRecognitionResult>();\r\n            \r\n            // Check permissions\r\n            var permissionStatus = await Permissions\r\n                .CheckStatusAsync<Permissions.Microphone>();\r\n                \r\n            if (permissionStatus != PermissionStatus.Granted)\r\n            {\r\n                permissionStatus = await Permissions\r\n                    .RequestAsync<Permissions.Microphone>();\r\n                    \r\n                if (permissionStatus != PermissionStatus.Granted)\r\n                {\r\n                    return new VoiceRecognitionResult\r\n                    {\r\n                        Success = false,\r\n                        ErrorMessage = \"Microphone permission denied\"\r\n                    };\r\n                }\r\n            }\r\n            \r\n            // Configure intent\r\n            var intent = new Intent(RecognizerIntent.ActionRecognizeSpeech);\r\n            intent.PutExtra(RecognizerIntent.ExtraLanguageModel,\r\n                RecognizerIntent.LanguageModelFreeForm);\r\n            intent.PutExtra(RecognizerIntent.ExtraLanguage, \"en-US\");\r\n            intent.PutExtra(RecognizerIntent.ExtraMaxResults, 5);\r\n            intent.PutExtra(RecognizerIntent.ExtraPartialResults, true);\r\n            \r\n            // Start listening\r\n            _recognizer.StartListening(intent);\r\n            \r\n            // Wait for result or cancellation\r\n            using (cancellationToken.Register(() => \r\n            {\r\n                _recognizer.StopListening();\r\n                _tcs?.TrySetCanceled();\r\n            }))\r\n            {\r\n                return await _tcs.Task;\r\n            }\r\n        }\r\n        \r\n        public void StopListening()\r\n        {\r\n            _recognizer.StopListening();\r\n        }\r\n        \r\n        private class RecognitionListener : Java.Lang.Object, \r\n            IRecognitionListener\r\n        {\r\n            private readonly AndroidVoiceRecognitionService _service;\r\n            private readonly Stopwatch _stopwatch;\r\n            \r\n            public RecognitionListener(AndroidVoiceRecognitionService service)\r\n            {\r\n                _service = service;\r\n                _stopwatch = new Stopwatch();\r\n            }\r\n            \r\n            public void OnBeginningOfSpeech()\r\n            {\r\n                _stopwatch.Start();\r\n            }\r\n            \r\n            public void OnEndOfSpeech()\r\n            {\r\n                _stopwatch.Stop();\r\n            }\r\n            \r\n            public void OnResults(Bundle results)\r\n            {\r\n                var matches = results\r\n                    .GetStringArrayList(SpeechRecognizer.ResultsRecognition);\r\n                var confidences = results\r\n                    .GetFloatArray(SpeechRecognizer.ConfidenceScores);\r\n                \r\n                if (matches?.Count > 0)\r\n                {\r\n                    var result = new VoiceRecognitionResult\r\n                    {\r\n                        Success = true,\r\n                        TranscribedText = matches[0],\r\n                        Confidence = confidences?[0] ?? 0.0,\r\n                        Alternatives = matches.Skip(1).ToList(),\r\n                        Duration = _stopwatch.Elapsed\r\n                    };\r\n                    \r\n                    _service._tcs.TrySetResult(result);\r\n                }\r\n            }\r\n            \r\n            public void OnError(SpeechRecognizerError error)\r\n            {\r\n                var result = new VoiceRecognitionResult\r\n                {\r\n                    Success = false,\r\n                    ErrorMessage = GetErrorMessage(error)\r\n                };\r\n                \r\n                _service._tcs.TrySetResult(result);\r\n            }\r\n            \r\n            private string GetErrorMessage(SpeechRecognizerError error)\r\n            {\r\n                return error switch\r\n                {\r\n                    SpeechRecognizerError.Network => \r\n                        \"Network error. Check your connection.\",\r\n                    SpeechRecognizerError.NoMatch => \r\n                        \"Didn't catch that. Please try again.\",\r\n                    SpeechRecognizerError.Audio => \r\n                        \"Audio error. Check microphone.\",\r\n                    SpeechRecognizerError.InsufficientPermissions => \r\n                        \"Microphone permission required.\",\r\n                    _ => \"Recognition failed. Please try again.\"\r\n                };\r\n            }\r\n            \r\n            // Other interface methods (OnReadyForSpeech, OnRmsChanged, etc.)\r\n            public void OnReadyForSpeech(Bundle @params) { }\r\n            public void OnRmsChanged(float rmsdB) { }\r\n            public void OnBufferReceived(byte[] buffer) { }\r\n            public void OnPartialResults(Bundle partialResults) { }\r\n            public void OnEvent(int eventType, Bundle @params) { }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n#### Audio Quality Settings\r\n\r\n```csharp\r\npublic class AudioSettings\r\n{\r\n    // Microphone sensitivity (0.0 - 1.0)\r\n    public float Sensitivity { get; set; } = 0.7f;\r\n    \r\n    // Noise cancellation\r\n    public bool NoiseReduction { get; set; } = true;\r\n    \r\n    // Automatic gain control\r\n    public bool AutoGainControl { get; set; } = true;\r\n    \r\n    // Sample rate (Hz)\r\n    public int SampleRate { get; set; } = 16000;\r\n    \r\n    // Timeout for silence (ms)\r\n    public int SilenceTimeout { get; set; } = 2000;\r\n    \r\n    // Maximum recording duration (ms)\r\n    public int MaxDuration { get; set; } = 10000;\r\n}\r\n```\r\n\r\n### 2. Speech-to-Text (STT)\r\n\r\n#### Confidence Threshold Handler\r\n\r\n```csharp\r\npublic class SttConfidenceHandler\r\n{\r\n    private readonly float _minConfidence;\r\n    private readonly ILogger _logger;\r\n    \r\n    public SttConfidenceHandler(\r\n        IOptions<VoiceSettings> settings,\r\n        ILogger<SttConfidenceHandler> logger)\r\n    {\r\n        _minConfidence = settings.Value.ConfidenceThreshold;\r\n        _logger = logger;\r\n    }\r\n    \r\n    public async Task<VoiceRecognitionResult> HandleLowConfidence(\r\n        VoiceRecognitionResult result)\r\n    {\r\n        if (result.Confidence < _minConfidence)\r\n        {\r\n            _logger.LogWarning(\r\n                \"Low confidence: {Confidence:P} for '{Text}'\",\r\n                result.Confidence, result.TranscribedText);\r\n            \r\n            // Try alternatives if available\r\n            if (result.Alternatives?.Count > 0)\r\n            {\r\n                foreach (var alt in result.Alternatives)\r\n                {\r\n                    // Could implement fuzzy matching here\r\n                    // For now, just log alternatives\r\n                    _logger.LogInformation(\r\n                        \"Alternative: {Alternative}\", alt);\r\n                }\r\n            }\r\n            \r\n            // Request user confirmation\r\n            result.ErrorMessage = \r\n                $\"Did you say '{result.TranscribedText}'? \" +\r\n                $\"Please confirm or try again.\";\r\n        }\r\n        \r\n        return result;\r\n    }\r\n}\r\n```\r\n\r\n### 3. Command Parsing\r\n\r\n#### LLM-Based Parser\r\n\r\n```csharp\r\nnamespace TheCabin.Services\r\n{\r\n    public class LlmCommandParserService : ICommandParserService\r\n    {\r\n        private readonly OpenAIClient _client;\r\n        private readonly IMemoryCache _cache;\r\n        private readonly ILogger _logger;\r\n        \r\n        private const string SystemPrompt = @\"\r\nYou are a command parser for a text adventure game. \r\nParse the player's input into a structured JSON command.\r\n\r\nAvailable verbs: go, take, drop, use, open, close, examine, look, \r\nread, push, pull, inventory, help, save, load\r\n\r\nOutput format:\r\n{\r\n  \"\"verb\"\": \"\"action verb\"\",\r\n  \"\"object\"\": \"\"target object or null\"\",\r\n  \"\"target\"\": \"\"secondary object or null\"\",\r\n  \"\"context\"\": \"\"additional context\"\",\r\n  \"\"confidence\"\": 0.0-1.0\r\n}\r\n\r\nExamples:\r\nInput: 'go north' → {\"\"verb\"\":\"\"go\"\",\"\"object\"\":\"\"north\"\",\"\"confidence\"\":0.95}\r\nInput: 'pick up the lantern' → {\"\"verb\"\":\"\"take\"\",\"\"object\"\":\"\"lantern\"\",\"\"confidence\"\":0.9}\r\nInput: 'use key on door' → {\"\"verb\"\":\"\"use\"\",\"\"object\"\":\"\"key\"\",\"\"target\"\":\"\"door\"\",\"\"confidence\"\":0.85}\r\n\";\r\n        \r\n        public async Task<ParsedCommand> ParseAsync(\r\n            string input,\r\n            GameContext context,\r\n            CancellationToken cancellationToken = default)\r\n        {\r\n            // Build cache key\r\n            var cacheKey = GenerateCacheKey(input, context);\r\n            \r\n            // Check cache\r\n            if (_cache.TryGetValue<ParsedCommand>(cacheKey, out var cached))\r\n            {\r\n                _logger.LogInformation(\r\n                    \"Cache hit for command: {Input}\", input);\r\n                return cached;\r\n            }\r\n            \r\n            // Prepare context information\r\n            var contextInfo = BuildContextInfo(context);\r\n            \r\n            // Build user prompt\r\n            var userPrompt = $@\"\r\nContext:\r\n- Location: {context.CurrentLocation}\r\n- Visible objects: {string.Join(\", \", context.VisibleObjects)}\r\n- Inventory: {string.Join(\", \", context.InventoryItems)}\r\n- Recent actions: {string.Join(\", \", context.RecentCommands.TakeLast(3))}\r\n\r\nPlayer input: \"\"{input}\"\"\r\n\r\nParse this command into JSON.\";\r\n            \r\n            try\r\n            {\r\n                var chatCompletion = await _client.GetChatCompletionsAsync(\r\n                    new ChatCompletionsOptions\r\n                    {\r\n                        DeploymentName = \"gpt-4o-mini\",\r\n                        Messages =\r\n                        {\r\n                            new ChatRequestSystemMessage(SystemPrompt),\r\n                            new ChatRequestUserMessage(userPrompt)\r\n                        },\r\n                        Temperature = 0.3f,\r\n                        MaxTokens = 150,\r\n                        ResponseFormat = ChatCompletionsResponseFormat.JsonObject\r\n                    },\r\n                    cancellationToken);\r\n                \r\n                var response = chatCompletion.Value.Choices[0].Message.Content;\r\n                var parsed = JsonSerializer.Deserialize<ParsedCommand>(response);\r\n                \r\n                if (parsed != null)\r\n                {\r\n                    parsed.RawInput = input;\r\n                    \r\n                    // Cache successful parse\r\n                    _cache.Set(cacheKey, parsed, TimeSpan.FromHours(24));\r\n                    \r\n                    _logger.LogInformation(\r\n                        \"Parsed '{Input}' → Verb: {Verb}, Object: {Object}, Confidence: {Confidence:P}\",\r\n                        input, parsed.Verb, parsed.Object, parsed.Confidence);\r\n                    \r\n                    return parsed;\r\n                }\r\n            }\r\n            catch (Exception ex)\r\n            {\r\n                _logger.LogError(ex, \r\n                    \"LLM parsing failed for input: {Input}\", input);\r\n            }\r\n            \r\n            // Fallback to local parser\r\n            return await FallbackParse(input);\r\n        }\r\n        \r\n        private string GenerateCacheKey(string input, GameContext context)\r\n        {\r\n            var contextHash = HashCode.Combine(\r\n                context.CurrentLocation,\r\n                string.Join(\",\", context.VisibleObjects.OrderBy(x => x)),\r\n                string.Join(\",\", context.InventoryItems.OrderBy(x => x))\r\n            );\r\n            \r\n            return $\"cmd:{input.ToLowerInvariant()}:ctx:{contextHash}\";\r\n        }\r\n        \r\n        private string BuildContextInfo(GameContext context)\r\n        {\r\n            return JsonSerializer.Serialize(new\r\n            {\r\n                location = context.CurrentLocation,\r\n                visible = context.VisibleObjects,\r\n                inventory = context.InventoryItems,\r\n                flags = context.GameFlags\r\n            });\r\n        }\r\n        \r\n        private async Task<ParsedCommand> FallbackParse(string input)\r\n        {\r\n            // Simple rule-based parser as fallback\r\n            var words = input.ToLower()\r\n                .Split(' ', StringSplitOptions.RemoveEmptyEntries);\r\n            \r\n            if (words.Length == 0)\r\n            {\r\n                return new ParsedCommand\r\n                {\r\n                    Verb = \"help\",\r\n                    Confidence = 0.5,\r\n                    RawInput = input\r\n                };\r\n            }\r\n            \r\n            var verb = words[0];\r\n            var obj = words.Length > 1 ? words[1] : null;\r\n            \r\n            // Map common variations\r\n            verb = verb switch\r\n            {\r\n                \"grab\" or \"get\" or \"pickup\" => \"take\",\r\n                \"leave\" or \"discard\" => \"drop\",\r\n                \"inspect\" or \"check\" => \"examine\",\r\n                \"see\" or \"view\" => \"look\",\r\n                _ => verb\r\n            };\r\n            \r\n            return new ParsedCommand\r\n            {\r\n                Verb = verb,\r\n                Object = obj,\r\n                Confidence = 0.6,\r\n                RawInput = input\r\n            };\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n#### Local Rule-Based Parser (Fallback)\r\n\r\n```csharp\r\npublic class LocalCommandParser : ILocalCommandParser\r\n{\r\n    private static readonly Dictionary<string, List<string>> VerbSynonyms = new()\r\n    {\r\n        [\"take\"] = new() { \"get\", \"grab\", \"pickup\", \"pick\", \"collect\" },\r\n        [\"drop\"] = new() { \"leave\", \"discard\", \"put\", \"place\" },\r\n        [\"use\"] = new() { \"activate\", \"employ\", \"utilize\" },\r\n        [\"open\"] = new() { \"unlock\", \"unseals\" },\r\n        [\"close\"] = new() { \"shut\", \"lock\", \"seal\" },\r\n        [\"examine\"] = new() { \"inspect\", \"check\", \"study\", \"investigate\" },\r\n        [\"look\"] = new() { \"see\", \"view\", \"observe\", \"peek\" },\r\n        [\"go\"] = new() { \"move\", \"walk\", \"run\", \"travel\", \"head\" }\r\n    };\r\n    \r\n    public bool CanHandle(string input)\r\n    {\r\n        var words = input.ToLower().Split(' ');\r\n        var firstWord = words.FirstOrDefault();\r\n        \r\n        // Check if first word matches any known verb or synonym\r\n        return CommandVerbs.AllVerbs.Contains(firstWord) ||\r\n               VerbSynonyms.Values.Any(synonyms => \r\n                   synonyms.Contains(firstWord));\r\n    }\r\n    \r\n    public Task<ParsedCommand> ParseAsync(\r\n        string input, \r\n        GameContext context)\r\n    {\r\n        var words = input.ToLower()\r\n            .Split(' ', StringSplitOptions.RemoveEmptyEntries)\r\n            .ToList();\r\n        \r\n        if (words.Count == 0)\r\n            return Task.FromResult(CreateHelpCommand(input));\r\n        \r\n        // Normalize verb\r\n        var verb = NormalizeVerb(words[0]);\r\n        \r\n        // Extract object and target\r\n        string obj = null;\r\n        string target = null;\r\n        \r\n        if (words.Count > 1)\r\n        {\r\n            // Remove common filler words\r\n            var filtered = words.Skip(1)\r\n                .Where(w => !IsFillerWord(w))\r\n                .ToList();\r\n            \r\n            if (filtered.Count > 0)\r\n            {\r\n                obj = filtered[0];\r\n                \r\n                // Check for \"use X on Y\" pattern\r\n                if (filtered.Count > 2 && filtered[1] == \"on\")\r\n                {\r\n                    target = filtered[2];\r\n                }\r\n            }\r\n        }\r\n        \r\n        return Task.FromResult(new ParsedCommand\r\n        {\r\n            Verb = verb,\r\n            Object = obj,\r\n            Target = target,\r\n            Confidence = 0.7,\r\n            RawInput = input\r\n        });\r\n    }\r\n    \r\n    private string NormalizeVerb(string word)\r\n    {\r\n        // Direct match\r\n        if (CommandVerbs.AllVerbs.Contains(word))\r\n            return word;\r\n        \r\n        // Find in synonyms\r\n        foreach (var kvp in VerbSynonyms)\r\n        {\r\n            if (kvp.Value.Contains(word))\r\n                return kvp.Key;\r\n        }\r\n        \r\n        return word;\r\n    }\r\n    \r\n    private bool IsFillerWord(string word)\r\n    {\r\n        return new[] { \"the\", \"a\", \"an\", \"to\", \"at\", \"in\", \"on\" }\r\n            .Contains(word);\r\n    }\r\n    \r\n    private ParsedCommand CreateHelpCommand(string input)\r\n    {\r\n        return new ParsedCommand\r\n        {\r\n            Verb = \"help\",\r\n            Confidence = 0.5,\r\n            RawInput = input\r\n        };\r\n    }\r\n}\r\n```\r\n\r\n### 4. Command Caching\r\n\r\n```csharp\r\npublic class CommandCacheService\r\n{\r\n    private readonly ICommandCacheRepository _repository;\r\n    private readonly IMemoryCache _memoryCache;\r\n    private readonly ILogger _logger;\r\n    \r\n    public async Task<ParsedCommand> GetCachedAsync(\r\n        string commandHash,\r\n        string contextHash)\r\n    {\r\n        // Check memory cache first\r\n        var key = $\"{commandHash}:{contextHash}\";\r\n        if (_memoryCache.TryGetValue<ParsedCommand>(key, out var cached))\r\n        {\r\n            return cached;\r\n        }\r\n        \r\n        // Check database cache\r\n        var entity = await _repository.GetAsync(commandHash, contextHash);\r\n        if (entity != null && !IsExpired(entity))\r\n        {\r\n            var parsed = JsonSerializer\r\n                .Deserialize<ParsedCommand>(entity.ParsedJson);\r\n            \r\n            // Update memory cache\r\n            _memoryCache.Set(key, parsed, TimeSpan.FromMinutes(30));\r\n            \r\n            // Update hit count\r\n            await _repository.IncrementHitCountAsync(commandHash);\r\n            \r\n            return parsed;\r\n        }\r\n        \r\n        return null;\r\n    }\r\n    \r\n    public async Task CacheAsync(\r\n        string commandHash,\r\n        string contextHash,\r\n        ParsedCommand parsed)\r\n    {\r\n        var entity = new CommandCacheEntity\r\n        {\r\n            CommandHash = commandHash,\r\n            ContextHash = contextHash,\r\n            ParsedJson = JsonSerializer.Serialize(parsed),\r\n            Confidence = (float)parsed.Confidence,\r\n            Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),\r\n            ExpiryTimestamp = DateTimeOffset.UtcNow\r\n                .AddDays(30).ToUnixTimeSeconds(),\r\n            HitCount = 0\r\n        };\r\n        \r\n        await _repository.UpsertAsync(entity);\r\n        \r\n        // Also cache in memory\r\n        var key = $\"{commandHash}:{contextHash}\";\r\n        _memoryCache.Set(key, parsed, TimeSpan.FromMinutes(30));\r\n    }\r\n    \r\n    private bool IsExpired(CommandCacheEntity entity)\r\n    {\r\n        var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();\r\n        return entity.ExpiryTimestamp < now;\r\n    }\r\n    \r\n    public async Task CleanupExpiredAsync()\r\n    {\r\n        var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();\r\n        await _repository.DeleteExpiredAsync(now);\r\n    }\r\n}\r\n```\r\n\r\n### 5. Error Handling & Retry Logic\r\n\r\n```csharp\r\npublic class VoiceCommandOrchestrator\r\n{\r\n    private readonly IVoiceRecognitionService _sttService;\r\n    private readonly ICommandParserService _parserService;\r\n    private readonly ITextToSpeechService _ttsService;\r\n    private readonly ILogger _logger;\r\n    \r\n    public async Task<ParsedCommand> ProcessVoiceCommandAsync(\r\n        GameContext context,\r\n        int maxRetries = 3)\r\n    {\r\n        for (int attempt = 1; attempt <= maxRetries; attempt++)\r\n        {\r\n            try\r\n            {\r\n                // Step 1: Voice recognition\r\n                var sttResult = await _sttService.RecognizeSpeechAsync();\r\n                \r\n                if (!sttResult.Success)\r\n                {\r\n                    if (attempt < maxRetries)\r\n                    {\r\n                        await _ttsService.SpeakAsync(\r\n                            sttResult.ErrorMessage ?? \r\n                            \"I didn't catch that. Please try again.\");\r\n                        continue;\r\n                    }\r\n                    throw new VoiceRecognitionException(sttResult.ErrorMessage);\r\n                }\r\n                \r\n                // Step 2: Check confidence\r\n                if (sttResult.Confidence < 0.7)\r\n                {\r\n                    // Ask for confirmation\r\n                    var confirmed = await ConfirmTranscription(\r\n                        sttResult.TranscribedText);\r\n                    if (!confirmed && attempt < maxRetries)\r\n                        continue;\r\n                }\r\n                \r\n                // Step 3: Parse command\r\n                var parsed = await _parserService.ParseAsync(\r\n                    sttResult.TranscribedText,\r\n                    context);\r\n                \r\n                // Step 4: Validate parse confidence\r\n                if (parsed.Confidence < 0.5)\r\n                {\r\n                    if (attempt < maxRetries)\r\n                    {\r\n                        await _ttsService.SpeakAsync(\r\n                            \"I'm not sure I understood that. \" +\r\n                            \"Could you rephrase?\");\r\n                        continue;\r\n                    }\r\n                }\r\n                \r\n                return parsed;\r\n            }\r\n            catch (Exception ex) when (attempt < maxRetries)\r\n            {\r\n                _logger.LogWarning(ex,\r\n                    \"Attempt {Attempt} failed, retrying...\", attempt);\r\n                \r\n                await _ttsService.SpeakAsync(\r\n                    \"Sorry, something went wrong. Let's try again.\");\r\n            }\r\n        }\r\n        \r\n        throw new MaxRetriesExceededException(\r\n            \"Failed to process voice command after maximum retries\");\r\n    }\r\n    \r\n    private async Task<bool> ConfirmTranscription(string text)\r\n    {\r\n        await _ttsService.SpeakAsync($\"Did you say '{text}'?\");\r\n        \r\n        var response = await _sttService.RecognizeSpeechAsync();\r\n        if (!response.Success)\r\n            return false;\r\n        \r\n        var confirmation = response.TranscribedText.ToLower();\r\n        return confirmation.Contains(\"yes\") || \r\n               confirmation.Contains(\"yeah\") || \r\n               confirmation.Contains(\"correct\");\r\n    }\r\n}\r\n```\r\n\r\n## Performance Optimization\r\n\r\n### Preloading and Warmup\r\n\r\n```csharp\r\npublic class VoicePipelineWarmup\r\n{\r\n    public async Task WarmupAsync()\r\n    {\r\n        // Initialize speech recognizer\r\n        await InitializeSpeechRecognizer();\r\n        \r\n        // Preload TTS voices\r\n        await PreloadTtsVoices();\r\n        \r\n        // Test LLM connection\r\n        await TestLlmConnection();\r\n        \r\n        // Load command cache\r\n        await LoadCommandCache();\r\n    }\r\n}\r\n```\r\n\r\n### Batch Processing\r\n\r\n```csharp\r\n// Process multiple cached commands at startup\r\npublic async Task PreprocessCommonCommands()\r\n{\r\n    var commonCommands = new[]\r\n    {\r\n        \"look\", \"look around\", \"inventory\", \r\n        \"go north\", \"go south\", \"go east\", \"go west\",\r\n        \"take all\", \"help\"\r\n    };\r\n    \r\n    foreach (var cmd in commonCommands)\r\n    {\r\n        await _parserService.ParseAsync(cmd, GetDefaultContext());\r\n    }\r\n}\r\n```\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 03-technical-stack.md, 06-game-engine.md\r\n\n</file_content>\n\n<file_content path=\"docs/06-game-engine.md\">\n# 06 - Game Engine\r\n\r\n## Overview\r\n\r\nThe game engine is the core logic system that manages world state, processes commands, handles puzzles, and drives the narrative forward. This document details the engine architecture and implementation.\r\n\r\n## Engine Architecture\r\n\r\n```text\r\n┌─────────────────────────────────────────────────────────────┐\r\n│                      GAME ENGINE                            │\r\n├─────────────────────────────────────────────────────────────┤\r\n│                                                             │\r\n│  ┌────────────────┐      ┌────────────────┐                 │\r\n│  │ State Machine  │◄────►│ Command Router │                 │\r\n│  └────────┬───────┘      └────────┬───────┘                 │\r\n│           │                       │                         │\r\n│           ▼                       ▼                         │\r\n│  ┌────────────────┐      ┌────────────────┐                 │\r\n│  │ World Manager  │      │Action Executor │                 │\r\n│  └────────┬───────┘      └────────┬───────┘                 │\r\n│           │                       │                         │\r\n│           ▼                       ▼                         │\r\n│  ┌────────────────┐      ┌────────────────┐                 │\r\n│  │ Inventory Mgr  │      │ Puzzle Engine  │                 │\r\n│  └────────────────┘      └────────────────┘                 │\r\n│                                                             │\r\n└─────────────────────────────────────────────────────────────┘\r\n```\r\n\r\n## Core Components\r\n\r\n### 1. Game State Machine\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Engine\r\n{\r\n    public class GameStateMachine\r\n    {\r\n        private readonly IWorldManager _worldManager;\r\n        private readonly IInventoryManager _inventoryManager;\r\n        private readonly IPuzzleEngine _puzzleEngine;\r\n        private readonly ILogger _logger;\r\n        \r\n        public GameState CurrentState { get; private set; }\r\n        \r\n        public GameStateMachine(\r\n            IWorldManager worldManager,\r\n            IInventoryManager inventoryManager,\r\n            IPuzzleEngine puzzleEngine,\r\n            ILogger<GameStateMachine> logger)\r\n        {\r\n            _worldManager = worldManager;\r\n            _inventoryManager = inventoryManager;\r\n            _puzzleEngine = puzzleEngine;\r\n            _logger = logger;\r\n        }\r\n        \r\n        public async Task InitializeAsync(StoryPack storyPack)\r\n        {\r\n            CurrentState = new GameState();\r\n            \r\n            // Initialize world from story pack\r\n            await _worldManager.LoadStoryPackAsync(storyPack);\r\n            \r\n            // Set starting location\r\n            CurrentState.Player.CurrentLocationId = storyPack.StartingRoomId;\r\n            \r\n            // Initialize world state\r\n            CurrentState.World = new WorldState\r\n            {\r\n                CurrentThemeId = storyPack.Id,\r\n                Rooms = storyPack.Rooms.ToDictionary(r => r.Id, r => r),\r\n                Objects = storyPack.Objects\r\n            };\r\n            \r\n            _logger.LogInformation(\r\n                \"Game initialized with theme: {Theme}\", storyPack.Theme);\r\n        }\r\n        \r\n        public Room GetCurrentRoom()\r\n        {\r\n            return CurrentState.World.Rooms[\r\n                CurrentState.Player.CurrentLocationId];\r\n        }\r\n        \r\n        public List<GameObject> GetVisibleObjects()\r\n        {\r\n            var room = GetCurrentRoom();\r\n            return room.State.VisibleObjectIds\r\n                .Select(id => CurrentState.World.Objects[id])\r\n                .Where(obj => obj.IsVisible)\r\n                .ToList();\r\n        }\r\n        \r\n        public bool CanTransitionTo(string roomId)\r\n        {\r\n            var currentRoom = GetCurrentRoom();\r\n            \r\n            // Check if exit exists\r\n            if (!currentRoom.Exits.ContainsValue(roomId))\r\n                return false;\r\n            \r\n            // Check if room is locked\r\n            var targetRoom = CurrentState.World.Rooms[roomId];\r\n            if (targetRoom.State.IsLocked)\r\n            {\r\n                // Check if player has key or unlock conditions met\r\n                return CheckUnlockConditions(targetRoom);\r\n            }\r\n            \r\n            return true;\r\n        }\r\n        \r\n        public void TransitionTo(string roomId)\r\n        {\r\n            if (!CanTransitionTo(roomId))\r\n            {\r\n                throw new InvalidOperationException(\r\n                    $\"Cannot transition to room: {roomId}\");\r\n            }\r\n            \r\n            var previousLocation = CurrentState.Player.CurrentLocationId;\r\n            CurrentState.Player.CurrentLocationId = roomId;\r\n            \r\n            // Mark room as visited\r\n            var room = CurrentState.World.Rooms[roomId];\r\n            room.IsVisited = true;\r\n            \r\n            // Update stats\r\n            if (!room.IsVisited)\r\n            {\r\n                CurrentState.Player.Stats.RoomsExplored++;\r\n            }\r\n            \r\n            _logger.LogInformation(\r\n                \"Player moved from {From} to {To}\",\r\n                previousLocation, roomId);\r\n        }\r\n        \r\n        private bool CheckUnlockConditions(Room room)\r\n        {\r\n            // Check required flags\r\n            if (room.State.Flags.TryGetValue(\"requires_key\", out var requiresKey)\r\n                && requiresKey)\r\n            {\r\n                var keyId = room.State.Flags\r\n                    .GetValueOrDefault(\"key_id\")?.ToString();\r\n                return _inventoryManager.HasItem(keyId);\r\n            }\r\n            \r\n            return false;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### 2. Command Router\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Engine\r\n{\r\n    public class CommandRouter\r\n    {\r\n        private readonly Dictionary<string, ICommandHandler> _handlers;\r\n        private readonly ILogger _logger;\r\n        \r\n        public CommandRouter(\r\n            IEnumerable<ICommandHandler> handlers,\r\n            ILogger<CommandRouter> logger)\r\n        {\r\n            _handlers = handlers.ToDictionary(h => h.Verb, h => h);\r\n            _logger = logger;\r\n        }\r\n        \r\n        public async Task<CommandResult> RouteAsync(\r\n            ParsedCommand command,\r\n            GameState gameState)\r\n        {\r\n            _logger.LogInformation(\r\n                \"Routing command: {Verb} {Object}\",\r\n                command.Verb, command.Object);\r\n            \r\n            // Find appropriate handler\r\n            if (!_handlers.TryGetValue(command.Verb, out var handler))\r\n            {\r\n                return new CommandResult\r\n                {\r\n                    Success = false,\r\n                    Type = CommandResultType.InvalidCommand,\r\n                    Message = $\"I don't understand '{command.Verb}'.\"\r\n                };\r\n            }\r\n            \r\n            // Validate command\r\n            var validation = await handler.ValidateAsync(command, gameState);\r\n            if (!validation.IsValid)\r\n            {\r\n                return new CommandResult\r\n                {\r\n                    Success = false,\r\n                    Type = CommandResultType.RequirementsNotMet,\r\n                    Message = validation.Message\r\n                };\r\n            }\r\n            \r\n            // Execute command\r\n            try\r\n            {\r\n                var result = await handler.ExecuteAsync(command, gameState);\r\n                \r\n                // Update game stats\r\n                gameState.Player.Stats.CommandsExecuted++;\r\n                gameState.World.TurnNumber++;\r\n                \r\n                return result;\r\n            }\r\n            catch (Exception ex)\r\n            {\r\n                _logger.LogError(ex, \"Command execution failed\");\r\n                return new CommandResult\r\n                {\r\n                    Success = false,\r\n                    Type = CommandResultType.Failure,\r\n                    Message = \"Something went wrong. Please try again.\"\r\n                };\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### 3. Command Handlers\r\n\r\n#### Movement Handler\r\n\r\n```csharp\r\npublic class MoveCommandHandler : ICommandHandler\r\n{\r\n    public string Verb => \"go\";\r\n    \r\n    private readonly IGameStateMachine _stateMachine;\r\n    \r\n    public async Task<ValidationResult> ValidateAsync(\r\n        ParsedCommand command,\r\n        GameState gameState)\r\n    {\r\n        if (string.IsNullOrEmpty(command.Object))\r\n        {\r\n            return ValidationResult.Invalid(\r\n                \"Go where? Specify a direction.\");\r\n        }\r\n        \r\n        var currentRoom = _stateMachine.GetCurrentRoom();\r\n        var direction = NormalizeDirection(command.Object);\r\n        \r\n        if (!currentRoom.Exits.TryGetValue(direction, out var targetRoomId))\r\n        {\r\n            return ValidationResult.Invalid(\r\n                $\"You can't go {direction} from here.\");\r\n        }\r\n        \r\n        if (!_stateMachine.CanTransitionTo(targetRoomId))\r\n        {\r\n            return ValidationResult.Invalid(\r\n                \"The way is blocked.\");\r\n        }\r\n        \r\n        return ValidationResult.Valid();\r\n    }\r\n    \r\n    public async Task<CommandResult> ExecuteAsync(\r\n        ParsedCommand command,\r\n        GameState gameState)\r\n    {\r\n        var currentRoom = _stateMachine.GetCurrentRoom();\r\n        var direction = NormalizeDirection(command.Object);\r\n        var targetRoomId = currentRoom.Exits[direction];\r\n        \r\n        _stateMachine.TransitionTo(targetRoomId);\r\n        \r\n        var newRoom = _stateMachine.GetCurrentRoom();\r\n        \r\n        return new CommandResult\r\n        {\r\n            Success = true,\r\n            Type = CommandResultType.Success,\r\n            Message = $\"You move {direction}.\\n\\n{newRoom.Description}\",\r\n            StateChange = new GameStateChange\r\n            {\r\n                LocationChanged = targetRoomId\r\n            }\r\n        };\r\n    }\r\n    \r\n    private string NormalizeDirection(string input)\r\n    {\r\n        return input.ToLower() switch\r\n        {\r\n            \"n\" => \"north\",\r\n            \"s\" => \"south\",\r\n            \"e\" => \"east\",\r\n            \"w\" => \"west\",\r\n            \"u\" or \"upstairs\" => \"up\",\r\n            \"d\" or \"downstairs\" => \"down\",\r\n            _ => input.ToLower()\r\n        };\r\n    }\r\n}\r\n```\r\n\r\n#### Take Item Handler\r\n\r\n```csharp\r\npublic class TakeCommandHandler : ICommandHandler\r\n{\r\n    public string Verb => \"take\";\r\n    \r\n    private readonly IGameStateMachine _stateMachine;\r\n    private readonly IInventoryManager _inventoryManager;\r\n    \r\n    public async Task<ValidationResult> ValidateAsync(\r\n        ParsedCommand command,\r\n        GameState gameState)\r\n    {\r\n        if (string.IsNullOrEmpty(command.Object))\r\n        {\r\n            return ValidationResult.Invalid(\"Take what?\");\r\n        }\r\n        \r\n        var visibleObjects = _stateMachine.GetVisibleObjects();\r\n        var targetObject = visibleObjects\r\n            .FirstOrDefault(o => o.Id.Contains(command.Object) ||\r\n                               o.Name.Contains(command.Object, \r\n                                   StringComparison.OrdinalIgnoreCase));\r\n        \r\n        if (targetObject == null)\r\n        {\r\n            return ValidationResult.Invalid(\r\n                $\"You don't see a {command.Object} here.\");\r\n        }\r\n        \r\n        if (!targetObject.IsCollectable)\r\n        {\r\n            return ValidationResult.Invalid(\r\n                $\"You can't take the {targetObject.Name}.\");\r\n        }\r\n        \r\n        if (!_inventoryManager.CanAdd(targetObject))\r\n        {\r\n            return ValidationResult.Invalid(\r\n                \"You're carrying too much.\");\r\n        }\r\n        \r\n        return ValidationResult.Valid();\r\n    }\r\n    \r\n    public async Task<CommandResult> ExecuteAsync(\r\n        ParsedCommand command,\r\n        GameState gameState)\r\n    {\r\n        var visibleObjects = _stateMachine.GetVisibleObjects();\r\n        var targetObject = visibleObjects\r\n            .First(o => o.Id.Contains(command.Object) ||\r\n                       o.Name.Contains(command.Object,\r\n                           StringComparison.OrdinalIgnoreCase));\r\n        \r\n        // Add to inventory\r\n        _inventoryManager.AddItem(targetObject);\r\n        \r\n        // Remove from room\r\n        var currentRoom = _stateMachine.GetCurrentRoom();\r\n        currentRoom.State.VisibleObjectIds.Remove(targetObject.Id);\r\n        targetObject.IsVisible = false;\r\n        \r\n        // Get action message\r\n        var message = targetObject.Actions\r\n            .GetValueOrDefault(\"take\")?.SuccessMessage\r\n            ?? $\"You take the {targetObject.Name}.\";\r\n        \r\n        // Update stats\r\n        gameState.Player.Stats.ItemsCollected++;\r\n        \r\n        return new CommandResult\r\n        {\r\n            Success = true,\r\n            Type = CommandResultType.Success,\r\n            Message = message,\r\n            StateChange = new GameStateChange\r\n            {\r\n                ItemsAdded = new List<string> { targetObject.Id }\r\n            }\r\n        };\r\n    }\r\n}\r\n```\r\n\r\n#### Use Item Handler\r\n\r\n```csharp\r\npublic class UseCommandHandler : ICommandHandler\r\n{\r\n    public string Verb => \"use\";\r\n    \r\n    private readonly IGameStateMachine _stateMachine;\r\n    private readonly IInventoryManager _inventoryManager;\r\n    private readonly IPuzzleEngine _puzzleEngine;\r\n    \r\n    public async Task<ValidationResult> ValidateAsync(\r\n        ParsedCommand command,\r\n        GameState gameState)\r\n    {\r\n        if (string.IsNullOrEmpty(command.Object))\r\n        {\r\n            return ValidationResult.Invalid(\"Use what?\");\r\n        }\r\n        \r\n        var item = _inventoryManager.GetItem(command.Object);\r\n        if (item == null)\r\n        {\r\n            return ValidationResult.Invalid(\r\n                $\"You don't have a {command.Object}.\");\r\n        }\r\n        \r\n        if (!item.Actions.ContainsKey(\"use\"))\r\n        {\r\n            return ValidationResult.Invalid(\r\n                $\"You can't use the {item.Name} like that.\");\r\n        }\r\n        \r\n        return ValidationResult.Valid();\r\n    }\r\n    \r\n    public async Task<CommandResult> ExecuteAsync(\r\n        ParsedCommand command,\r\n        GameState gameState)\r\n    {\r\n        var item = _inventoryManager.GetItem(command.Object);\r\n        var useAction = item.Actions[\"use\"];\r\n        \r\n        // Check required flags\r\n        if (!CheckRequiredFlags(useAction, gameState))\r\n        {\r\n            return new CommandResult\r\n            {\r\n                Success = false,\r\n                Type = CommandResultType.RequirementsNotMet,\r\n                Message = useAction.FailureMessage\r\n            };\r\n        }\r\n        \r\n        // Apply state changes\r\n        foreach (var stateChange in useAction.StateChanges)\r\n        {\r\n            ApplyStateChange(stateChange, item, gameState);\r\n        }\r\n        \r\n        // Check for puzzle completion\r\n        var puzzleResult = await _puzzleEngine\r\n            .CheckPuzzleCompletionAsync(gameState);\r\n        \r\n        var messages = new List<string> { useAction.SuccessMessage };\r\n        if (puzzleResult.Completed)\r\n        {\r\n            messages.Add(puzzleResult.CompletionMessage);\r\n            gameState.Player.Stats.PuzzlesSolved++;\r\n        }\r\n        \r\n        // Consume item if needed\r\n        if (useAction.ConsumesItem)\r\n        {\r\n            _inventoryManager.RemoveItem(item.Id);\r\n            messages.Add($\"The {item.Name} is used up.\");\r\n        }\r\n        else\r\n        {\r\n            item.State.UsageCount++;\r\n        }\r\n        \r\n        return new CommandResult\r\n        {\r\n            Success = true,\r\n            Type = CommandResultType.Success,\r\n            Message = string.Join(\"\\n\\n\", messages)\r\n        };\r\n    }\r\n    \r\n    private bool CheckRequiredFlags(\r\n        ActionDefinition action,\r\n        GameState gameState)\r\n    {\r\n        foreach (var flag in action.RequiredFlags)\r\n        {\r\n            if (!gameState.Progress.StoryFlags\r\n                .GetValueOrDefault(flag, false))\r\n            {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n    \r\n    private void ApplyStateChange(\r\n        StateChange change,\r\n        GameObject item,\r\n        GameState gameState)\r\n    {\r\n        switch (change.Target)\r\n        {\r\n            case \"self\":\r\n                ApplyToObject(item, change);\r\n                break;\r\n            case \"room\":\r\n                ApplyToRoom(\r\n                    _stateMachine.GetCurrentRoom(),\r\n                    change);\r\n                break;\r\n            default:\r\n                var targetObj = gameState.World.Objects[change.Target];\r\n                ApplyToObject(targetObj, change);\r\n                break;\r\n        }\r\n    }\r\n    \r\n    private void ApplyToObject(GameObject obj, StateChange change)\r\n    {\r\n        var property = obj.GetType().GetProperty(change.Property);\r\n        property?.SetValue(obj, change.NewValue);\r\n    }\r\n    \r\n    private void ApplyToRoom(Room room, StateChange change)\r\n    {\r\n        var property = room.GetType().GetProperty(change.Property);\r\n        property?.SetValue(room, change.NewValue);\r\n    }\r\n}\r\n```\r\n\r\n### 4. Inventory Manager\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Engine\r\n{\r\n    public class InventoryManager : IInventoryManager\r\n    {\r\n        private readonly GameState _gameState;\r\n        private readonly ILogger _logger;\r\n        \r\n        public InventoryManager(\r\n            GameState gameState,\r\n            ILogger<InventoryManager> logger)\r\n        {\r\n            _gameState = gameState;\r\n            _logger = logger;\r\n        }\r\n        \r\n        public bool CanAdd(GameObject item)\r\n        {\r\n            var inventory = _gameState.Player.Inventory;\r\n            return inventory.TotalWeight + item.Weight \r\n                <= inventory.MaxCapacity;\r\n        }\r\n        \r\n        public void AddItem(GameObject item)\r\n        {\r\n            var inventory = _gameState.Player.Inventory;\r\n            \r\n            if (!CanAdd(item))\r\n            {\r\n                throw new InvalidOperationException(\r\n                    \"Inventory is full\");\r\n            }\r\n            \r\n            inventory.Items.Add(item);\r\n            inventory.TotalWeight += item.Weight;\r\n            \r\n            _logger.LogInformation(\r\n                \"Added {Item} to inventory (Weight: {Weight}/{Max})\",\r\n                item.Name, inventory.TotalWeight, inventory.MaxCapacity);\r\n        }\r\n        \r\n        public void RemoveItem(string itemId)\r\n        {\r\n            var inventory = _gameState.Player.Inventory;\r\n            var item = inventory.Items.FirstOrDefault(i => i.Id == itemId);\r\n            \r\n            if (item != null)\r\n            {\r\n                inventory.Items.Remove(item);\r\n                inventory.TotalWeight -= item.Weight;\r\n                \r\n                _logger.LogInformation(\r\n                    \"Removed {Item} from inventory\", item.Name);\r\n            }\r\n        }\r\n        \r\n        public bool HasItem(string itemId)\r\n        {\r\n            return _gameState.Player.Inventory.Items\r\n                .Any(i => i.Id == itemId);\r\n        }\r\n        \r\n        public GameObject GetItem(string itemId)\r\n        {\r\n            return _gameState.Player.Inventory.Items\r\n                .FirstOrDefault(i => i.Id.Contains(itemId) ||\r\n                    i.Name.Contains(itemId, \r\n                        StringComparison.OrdinalIgnoreCase));\r\n        }\r\n        \r\n        public List<GameObject> GetAllItems()\r\n        {\r\n            return _gameState.Player.Inventory.Items.ToList();\r\n        }\r\n        \r\n        public string GetInventoryDescription()\r\n        {\r\n            var inventory = _gameState.Player.Inventory;\r\n            \r\n            if (inventory.Items.Count == 0)\r\n            {\r\n                return \"You're not carrying anything.\";\r\n            }\r\n            \r\n            var items = inventory.Items\r\n                .Select(i => $\"- {i.Name}\")\r\n                .ToList();\r\n            \r\n            return $\"You are carrying:\\n\" +\r\n                   $\"{string.Join(\"\\n\", items)}\\n\\n\" +\r\n                   $\"Total weight: {inventory.TotalWeight}/\" +\r\n                   $\"{inventory.MaxCapacity}\";\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### 5. Puzzle Engine\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Engine\r\n{\r\n    public class PuzzleEngine : IPuzzleEngine\r\n    {\r\n        private readonly ILogger _logger;\r\n        \r\n        public async Task<PuzzleResult> CheckPuzzleCompletionAsync(\r\n            GameState gameState)\r\n        {\r\n            // Check if any puzzle conditions are met\r\n            var completedPuzzles = new List<string>();\r\n            \r\n            // Example: Check if lantern lit in dark room\r\n            if (CheckLanternPuzzle(gameState))\r\n            {\r\n                completedPuzzles.Add(\"lantern_puzzle\");\r\n            }\r\n            \r\n            // Example: Check if all items collected\r\n            if (CheckCollectionPuzzle(gameState))\r\n            {\r\n                completedPuzzles.Add(\"collection_puzzle\");\r\n            }\r\n            \r\n            // Add newly completed puzzles to progress\r\n            var newlyCompleted = completedPuzzles\r\n                .Where(p => !gameState.Progress.CompletedPuzzles.Contains(p))\r\n                .ToList();\r\n            \r\n            if (newlyCompleted.Any())\r\n            {\r\n                gameState.Progress.CompletedPuzzles.AddRange(newlyCompleted);\r\n                \r\n                _logger.LogInformation(\r\n                    \"Puzzles completed: {Puzzles}\",\r\n                    string.Join(\", \", newlyCompleted));\r\n                \r\n                return new PuzzleResult\r\n                {\r\n                    Completed = true,\r\n                    PuzzleId = newlyCompleted.First(),\r\n                    CompletionMessage = GetCompletionMessage(\r\n                        newlyCompleted.First())\r\n                };\r\n            }\r\n            \r\n            return new PuzzleResult { Completed = false };\r\n        }\r\n        \r\n        private bool CheckLanternPuzzle(GameState gameState)\r\n        {\r\n            var currentRoom = gameState.World.Rooms[\r\n                gameState.Player.CurrentLocationId];\r\n            \r\n            if (currentRoom.LightLevel != LightLevel.Dark)\r\n                return false;\r\n            \r\n            var lantern = gameState.Player.Inventory.Items\r\n                .FirstOrDefault(i => i.Type == ObjectType.Light);\r\n            \r\n            return lantern?.State.CurrentState == \"lit\";\r\n        }\r\n        \r\n        private bool CheckCollectionPuzzle(GameState gameState)\r\n        {\r\n            // Example: collect 3 specific items\r\n            var requiredItems = new[] { \"key\", \"map\", \"compass\" };\r\n            var hasAllItems = requiredItems.All(item =>\r\n                gameState.Player.Inventory.Items.Any(i => \r\n                    i.Id.Contains(item)));\r\n            \r\n            return hasAllItems;\r\n        }\r\n        \r\n        private string GetCompletionMessage(string puzzleId)\r\n        {\r\n            return puzzleId switch\r\n            {\r\n                \"lantern_puzzle\" => \r\n                    \"The light reveals a hidden passage!\",\r\n                \"collection_puzzle\" => \r\n                    \"You've gathered everything you need!\",\r\n                _ => \"You've solved a puzzle!\"\r\n            };\r\n        }\r\n    }\r\n    \r\n    public class PuzzleResult\r\n    {\r\n        public bool Completed { get; set; }\r\n        public string PuzzleId { get; set; }\r\n        public string CompletionMessage { get; set; }\r\n    }\r\n}\r\n```\r\n\r\n### 6. Save/Load System\r\n\r\n```csharp\r\nnamespace TheCabin.Domain.Engine\r\n{\r\n    public class SaveGameService\r\n    {\r\n        private readonly IGameSaveRepository _repository;\r\n        private readonly ILogger _logger;\r\n        \r\n        public async Task<int> SaveGameAsync(\r\n            GameState gameState,\r\n            string saveName)\r\n        {\r\n            var saveEntity = new GameSaveEntity\r\n            {\r\n                Name = saveName,\r\n                ThemeId = gameState.World.CurrentThemeId,\r\n                GameStateJson = JsonSerializer.Serialize(gameState),\r\n                Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),\r\n                Version = gameState.Meta.Version,\r\n                PlayTimeMinutes = (int)gameState.Player.Stats.PlayTime\r\n                    .TotalMinutes,\r\n                Thumbnail = await GenerateThumbnailAsync(gameState)\r\n            };\r\n            \r\n            var saveId = await _repository.SaveAsync(saveEntity);\r\n            \r\n            _logger.LogInformation(\r\n                \"Game saved: {Name} (ID: {Id})\", saveName, saveId);\r\n            \r\n            return saveId;\r\n        }\r\n        \r\n        public async Task<GameState> LoadGameAsync(int saveId)\r\n        {\r\n            var saveEntity = await _repository.GetAsync(saveId);\r\n            \r\n            if (saveEntity == null)\r\n            {\r\n                throw new FileNotFoundException(\r\n                    $\"Save game {saveId} not found\");\r\n            }\r\n            \r\n            var gameState = JsonSerializer.Deserialize<GameState>(\r\n                saveEntity.GameStateJson);\r\n            \r\n            _logger.LogInformation(\r\n                \"Game loaded: {Name} (ID: {Id})\",\r\n                saveEntity.Name, saveId);\r\n            \r\n            return gameState;\r\n        }\r\n        \r\n        public async Task<List<GameSaveInfo>> GetSaveListAsync()\r\n        {\r\n            var saves = await _repository.GetAllAsync();\r\n            \r\n            return saves.Select(s => new GameSaveInfo\r\n            {\r\n                Id = s.Id,\r\n                Name = s.Name,\r\n                ThemeId = s.ThemeId,\r\n                Timestamp = DateTimeOffset.FromUnixTimeSeconds(s.Timestamp)\r\n                    .DateTime,\r\n                PlayTime = TimeSpan.FromMinutes(s.PlayTimeMinutes),\r\n                Thumbnail = s.Thumbnail\r\n            }).ToList();\r\n        }\r\n        \r\n        public async Task DeleteSaveAsync(int saveId)\r\n        {\r\n            await _repository.DeleteAsync(saveId);\r\n            _logger.LogInformation(\"Save game deleted: {Id}\", saveId);\r\n        }\r\n        \r\n        private async Task<byte[]> GenerateThumbnailAsync(\r\n            GameState gameState)\r\n        {\r\n            // TODO: Generate screenshot or render current scene\r\n            return Array.Empty<byte>();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Performance Considerations\r\n\r\n### Command Processing Optimization\r\n\r\n```csharp\r\n// Cache frequently accessed game state\r\npublic class GameStateCache\r\n{\r\n    private Room _cachedCurrentRoom;\r\n    private List<GameObject> _cachedVisibleObjects;\r\n    private string _cachedLocationId;\r\n    \r\n    public Room GetCurrentRoom(GameState state)\r\n    {\r\n        if (_cachedLocationId != state.Player.CurrentLocationId)\r\n        {\r\n            _cachedCurrentRoom = state.World.Rooms[\r\n                state.Player.CurrentLocationId];\r\n            _cachedLocationId = state.Player.CurrentLocationId;\r\n        }\r\n        return _cachedCurrentRoom;\r\n    }\r\n    \r\n    public void InvalidateCache()\r\n    {\r\n        _cachedCurrentRoom = null;\r\n        _cachedVisibleObjects = null;\r\n        _cachedLocationId = null;\r\n    }\r\n}\r\n```\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 04-data-models.md, 05-voice-pipeline.md, 09-content-management.md\r\n\n</file_content>\n\n<file_content path=\"docs/07-ui-ux-design.md\">\n# 07 - UI/UX Design\r\n\r\n## Overview\r\n\r\nThis document outlines the user interface and user experience design for The Cabin, focusing on voice-first interaction patterns, visual hierarchy, and accessibility.\r\n\r\n## Design Principles\r\n\r\n1. **Voice-First**: UI supports but doesn't require touch interaction\r\n2. **Minimalist**: Clean, distraction-free interface\r\n3. **Feedback-Rich**: Clear visual and audio feedback\r\n4. **Accessible**: Inclusive design for all users\r\n5. **Immersive**: Support for the narrative experience\r\n\r\n## Screen Layouts\r\n\r\n### Main Game Screen\r\n\r\n```text\r\n┌──────────────────────────────────────────────────────┐\r\n│ ┌──────────────────────────────────────────────────┐ │\r\n│ │  Stats Bar                                       │ │\r\n│ │  🏠 Cabin Main    ❤️ 100    💡 Dim    🕐 3:45  │ │\r\n│ └──────────────────────────────────────────────────┘ │\r\n│                                                      │\r\n│ ┌──────────────────────────────────────────────────┐ │\r\n│ │                                                  │ │\r\n│ │  Story Feed (Scrollable)                         │ │\r\n│ │                                                  │ │\r\n│ │  > You stand in a dimly lit wooden cabin...      │ │\r\n│ │                                                  │ │\r\n│ │  ▶ \"look around\"                                │ │\r\n│ │                                                  │ │\r\n│ │  > The walls are rough-hewn logs. A lantern      │ │\r\n│ │    hangs from a rusty hook.                      │ │\r\n│ │                                                  │ │\r\n│ │  ▶ \"take lantern\"                               │ │\r\n│ │                                                  │ │\r\n│ │  > You pick up the lantern. It feels heavy       │ │\r\n│ │    with oil.                                     │ │\r\n│ │                                                  │ │\r\n│ │                                                  │ │\r\n│ └──────────────────────────────────────────────────┘ │\r\n│                                                      │\r\n│ ┌──────────────────────────────────────────────────┐ │\r\n│ │  Transcript Preview                              │ │\r\n│ │  🎤 \"Take the lantern\"                          │ │\r\n│ └──────────────────────────────────────────────────┘ │\r\n│                                                      │\r\n│         ┌──────────────────────────┐                 │\r\n│         │   🎙️ Voice Button       │                 │\r\n│         │   (Tap to Speak)         │                 │\r\n│         │   ∿∿∿ Waveform ∿∿∿     │                 │\r\n│         └──────────────────────────┘                 │\r\n│                                                      │\r\n│ ┌──────────────────────────────────────────────────┐ │\r\n│ │  [Inventory]  [Menu]  [Settings]                 │ │\r\n│ └──────────────────────────────────────────────────┘ │\r\n└──────────────────────────────────────────────────────┘\r\n```\r\n\r\n### XAML Implementation\r\n\r\n```xaml\r\n<?xml version=\"1.0\" encoding=\"utf-8\" ?>\r\n<ContentPage xmlns=\"http://schemas.microsoft.com/dotnet/2021/maui\"\r\n             xmlns:x=\"http://schemas.microsoft.com/winfx/2009/xaml\"\r\n             xmlns:vm=\"clr-namespace:TheCabin.ViewModels\"\r\n             x:Class=\"TheCabin.Views.MainPage\"\r\n             x:DataType=\"vm:MainViewModel\"\r\n             BackgroundColor=\"{DynamicResource PageBackgroundColor}\">\r\n    \r\n    <Grid RowDefinitions=\"Auto,*,Auto,Auto,Auto\" Padding=\"16\">\r\n        \r\n        <!-- Stats Bar -->\r\n        <Border Grid.Row=\"0\" \r\n                StyleClass=\"StatsBar\"\r\n                Padding=\"12,8\"\r\n                Margin=\"0,0,0,8\">\r\n            <Grid ColumnDefinitions=\"*,Auto,Auto,Auto\">\r\n                <Label Grid.Column=\"0\" \r\n                       Text=\"{Binding CurrentLocation}\"\r\n                       FontSize=\"16\"\r\n                       FontAttributes=\"Bold\"/>\r\n                <HorizontalStackLayout Grid.Column=\"1\" Spacing=\"12\">\r\n                    <Label Text=\"❤️\"/>\r\n                    <Label Text=\"{Binding PlayerHealth}\"/>\r\n                </HorizontalStackLayout>\r\n                <HorizontalStackLayout Grid.Column=\"2\" Spacing=\"12\">\r\n                    <Label Text=\"💡\"/>\r\n                    <Label Text=\"{Binding LightLevel}\"/>\r\n                </HorizontalStackLayout>\r\n                <HorizontalStackLayout Grid.Column=\"3\" Spacing=\"12\">\r\n                    <Label Text=\"🕐\"/>\r\n                    <Label Text=\"{Binding GameTime}\"/>\r\n                </HorizontalStackLayout>\r\n            </Grid>\r\n        </Border>\r\n        \r\n        <!-- Story Feed -->\r\n        <Border Grid.Row=\"1\" \r\n                StyleClass=\"ContentPanel\"\r\n                Padding=\"16\">\r\n            <CollectionView ItemsSource=\"{Binding StoryFeed}\"\r\n                           VerticalScrollBarVisibility=\"Always\">\r\n                <CollectionView.ItemTemplate>\r\n                    <DataTemplate x:DataType=\"models:NarrativeEntry\">\r\n                        <Grid Padding=\"0,8\">\r\n                            <Label Text=\"{Binding Text}\"\r\n                                   TextColor=\"{Binding TextColor}\"\r\n                                   FontSize=\"16\"\r\n                                   LineBreakMode=\"WordWrap\"\r\n                                   FontAttributes=\"{Binding IsImportant, \r\n                                       Converter={StaticResource BoolToFontAttributes}}\"/>\r\n                        </Grid>\r\n                    </DataTemplate>\r\n                </CollectionView.ItemTemplate>\r\n            </CollectionView>\r\n        </Border>\r\n        \r\n        <!-- Transcript Preview -->\r\n        <Border Grid.Row=\"2\"\r\n                StyleClass=\"TranscriptPanel\"\r\n                Padding=\"12\"\r\n                Margin=\"0,8\"\r\n                IsVisible=\"{Binding IsListening}\">\r\n            <HorizontalStackLayout Spacing=\"8\">\r\n                <Label Text=\"🎤\" FontSize=\"16\"/>\r\n                <Label Text=\"{Binding TranscriptText}\"\r\n                       FontSize=\"14\"\r\n                       TextColor=\"{DynamicResource SecondaryTextColor}\"/>\r\n            </HorizontalStackLayout>\r\n        </Border>\r\n        \r\n        <!-- Voice Control -->\r\n        <Grid Grid.Row=\"3\" \r\n              Padding=\"0,16\"\r\n              HorizontalOptions=\"Center\">\r\n            <Button x:Name=\"VoiceButton\"\r\n                    Command=\"{Binding ToggleListeningCommand}\"\r\n                    HeightRequest=\"80\"\r\n                    WidthRequest=\"80\"\r\n                    CornerRadius=\"40\"\r\n                    BackgroundColor=\"{Binding IsListening, \r\n                        Converter={StaticResource BoolToRecordingColor}}\"\r\n                    BorderWidth=\"3\"\r\n                    BorderColor=\"{DynamicResource PrimaryColor}\">\r\n                <Button.ImageSource>\r\n                    <FontImageSource \r\n                        Glyph=\"🎙️\"\r\n                        FontFamily=\"SegoeUIEmoji\"\r\n                        Size=\"32\"\r\n                        Color=\"White\"/>\r\n                </Button.ImageSource>\r\n            </Button>\r\n            \r\n            <!-- Waveform Animation (when listening) -->\r\n            <GraphicsView x:Name=\"WaveformView\"\r\n                         IsVisible=\"{Binding IsListening}\"\r\n                         HeightRequest=\"80\"\r\n                         WidthRequest=\"200\"\r\n                         VerticalOptions=\"Center\"\r\n                         HorizontalOptions=\"Center\"\r\n                         InputTransparent=\"True\"/>\r\n        </Grid>\r\n        \r\n        <!-- Bottom Navigation -->\r\n        <Border Grid.Row=\"4\" \r\n                StyleClass=\"BottomNav\"\r\n                Padding=\"8\">\r\n            <Grid ColumnDefinitions=\"*,*,*\">\r\n                <Button Grid.Column=\"0\"\r\n                        Text=\"🎒 Inventory\"\r\n                        Command=\"{Binding ShowInventoryCommand}\"\r\n                        StyleClass=\"NavButton\"/>\r\n                <Button Grid.Column=\"1\"\r\n                        Text=\"📖 Menu\"\r\n                        Command=\"{Binding ShowMenuCommand}\"\r\n                        StyleClass=\"NavButton\"/>\r\n                <Button Grid.Column=\"2\"\r\n                        Text=\"⚙️ Settings\"\r\n                        Command=\"{Binding ShowSettingsCommand}\"\r\n                        StyleClass=\"NavButton\"/>\r\n            </Grid>\r\n        </Border>\r\n        \r\n    </Grid>\r\n</ContentPage>\r\n```\r\n\r\n## Component Details\r\n\r\n### 1. Voice Control Button\r\n\r\n```csharp\r\npublic partial class MainPage : ContentPage\r\n{\r\n    private readonly WaveformAnimator _waveformAnimator;\r\n    \r\n    public MainPage(MainViewModel viewModel)\r\n    {\r\n        InitializeComponent();\r\n        BindingContext = viewModel;\r\n        \r\n        _waveformAnimator = new WaveformAnimator(WaveformView);\r\n        \r\n        viewModel.PropertyChanged += OnViewModelPropertyChanged;\r\n    }\r\n    \r\n    private void OnViewModelPropertyChanged(object sender, \r\n        PropertyChangedEventArgs e)\r\n    {\r\n        if (e.PropertyName == nameof(MainViewModel.IsListening))\r\n        {\r\n            var vm = (MainViewModel)BindingContext;\r\n            if (vm.IsListening)\r\n            {\r\n                _waveformAnimator.Start();\r\n                VoiceButton.Scale = 1.1;\r\n            }\r\n            else\r\n            {\r\n                _waveformAnimator.Stop();\r\n                VoiceButton.Scale = 1.0;\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### 2. Waveform Animation\r\n\r\n```csharp\r\npublic class WaveformAnimator\r\n{\r\n    private readonly GraphicsView _graphicsView;\r\n    private readonly WaveformDrawable _drawable;\r\n    private IDispatcherTimer _timer;\r\n    \r\n    public WaveformAnimator(GraphicsView graphicsView)\r\n    {\r\n        _graphicsView = graphicsView;\r\n        _drawable = new WaveformDrawable();\r\n        _graphicsView.Drawable = _drawable;\r\n    }\r\n    \r\n    public void Start()\r\n    {\r\n        _timer = Dispatcher.CreateTimer();\r\n        _timer.Interval = TimeSpan.FromMilliseconds(50);\r\n        _timer.Tick += (s, e) =>\r\n        {\r\n            _drawable.Update();\r\n            _graphicsView.Invalidate();\r\n        };\r\n        _timer.Start();\r\n    }\r\n    \r\n    public void Stop()\r\n    {\r\n        _timer?.Stop();\r\n        _drawable.Reset();\r\n        _graphicsView.Invalidate();\r\n    }\r\n}\r\n\r\npublic class WaveformDrawable : IDrawable\r\n{\r\n    private readonly List<float> _amplitudes = new();\r\n    private readonly Random _random = new();\r\n    \r\n    public void Draw(ICanvas canvas, RectF dirtyRect)\r\n    {\r\n        canvas.StrokeColor = Colors.White;\r\n        canvas.StrokeSize = 3;\r\n        \r\n        var centerY = dirtyRect.Height / 2;\r\n        var barWidth = 4f;\r\n        var spacing = 6f;\r\n        var barCount = (int)(dirtyRect.Width / (barWidth + spacing));\r\n        \r\n        for (int i = 0; i < barCount && i < _amplitudes.Count; i++)\r\n        {\r\n            var x = i * (barWidth + spacing);\r\n            var amplitude = _amplitudes[i];\r\n            var height = amplitude * (dirtyRect.Height / 2);\r\n            \r\n            canvas.DrawLine(\r\n                x, centerY - height,\r\n                x, centerY + height);\r\n        }\r\n    }\r\n    \r\n    public void Update()\r\n    {\r\n        // Simulate audio amplitude\r\n        if (_amplitudes.Count > 30)\r\n            _amplitudes.RemoveAt(0);\r\n        \r\n        _amplitudes.Add((float)_random.NextDouble());\r\n    }\r\n    \r\n    public void Reset()\r\n    {\r\n        _amplitudes.Clear();\r\n    }\r\n}\r\n```\r\n\r\n### 3. Narrative Text Styling\r\n\r\n```xaml\r\n<!-- App.xaml Resource Dictionary -->\r\n<Style TargetType=\"Label\" x:Key=\"NarrativeText\">\r\n    <Setter Property=\"FontFamily\" Value=\"Georgia\"/>\r\n    <Setter Property=\"FontSize\" Value=\"16\"/>\r\n    <Setter Property=\"LineHeight\" Value=\"1.5\"/>\r\n    <Setter Property=\"TextColor\" Value=\"{DynamicResource PrimaryTextColor}\"/>\r\n</Style>\r\n\r\n<Style TargetType=\"Label\" x:Key=\"PlayerCommandText\">\r\n    <Setter Property=\"FontFamily\" Value=\"Courier\"/>\r\n    <Setter Property=\"FontSize\" Value=\"14\"/>\r\n    <Setter Property=\"TextColor\" Value=\"{DynamicResource AccentColor}\"/>\r\n    <Setter Property=\"Margin\" Value=\"16,8,0,8\"/>\r\n</Style>\r\n\r\n<Style TargetType=\"Label\" x:Key=\"SystemMessageText\">\r\n    <Setter Property=\"FontFamily\" Value=\"Arial\"/>\r\n    <Setter Property=\"FontSize\" Value=\"14\"/>\r\n    <Setter Property=\"FontAttributes\" Value=\"Italic\"/>\r\n    <Setter Property=\"TextColor\" Value=\"{DynamicResource SecondaryTextColor}\"/>\r\n</Style>\r\n```\r\n\r\n### 4. Inventory Screen\r\n\r\n```xaml\r\n<ContentPage xmlns=\"http://schemas.microsoft.com/dotnet/2021/maui\"\r\n             xmlns:x=\"http://schemas.microsoft.com/winfx/2009/xaml\"\r\n             x:Class=\"TheCabin.Views.InventoryPage\"\r\n             Title=\"Inventory\">\r\n    \r\n    <Grid RowDefinitions=\"Auto,*,Auto\" Padding=\"16\">\r\n        \r\n        <!-- Header -->\r\n        <Border Grid.Row=\"0\" \r\n                Padding=\"16\"\r\n                Margin=\"0,0,0,16\">\r\n            <Grid ColumnDefinitions=\"*,Auto\">\r\n                <Label Grid.Column=\"0\"\r\n                       Text=\"Your Inventory\"\r\n                       FontSize=\"24\"\r\n                       FontAttributes=\"Bold\"/>\r\n                <Label Grid.Column=\"1\"\r\n                       Text=\"{Binding WeightDisplay}\"\r\n                       FontSize=\"14\"\r\n                       VerticalOptions=\"End\"/>\r\n            </Grid>\r\n        </Border>\r\n        \r\n        <!-- Item List -->\r\n        <CollectionView Grid.Row=\"1\"\r\n                       ItemsSource=\"{Binding InventoryItems}\">\r\n            <CollectionView.ItemTemplate>\r\n                <DataTemplate>\r\n                    <SwipeView>\r\n                        <SwipeView.RightItems>\r\n                            <SwipeItems>\r\n                                <SwipeItem Text=\"Drop\"\r\n                                          BackgroundColor=\"DarkRed\"\r\n                                          Command=\"{Binding DropItemCommand}\"\r\n                                          CommandParameter=\"{Binding .}\"/>\r\n                                <SwipeItem Text=\"Use\"\r\n                                          BackgroundColor=\"DarkGreen\"\r\n                                          Command=\"{Binding UseItemCommand}\"\r\n                                          CommandParameter=\"{Binding .}\"/>\r\n                            </SwipeItems>\r\n                        </SwipeView.RightItems>\r\n                        \r\n                        <Border Padding=\"16\"\r\n                                Margin=\"0,4\"\r\n                                StyleClass=\"ItemCard\">\r\n                            <Grid ColumnDefinitions=\"Auto,*,Auto\">\r\n                                <Label Grid.Column=\"0\"\r\n                                       Text=\"{Binding Icon}\"\r\n                                       FontSize=\"24\"\r\n                                       Margin=\"0,0,12,0\"/>\r\n                                <VerticalStackLayout Grid.Column=\"1\">\r\n                                    <Label Text=\"{Binding Name}\"\r\n                                           FontSize=\"16\"\r\n                                           FontAttributes=\"Bold\"/>\r\n                                    <Label Text=\"{Binding Description}\"\r\n                                           FontSize=\"12\"\r\n                                           TextColor=\"{DynamicResource SecondaryTextColor}\"/>\r\n                                </VerticalStackLayout>\r\n                                <Label Grid.Column=\"2\"\r\n                                       Text=\"{Binding Weight, StringFormat='{0} kg'}\"\r\n                                       FontSize=\"12\"\r\n                                       VerticalOptions=\"Center\"/>\r\n                            </Grid>\r\n                        </Border>\r\n                    </SwipeView>\r\n                </DataTemplate>\r\n            </CollectionView.ItemTemplate>\r\n            \r\n            <CollectionView.EmptyView>\r\n                <VerticalStackLayout Padding=\"32\"\r\n                                    HorizontalOptions=\"Center\"\r\n                                    VerticalOptions=\"Center\">\r\n                    <Label Text=\"🎒\"\r\n                           FontSize=\"64\"\r\n                           HorizontalOptions=\"Center\"/>\r\n                    <Label Text=\"Your inventory is empty\"\r\n                           FontSize=\"16\"\r\n                           HorizontalOptions=\"Center\"\r\n                           Margin=\"0,16,0,0\"/>\r\n                </VerticalStackLayout>\r\n            </CollectionView.EmptyView>\r\n        </CollectionView>\r\n        \r\n        <!-- Close Button -->\r\n        <Button Grid.Row=\"2\"\r\n                Text=\"Close\"\r\n                Command=\"{Binding CloseCommand}\"\r\n                Margin=\"0,16,0,0\"/>\r\n    </Grid>\r\n</ContentPage>\r\n```\r\n\r\n### 5. Settings Screen\r\n\r\n```xaml\r\n<ContentPage xmlns=\"http://schemas.microsoft.com/dotnet/2021/maui\"\r\n             xmlns:x=\"http://schemas.microsoft.com/winfx/2009/xaml\"\r\n             x:Class=\"TheCabin.Views.SettingsPage\"\r\n             Title=\"Settings\">\r\n    \r\n    <ScrollView Padding=\"16\">\r\n        <VerticalStackLayout Spacing=\"24\">\r\n            \r\n            <!-- Voice Settings -->\r\n            <Border Padding=\"16\" StyleClass=\"SettingsSection\">\r\n                <VerticalStackLayout Spacing=\"16\">\r\n                    <Label Text=\"Voice Recognition\"\r\n                           FontSize=\"18\"\r\n                           FontAttributes=\"Bold\"/>\r\n                    \r\n                    <Grid ColumnDefinitions=\"*,Auto\">\r\n                        <Label Grid.Column=\"0\" \r\n                               Text=\"Push-to-Talk Mode\"\r\n                               VerticalOptions=\"Center\"/>\r\n                        <Switch Grid.Column=\"1\"\r\n                               IsToggled=\"{Binding UsePushToTalk}\"/>\r\n                    </Grid>\r\n                    \r\n                    <Label Text=\"Confidence Threshold\"/>\r\n                    <Slider Minimum=\"0.5\"\r\n                           Maximum=\"1.0\"\r\n                           Value=\"{Binding ConfidenceThreshold}\"/>\r\n                    \r\n                    <Grid ColumnDefinitions=\"*,Auto\">\r\n                        <Label Grid.Column=\"0\"\r\n                               Text=\"Offline Mode\"\r\n                               VerticalOptions=\"Center\"/>\r\n                        <Switch Grid.Column=\"1\"\r\n                               IsToggled=\"{Binding OfflineMode}\"/>\r\n                    </Grid>\r\n                </VerticalStackLayout>\r\n            </Border>\r\n            \r\n            <!-- Text-to-Speech Settings -->\r\n            <Border Padding=\"16\" StyleClass=\"SettingsSection\">\r\n                <VerticalStackLayout Spacing=\"16\">\r\n                    <Label Text=\"Text-to-Speech\"\r\n                           FontSize=\"18\"\r\n                           FontAttributes=\"Bold\"/>\r\n                    \r\n                    <Grid ColumnDefinitions=\"*,Auto\">\r\n                        <Label Grid.Column=\"0\"\r\n                               Text=\"Enable Narration\"\r\n                               VerticalOptions=\"Center\"/>\r\n                        <Switch Grid.Column=\"1\"\r\n                               IsToggled=\"{Binding TtsEnabled}\"/>\r\n                    </Grid>\r\n                    \r\n                    <Label Text=\"Speech Rate\"/>\r\n                    <Slider Minimum=\"0.5\"\r\n                           Maximum=\"2.0\"\r\n                           Value=\"{Binding SpeechRate}\"/>\r\n                    \r\n                    <Label Text=\"Voice Pitch\"/>\r\n                    <Slider Minimum=\"0.5\"\r\n                           Maximum=\"2.0\"\r\n                           Value=\"{Binding VoicePitch}\"/>\r\n                </VerticalStackLayout>\r\n            </Border>\r\n            \r\n            <!-- Display Settings -->\r\n            <Border Padding=\"16\" StyleClass=\"SettingsSection\">\r\n                <VerticalStackLayout Spacing=\"16\">\r\n                    <Label Text=\"Display\"\r\n                           FontSize=\"18\"\r\n                           FontAttributes=\"Bold\"/>\r\n                    \r\n                    <Label Text=\"Font Size\"/>\r\n                    <Slider Minimum=\"12\"\r\n                           Maximum=\"24\"\r\n                           Value=\"{Binding FontSize}\"/>\r\n                    \r\n                    <Label Text=\"Theme\"/>\r\n                    <Picker ItemsSource=\"{Binding AvailableThemes}\"\r\n                           SelectedItem=\"{Binding SelectedTheme}\"/>\r\n                </VerticalStackLayout>\r\n            </Border>\r\n            \r\n            <!-- About -->\r\n            <Border Padding=\"16\" StyleClass=\"SettingsSection\">\r\n                <VerticalStackLayout Spacing=\"8\">\r\n                    <Label Text=\"About\"\r\n                           FontSize=\"18\"\r\n                           FontAttributes=\"Bold\"/>\r\n                    <Label Text=\"{Binding AppVersion}\"\r\n                           FontSize=\"12\"/>\r\n                    <Label Text=\"© 2025 The Cabin\"\r\n                           FontSize=\"12\"/>\r\n                </VerticalStackLayout>\r\n            </Border>\r\n            \r\n        </VerticalStackLayout>\r\n    </ScrollView>\r\n</ContentPage>\r\n```\r\n\r\n## Theme System\r\n\r\n### Color Schemes\r\n\r\n```xml\r\n<!-- Light Theme -->\r\n<ResourceDictionary>\r\n    <Color x:Key=\"PageBackgroundColor\">#F5F5F5</Color>\r\n    <Color x:Key=\"PrimaryTextColor\">#212121</Color>\r\n    <Color x:Key=\"SecondaryTextColor\">#757575</Color>\r\n    <Color x:Key=\"PrimaryColor\">#2196F3</Color>\r\n    <Color x:Key=\"AccentColor\">#FF5722</Color>\r\n    <Color x:Key=\"CardBackgroundColor\">#FFFFFF</Color>\r\n    <Color x:Key=\"RecordingColor\">#F44336</Color>\r\n</ResourceDictionary>\r\n\r\n<!-- Dark Theme -->\r\n<ResourceDictionary>\r\n    <Color x:Key=\"PageBackgroundColor\">#121212</Color>\r\n    <Color x:Key=\"PrimaryTextColor\">#E0E0E0</Color>\r\n    <Color x:Key=\"SecondaryTextColor\">#9E9E9E</Color>\r\n    <Color x:Key=\"PrimaryColor\">#2196F3</Color>\r\n    <Color x:Key=\"AccentColor\">#FF5722</Color>\r\n    <Color x:Key=\"CardBackgroundColor\">#1E1E1E</Color>\r\n    <Color x:Key=\"RecordingColor\">#F44336</Color>\r\n</ResourceDictionary>\r\n```\r\n\r\n## Accessibility Features\r\n\r\n### 1. Screen Reader Support\r\n\r\n```csharp\r\npublic void ConfigureAccessibility()\r\n{\r\n    // Set semantic descriptions\r\n    VoiceButton.SetValue(SemanticProperties.DescriptionProperty,\r\n        \"Tap to speak a command\");\r\n    \r\n    VoiceButton.SetValue(SemanticProperties.HintProperty,\r\n        \"Records your voice command for the game\");\r\n    \r\n    // Announce state changes\r\n    SemanticScreenReader.Announce(\r\n        \"Voice recording started\");\r\n}\r\n```\r\n\r\n### 2. High Contrast Mode\r\n\r\n```csharp\r\npublic class AccessibilityService\r\n{\r\n    public bool IsHighContrastEnabled()\r\n    {\r\n        return Preferences.Get(\"high_contrast\", false);\r\n    }\r\n    \r\n    public void ApplyHighContrast()\r\n    {\r\n        Application.Current.Resources[\"PrimaryTextColor\"] = \r\n            Colors.White;\r\n        Application.Current.Resources[\"PageBackgroundColor\"] = \r\n            Colors.Black;\r\n    }\r\n}\r\n```\r\n\r\n### 3. Font Scaling\r\n\r\n```csharp\r\npublic double GetScaledFontSize(double baseSize)\r\n{\r\n    var scale = Preferences.Get(\"font_scale\", 1.0);\r\n    return baseSize * scale;\r\n}\r\n```\r\n\r\n## Animations and Transitions\r\n\r\n### Page Transitions\r\n\r\n```csharp\r\npublic async Task NavigateWithTransitionAsync(Page page)\r\n{\r\n    page.Opacity = 0;\r\n    await Navigation.PushAsync(page, false);\r\n    await page.FadeTo(1, 250, Easing.CubicInOut);\r\n}\r\n```\r\n\r\n### Button Press Feedback\r\n\r\n```csharp\r\nprivate async void OnButtonPressed(object sender, EventArgs e)\r\n{\r\n    var button = (Button)sender;\r\n    await button.ScaleTo(0.95, 50);\r\n    await button.ScaleTo(1.0, 50);\r\n}\r\n```\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 02-system-architecture.md, 08-maui-implementation.md\r\n\n</file_content>\n\n<file_content path=\"docs/08-maui-implementation.md\">\n# 08 - MAUI Implementation\r\n\r\n## Overview\r\n\r\nThis document provides detailed implementation guidance for The Cabin using .NET MAUI, including project structure, platform-specific code, and best practices.\r\n\r\n## Project Structure\r\n\r\n```text\r\nTheCabin/\r\n├── TheCabin.csproj\r\n├── App.xaml\r\n├── App.xaml.cs\r\n├── AppShell.xaml\r\n├── AppShell.xaml.cs\r\n├── MauiProgram.cs\r\n│\r\n├── Models/\r\n│   ├── Domain/\r\n│   │   ├── Room.cs\r\n│   │   ├── GameObject.cs\r\n│   │   ├── Player.cs\r\n│   │   └── GameState.cs\r\n│   ├── Services/\r\n│   │   ├── VoiceRecognitionResult.cs\r\n│   │   └── ParsedCommand.cs\r\n│   └── UI/\r\n│       └── NarrativeEntry.cs\r\n│\r\n├── ViewModels/\r\n│   ├── BaseViewModel.cs\r\n│   ├── MainViewModel.cs\r\n│   ├── InventoryViewModel.cs\r\n│   ├── SettingsViewModel.cs\r\n│   └── StoryPackViewModel.cs\r\n│\r\n├── Views/\r\n│   ├── MainPage.xaml\r\n│   ├── MainPage.xaml.cs\r\n│   ├── InventoryPage.xaml\r\n│   ├── InventoryPage.xaml.cs\r\n│   ├── SettingsPage.xaml\r\n│   └── SettingsPage.xaml.cs\r\n│\r\n├── Services/\r\n│   ├── Interfaces/\r\n│   │   ├── IVoiceRecognitionService.cs\r\n│   │   ├── ITextToSpeechService.cs\r\n│   │   ├── ICommandParserService.cs\r\n│   │   └── IGameStateService.cs\r\n│   └── Implementation/\r\n│       ├── CommandParserService.cs\r\n│       ├── GameStateService.cs\r\n│       └── StoryPackService.cs\r\n│\r\n├── Engine/\r\n│   ├── GameStateMachine.cs\r\n│   ├── CommandRouter.cs\r\n│   ├── CommandHandlers/\r\n│   │   ├── MoveCommandHandler.cs\r\n│   │   ├── TakeCommandHandler.cs\r\n│   │   └── UseCommandHandler.cs\r\n│   ├── InventoryManager.cs\r\n│   └── PuzzleEngine.cs\r\n│\r\n├── Data/\r\n│   ├── Repositories/\r\n│   │   ├── GameSaveRepository.cs\r\n│   │   ├── StoryPackRepository.cs\r\n│   │   └── CommandCacheRepository.cs\r\n│   └── Entities/\r\n│       ├── GameSaveEntity.cs\r\n│       └── CommandCacheEntity.cs\r\n│\r\n├── Platforms/\r\n│   ├── Android/\r\n│   │   ├── MainActivity.cs\r\n│   │   ├── MainApplication.cs\r\n│   │   ├── AndroidManifest.xml\r\n│   │   └── Services/\r\n│   │       ├── AndroidVoiceRecognitionService.cs\r\n│   │       └── AndroidTtsService.cs\r\n│   ├── iOS/ (future)\r\n│   └── Windows/ (future)\r\n│\r\n├── Resources/\r\n│   ├── Fonts/\r\n│   ├── Images/\r\n│   ├── Raw/\r\n│   └── Styles/\r\n│       ├── Colors.xaml\r\n│       └── Styles.xaml\r\n│\r\n└── Assets/\r\n    └── StoryPacks/\r\n        ├── classic_horror.json\r\n        ├── arctic_survival.json\r\n        └── ...\r\n```\r\n\r\n## MauiProgram.cs Setup\r\n\r\n```csharp\r\nusing Microsoft.Extensions.Logging;\r\nusing TheCabin.ViewModels;\r\nusing TheCabin.Views;\r\nusing TheCabin.Services;\r\nusing TheCabin.Engine;\r\nusing CommunityToolkit.Maui;\r\n\r\nnamespace TheCabin;\r\n\r\npublic static class MauiProgram\r\n{\r\n    public static MauiApp CreateMauiApp()\r\n    {\r\n        var builder = MauiApp.CreateBuilder();\r\n        \r\n        builder\r\n            .UseMauiApp<App>()\r\n            .UseMauiCommunityToolkit()\r\n            .ConfigureFonts(fonts =>\r\n            {\r\n                fonts.AddFont(\"OpenSans-Regular.ttf\", \"OpenSansRegular\");\r\n                fonts.AddFont(\"OpenSans-Semibold.ttf\", \"OpenSansSemibold\");\r\n                fonts.AddFont(\"Georgia.ttf\", \"Georgia\");\r\n                fonts.AddFont(\"Courier.ttf\", \"Courier\");\r\n            });\r\n\r\n#if DEBUG\r\n        builder.Logging.AddDebug();\r\n#endif\r\n\r\n        // Register Services\r\n        RegisterServices(builder.Services);\r\n        \r\n        // Register ViewModels\r\n        RegisterViewModels(builder.Services);\r\n        \r\n        // Register Views\r\n        RegisterViews(builder.Services);\r\n        \r\n        // Register Engine Components\r\n        RegisterEngineComponents(builder.Services);\r\n        \r\n        // Register Data Access\r\n        RegisterDataAccess(builder.Services);\r\n\r\n        return builder.Build();\r\n    }\r\n    \r\n    private static void RegisterServices(IServiceCollection services)\r\n    {\r\n        // Platform Services\r\n#if ANDROID\r\n        services.AddSingleton<IVoiceRecognitionService, \r\n            Platforms.Android.Services.AndroidVoiceRecognitionService>();\r\n#endif\r\n        \r\n        // Core Services\r\n        services.AddSingleton<ITextToSpeechService, MauiTtsService>();\r\n        services.AddSingleton<ICommandParserService, LlmCommandParserService>();\r\n        services.AddSingleton<IGameStateService, GameStateService>();\r\n        services.AddSingleton<IStoryPackService, StoryPackService>();\r\n        services.AddSingleton<ISettingsService, SettingsService>();\r\n        \r\n        // HTTP Client for LLM API\r\n        services.AddHttpClient<ILlmApiClient, OpenAIApiClient>(client =>\r\n        {\r\n            client.BaseAddress = new Uri(\"https://api.openai.com/\");\r\n            client.Timeout = TimeSpan.FromSeconds(30);\r\n        });\r\n        \r\n        // Memory Cache\r\n        services.AddMemoryCache();\r\n        \r\n        // Logging\r\n        services.AddLogging(config =>\r\n        {\r\n            config.AddConsole();\r\n            config.SetMinimumLevel(LogLevel.Information);\r\n        });\r\n    }\r\n    \r\n    private static void RegisterViewModels(IServiceCollection services)\r\n    {\r\n        services.AddTransient<MainViewModel>();\r\n        services.AddTransient<InventoryViewModel>();\r\n        services.AddTransient<SettingsViewModel>();\r\n        services.AddTransient<StoryPackViewModel>();\r\n        services.AddTransient<LoadGameViewModel>();\r\n    }\r\n    \r\n    private static void RegisterViews(IServiceCollection services)\r\n    {\r\n        services.AddTransient<MainPage>();\r\n        services.AddTransient<InventoryPage>();\r\n        services.AddTransient<SettingsPage>();\r\n        services.AddTransient<StoryPackSelectorPage>();\r\n        services.AddTransient<LoadGamePage>();\r\n    }\r\n    \r\n    private static void RegisterEngineComponents(IServiceCollection services)\r\n    {\r\n        services.AddSingleton<GameStateMachine>();\r\n        services.AddSingleton<CommandRouter>();\r\n        services.AddSingleton<IInventoryManager, InventoryManager>();\r\n        services.AddSingleton<IPuzzleEngine, PuzzleEngine>();\r\n        \r\n        // Command Handlers\r\n        services.AddTransient<ICommandHandler, MoveCommandHandler>();\r\n        services.AddTransient<ICommandHandler, TakeCommandHandler>();\r\n        services.AddTransient<ICommandHandler, DropCommandHandler>();\r\n        services.AddTransient<ICommandHandler, UseCommandHandler>();\r\n        services.AddTransient<ICommandHandler, LookCommandHandler>();\r\n        services.AddTransient<ICommandHandler, ExamineCommandHandler>();\r\n        services.AddTransient<ICommandHandler, InventoryCommandHandler>();\r\n    }\r\n    \r\n    private static void RegisterDataAccess(IServiceCollection services)\r\n    {\r\n        services.AddSingleton<IGameSaveRepository, GameSaveRepository>();\r\n        services.AddSingleton<IStoryPackRepository, StoryPackRepository>();\r\n        services.AddSingleton<ICommandCacheRepository, CommandCacheRepository>();\r\n        \r\n        // Initialize Database\r\n        services.AddSingleton(sp =>\r\n        {\r\n            var dbPath = Path.Combine(\r\n                FileSystem.AppDataDirectory, \r\n                \"thecabin.db3\");\r\n            return new SQLiteAsyncConnection(dbPath);\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n## App.xaml and App.xaml.cs\r\n\r\n```xaml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\r\n<Application xmlns=\"http://schemas.microsoft.com/dotnet/2021/maui\"\r\n             xmlns:x=\"http://schemas.microsoft.com/winfx/2009/xaml\"\r\n             x:Class=\"TheCabin.App\">\r\n    <Application.Resources>\r\n        <ResourceDictionary>\r\n            <ResourceDictionary.MergedDictionaries>\r\n                <ResourceDictionary Source=\"Resources/Styles/Colors.xaml\" />\r\n                <ResourceDictionary Source=\"Resources/Styles/Styles.xaml\" />\r\n            </ResourceDictionary.MergedDictionaries>\r\n        </ResourceDictionary>\r\n    </Application.Resources>\r\n</Application>\r\n```\r\n\r\n```csharp\r\nnamespace TheCabin;\r\n\r\npublic partial class App : Application\r\n{\r\n    public App()\r\n    {\r\n        InitializeComponent();\r\n        \r\n        // Set user app theme\r\n        UserAppTheme = AppTheme.Dark;\r\n        \r\n        MainPage = new AppShell();\r\n    }\r\n    \r\n    protected override Window CreateWindow(IActivationState activationState)\r\n    {\r\n        var window = base.CreateWindow(activationState);\r\n        \r\n        // Set window size (for desktop)\r\n        window.Width = 400;\r\n        window.Height = 800;\r\n        window.MinimumWidth = 350;\r\n        window.MinimumHeight = 600;\r\n        \r\n        return window;\r\n    }\r\n}\r\n```\r\n\r\n## AppShell.xaml\r\n\r\n```xaml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\r\n<Shell\r\n    x:Class=\"TheCabin.AppShell\"\r\n    xmlns=\"http://schemas.microsoft.com/dotnet/2021/maui\"\r\n    xmlns:x=\"http://schemas.microsoft.com/winfx/2009/xaml\"\r\n    xmlns:local=\"clr-namespace:TheCabin.Views\"\r\n    Shell.FlyoutBehavior=\"Disabled\"\r\n    Shell.NavBarIsVisible=\"False\">\r\n\r\n    <ShellContent\r\n        Title=\"The Cabin\"\r\n        ContentTemplate=\"{DataTemplate local:MainPage}\"\r\n        Route=\"MainPage\" />\r\n\r\n</Shell>\r\n```\r\n\r\n## BaseViewModel Implementation\r\n\r\n```csharp\r\nusing CommunityToolkit.Mvvm.ComponentModel;\r\nusing CommunityToolkit.Mvvm.Input;\r\n\r\nnamespace TheCabin.ViewModels;\r\n\r\npublic partial class BaseViewModel : ObservableObject\r\n{\r\n    [ObservableProperty]\r\n    private bool isBusy;\r\n    \r\n    [ObservableProperty]\r\n    private string title;\r\n    \r\n    [ObservableProperty]\r\n    private string errorMessage;\r\n    \r\n    public BaseViewModel()\r\n    {\r\n        title = string.Empty;\r\n        errorMessage = string.Empty;\r\n    }\r\n    \r\n    protected async Task ExecuteAsync(\r\n        Func<Task> operation, \r\n        string? errorMessage = null)\r\n    {\r\n        try\r\n        {\r\n            IsBusy = true;\r\n            ErrorMessage = string.Empty;\r\n            \r\n            await operation();\r\n        }\r\n        catch (Exception ex)\r\n        {\r\n            ErrorMessage = errorMessage ?? ex.Message;\r\n            await ShowErrorAsync(ErrorMessage);\r\n        }\r\n        finally\r\n        {\r\n            IsBusy = false;\r\n        }\r\n    }\r\n    \r\n    protected async Task ShowErrorAsync(string message)\r\n    {\r\n        await Shell.Current.DisplayAlert(\r\n            \"Error\", \r\n            message, \r\n            \"OK\");\r\n    }\r\n    \r\n    protected async Task<bool> ShowConfirmAsync(\r\n        string title,\r\n        string message)\r\n    {\r\n        return await Shell.Current.DisplayAlert(\r\n            title, \r\n            message, \r\n            \"Yes\", \r\n            \"No\");\r\n    }\r\n}\r\n```\r\n\r\n## MainViewModel Implementation\r\n\r\n```csharp\r\nusing CommunityToolkit.Mvvm.ComponentModel;\r\nusing CommunityToolkit.Mvvm.Input;\r\nusing System.Collections.ObjectModel;\r\n\r\nnamespace TheCabin.ViewModels;\r\n\r\npublic partial class MainViewModel : BaseViewModel\r\n{\r\n    private readonly IVoiceRecognitionService _voiceService;\r\n    private readonly ICommandParserService _parserService;\r\n    private readonly IGameStateService _gameStateService;\r\n    private readonly ITextToSpeechService _ttsService;\r\n    private readonly GameStateMachine _stateMachine;\r\n    private readonly CommandRouter _commandRouter;\r\n    \r\n    [ObservableProperty]\r\n    private ObservableCollection<NarrativeEntry> storyFeed;\r\n    \r\n    [ObservableProperty]\r\n    private string currentLocation;\r\n    \r\n    [ObservableProperty]\r\n    private int playerHealth;\r\n    \r\n    [ObservableProperty]\r\n    private string lightLevel;\r\n    \r\n    [ObservableProperty]\r\n    private string gameTime;\r\n    \r\n    [ObservableProperty]\r\n    private string transcriptText;\r\n    \r\n    [ObservableProperty]\r\n    private bool isListening;\r\n    \r\n    [ObservableProperty]\r\n    private bool isProcessing;\r\n    \r\n    public MainViewModel(\r\n        IVoiceRecognitionService voiceService,\r\n        ICommandParserService parserService,\r\n        IGameStateService gameStateService,\r\n        ITextToSpeechService ttsService,\r\n        GameStateMachine stateMachine,\r\n        CommandRouter commandRouter)\r\n    {\r\n        _voiceService = voiceService;\r\n        _parserService = parserService;\r\n        _gameStateService = gameStateService;\r\n        _ttsService = ttsService;\r\n        _stateMachine = stateMachine;\r\n        _commandRouter = commandRouter;\r\n        \r\n        StoryFeed = new ObservableCollection<NarrativeEntry>();\r\n        \r\n        Title = \"The Cabin\";\r\n        CurrentLocation = \"Unknown\";\r\n        PlayerHealth = 100;\r\n        LightLevel = \"Normal\";\r\n        GameTime = \"0:00\";\r\n    }\r\n    \r\n    [RelayCommand]\r\n    private async Task ToggleListeningAsync()\r\n    {\r\n        if (IsListening)\r\n        {\r\n            _voiceService.StopListening();\r\n            IsListening = false;\r\n        }\r\n        else\r\n        {\r\n            await StartListeningAsync();\r\n        }\r\n    }\r\n    \r\n    private async Task StartListeningAsync()\r\n    {\r\n        await ExecuteAsync(async () =>\r\n        {\r\n            IsListening = true;\r\n            TranscriptText = \"Listening...\";\r\n            \r\n            var result = await _voiceService.RecognizeSpeechAsync();\r\n            \r\n            IsListening = false;\r\n            \r\n            if (result.Success)\r\n            {\r\n                TranscriptText = result.TranscribedText;\r\n                await ProcessCommandAsync(result.TranscribedText);\r\n            }\r\n            else\r\n            {\r\n                TranscriptText = string.Empty;\r\n                AddNarrativeEntry(\r\n                    result.ErrorMessage, \r\n                    NarrativeType.SystemMessage);\r\n            }\r\n        }, \"Voice recognition failed\");\r\n    }\r\n    \r\n    private async Task ProcessCommandAsync(string input)\r\n    {\r\n        await ExecuteAsync(async () =>\r\n        {\r\n            IsProcessing = true;\r\n            \r\n            // Add player command to story feed\r\n            AddNarrativeEntry(\r\n                $\"▶ \\\"{input}\\\"\", \r\n                NarrativeType.PlayerCommand);\r\n            \r\n            // Parse command\r\n            var context = BuildGameContext();\r\n            var parsed = await _parserService.ParseAsync(input, context);\r\n            \r\n            // Execute command\r\n            var result = await _commandRouter.RouteAsync(\r\n                parsed, \r\n                _stateMachine.CurrentState);\r\n            \r\n            // Add result to story feed\r\n            AddNarrativeEntry(\r\n                result.Message, \r\n                result.Success \r\n                    ? NarrativeType.Success \r\n                    : NarrativeType.Failure);\r\n            \r\n            // Update UI state\r\n            UpdateUIState();\r\n            \r\n            // Optional TTS narration\r\n            if (_ttsService != null && result.Success)\r\n            {\r\n                await _ttsService.SpeakAsync(result.Message);\r\n            }\r\n            \r\n            IsProcessing = false;\r\n        }, \"Command processing failed\");\r\n    }\r\n    \r\n    private GameContext BuildGameContext()\r\n    {\r\n        var room = _stateMachine.GetCurrentRoom();\r\n        var visibleObjects = _stateMachine.GetVisibleObjects();\r\n        \r\n        return new GameContext\r\n        {\r\n            CurrentLocation = room.Id,\r\n            VisibleObjects = visibleObjects.Select(o => o.Id).ToList(),\r\n            InventoryItems = _stateMachine.CurrentState.Player.Inventory\r\n                .Items.Select(i => i.Id).ToList(),\r\n            GameFlags = _stateMachine.CurrentState.Progress.StoryFlags\r\n        };\r\n    }\r\n    \r\n    private void UpdateUIState()\r\n    {\r\n        var state = _stateMachine.CurrentState;\r\n        var room = _stateMachine.GetCurrentRoom();\r\n        \r\n        CurrentLocation = room.Id.Replace(\"_\", \" \");\r\n        PlayerHealth = state.Player.Health;\r\n        LightLevel = room.LightLevel.ToString();\r\n        GameTime = state.Player.Stats.PlayTime.ToString(@\"h\\:mm\");\r\n    }\r\n    \r\n    private void AddNarrativeEntry(string text, NarrativeType type)\r\n    {\r\n        var entry = new NarrativeEntry\r\n        {\r\n            Text = text,\r\n            Type = type,\r\n            Timestamp = DateTime.Now\r\n        };\r\n        \r\n        MainThread.BeginInvokeOnMainThread(() =>\r\n        {\r\n            StoryFeed.Add(entry);\r\n            \r\n            // Keep only last 100 entries for performance\r\n            while (StoryFeed.Count > 100)\r\n            {\r\n                StoryFeed.RemoveAt(0);\r\n            }\r\n        });\r\n    }\r\n    \r\n    [RelayCommand]\r\n    private async Task ShowInventoryAsync()\r\n    {\r\n        await Shell.Current.GoToAsync(nameof(InventoryPage));\r\n    }\r\n    \r\n    [RelayCommand]\r\n    private async Task ShowMenuAsync()\r\n    {\r\n        // Show menu options\r\n    }\r\n    \r\n    [RelayCommand]\r\n    private async Task ShowSettingsAsync()\r\n    {\r\n        await Shell.Current.GoToAsync(nameof(SettingsPage));\r\n    }\r\n}\r\n```\r\n\r\n## Platform-Specific: Android MainActivity\r\n\r\n```csharp\r\nusing Android.App;\r\nusing Android.Content.PM;\r\nusing Android.OS;\r\n\r\nnamespace TheCabin.Platforms.Android;\r\n\r\n[Activity(\r\n    Theme = \"@style/Maui.SplashTheme\", \r\n    MainLauncher = true, \r\n    ConfigurationChanges = ConfigChanges.ScreenSize | \r\n                          ConfigChanges.Orientation | \r\n                          ConfigChanges.UiMode | \r\n                          ConfigChanges.ScreenLayout | \r\n                          ConfigChanges.SmallestScreenSize | \r\n                          ConfigChanges.Density,\r\n    ScreenOrientation = ScreenOrientation.Portrait)]\r\npublic class MainActivity : MauiAppCompatActivity\r\n{\r\n    protected override void OnCreate(Bundle savedInstanceState)\r\n    {\r\n        base.OnCreate(savedInstanceState);\r\n        \r\n        // Request permissions\r\n        RequestPermissions();\r\n    }\r\n    \r\n    private async void RequestPermissions()\r\n    {\r\n        await Permissions.RequestAsync<Permissions.Microphone>();\r\n        await Permissions.RequestAsync<Permissions.StorageWrite>();\r\n    }\r\n}\r\n```\r\n\r\n## Platform-Specific: AndroidManifest.xml\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\">\r\n    <application \r\n        android:allowBackup=\"true\" \r\n        android:icon=\"@mipmap/appicon\" \r\n        android:roundIcon=\"@mipmap/appicon_round\" \r\n        android:supportsRtl=\"true\"\r\n        android:label=\"The Cabin\">\r\n    </application>\r\n    \r\n    <uses-permission android:name=\"android.permission.INTERNET\" />\r\n    <uses-permission android:name=\"android.permission.RECORD_AUDIO\" />\r\n    <uses-permission android:name=\"android.permission.MODIFY_AUDIO_SETTINGS\" />\r\n    <uses-permission android:name=\"android.permission.WAKE_LOCK\" />\r\n    <uses-permission android:name=\"android.permission.VIBRATE\" />\r\n    \r\n    <uses-sdk android:minSdkVersion=\"23\" android:targetSdkVersion=\"34\" />\r\n</manifest>\r\n```\r\n\r\n## Build Configuration\r\n\r\n```xml\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n    <PropertyGroup>\r\n        <TargetFrameworks>net8.0-android</TargetFrameworks>\r\n        <OutputType>Exe</OutputType>\r\n        <RootNamespace>TheCabin</RootNamespace>\r\n        <UseMaui>true</UseMaui>\r\n        <SingleProject>true</SingleProject>\r\n        <ImplicitUsings>enable</ImplicitUsings>\r\n        <Nullable>enable</Nullable>\r\n\r\n        <!-- Display name -->\r\n        <ApplicationTitle>The Cabin</ApplicationTitle>\r\n\r\n        <!-- App Identifier -->\r\n        <ApplicationId>com.thecabin.voiceadventure</ApplicationId>\r\n\r\n        <!-- Versions -->\r\n        <ApplicationDisplayVersion>1.0</ApplicationDisplayVersion>\r\n        <ApplicationVersion>1</ApplicationVersion>\r\n\r\n        <!-- Required for C# Hot Reload -->\r\n        <UseInterpreter Condition=\"'$(Configuration)' == 'Debug'\">True</UseInterpreter>\r\n\r\n        <SupportedOSPlatformVersion Condition=\"$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'android'\">23.0</SupportedOSPlatformVersion>\r\n    </PropertyGroup>\r\n\r\n    <PropertyGroup Condition=\"'$(Configuration)' == 'Release'\">\r\n        <AndroidPackageFormat>apk</AndroidPackageFormat>\r\n        <AndroidEnableProfiledAot>true</AndroidEnableProfiledAot>\r\n        <AndroidLinkMode>SdkOnly</AndroidLinkMode>\r\n        <AndroidUseAapt2>true</AndroidUseAapt2>\r\n        <RunAOTCompilation>false</RunAOTCompilation>\r\n    </PropertyGroup>\r\n\r\n    <ItemGroup>\r\n        <!-- App Icon -->\r\n        <MauiIcon Include=\"Resources\\AppIcon\\appicon.svg\" \r\n                  ForegroundFile=\"Resources\\AppIcon\\appiconfg.svg\" \r\n                  Color=\"#512BD4\" />\r\n\r\n        <!-- Splash Screen -->\r\n        <MauiSplashScreen Include=\"Resources\\Splash\\splash.svg\" \r\n                          Color=\"#512BD4\" \r\n                          BaseSize=\"128,128\" />\r\n\r\n        <!-- Images -->\r\n        <MauiImage Include=\"Resources\\Images\\*\" />\r\n\r\n        <!-- Custom Fonts -->\r\n        <MauiFont Include=\"Resources\\Fonts\\*\" />\r\n\r\n        <!-- Raw Assets (also remove the \"Resources\\Raw\" prefix) -->\r\n        <MauiAsset Include=\"Resources\\Raw\\**\" \r\n                   LogicalName=\"%(RecursiveDir)%(Filename)%(Extension)\" />\r\n    </ItemGroup>\r\n\r\n    <ItemGroup>\r\n        <PackageReference Include=\"Microsoft.Maui.Controls\" Version=\"8.0.0\" />\r\n        <PackageReference Include=\"Microsoft.Maui.Controls.Compatibility\" Version=\"8.0.0\" />\r\n        <PackageReference Include=\"Microsoft.Extensions.Logging.Debug\" Version=\"8.0.0\" />\r\n        <PackageReference Include=\"CommunityToolkit.Mvvm\" Version=\"8.2.2\" />\r\n        <PackageReference Include=\"CommunityToolkit.Maui\" Version=\"7.0.0\" />\r\n        <PackageReference Include=\"sqlite-net-pcl\" Version=\"1.8.116\" />\r\n        <PackageReference Include=\"SQLitePCLRaw.bundle_green\" Version=\"2.1.7\" />\r\n        <PackageReference Include=\"Azure.AI.OpenAI\" Version=\"1.0.0-beta.12\" />\r\n        <PackageReference Include=\"Microsoft.Extensions.Http.Polly\" Version=\"8.0.0\" />\r\n    </ItemGroup>\r\n\r\n    <ItemGroup>\r\n        <!-- Story Pack JSON files -->\r\n        <MauiAsset Include=\"Assets\\StoryPacks\\*.json\" />\r\n    </ItemGroup>\r\n</Project>\r\n```\r\n\r\n## Hot Reload Support\r\n\r\n```csharp\r\n#if DEBUG\r\n[assembly: System.Reflection.Metadata.MetadataUpdateHandler(\r\n    typeof(TheCabin.HotReloadService))]\r\n\r\nnamespace TheCabin;\r\n\r\npublic static class HotReloadService\r\n{\r\n    public static void ClearCache(Type[]? types)\r\n    {\r\n        // Clear any cached data that might prevent hot reload\r\n    }\r\n    \r\n    public static void UpdateApplication(Type[]? types)\r\n    {\r\n        // Refresh application state after hot reload\r\n    }\r\n}\r\n#endif\r\n```\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 02-system-architecture.md, 03-technical-stack.md, 07-ui-ux-design.md\r\n\n</file_content>\n\n<file_content path=\"docs/09-content-management.md\">\n# 09 - Content Management\r\n\r\n## Overview\r\n\r\nThis document details the content management system for The Cabin, including story pack format, content creation workflows, and dynamic content generation using AI.\r\n\r\n## Story Pack Format\r\n\r\n### Complete Story Pack Structure\r\n\r\n```json\r\n{\r\n  \"id\": \"classic_horror\",\r\n  \"theme\": \"Classic Horror\",\r\n  \"description\": \"A haunted log cabin deep in the woods, decaying interiors lit by candlelight.\",\r\n  \"version\": \"1.0.0\",\r\n  \"author\": \"The Cabin Team\",\r\n  \"startingRoomId\": \"cabin_main\",\r\n  \"metadata\": {\r\n    \"difficulty\": \"Medium\",\r\n    \"estimatedPlayTime\": 45,\r\n    \"tags\": [\"horror\", \"mystery\", \"supernatural\"],\r\n    \"coverImage\": \"classic_horror_cover.png\",\r\n    \"themeColor\": \"#8B0000\",\r\n    \"createdDate\": \"2025-01-01T00:00:00Z\",\r\n    \"modifiedDate\": \"2025-01-15T00:00:00Z\"\r\n  },\r\n  \"rooms\": [\r\n    {\r\n      \"id\": \"cabin_main\",\r\n      \"description\": \"You stand in a dimly lit wooden cabin. Dust motes dance in shafts of pale moonlight streaming through cracked windows. The air smells of old wood and decay.\",\r\n      \"objects\": [\"lantern\", \"door\", \"table\"],\r\n      \"exits\": {\r\n        \"north\": \"forest_edge\",\r\n        \"up\": \"cabin_loft\"\r\n      },\r\n      \"state\": {\r\n        \"isLocked\": false,\r\n        \"flags\": {\r\n          \"fire_lit\": false,\r\n          \"candles_lit\": false\r\n        },\r\n        \"visibleObjectIds\": [\"lantern\", \"door\", \"table\"]\r\n      },\r\n      \"isVisited\": false,\r\n      \"ambientSound\": \"wind_howling.mp3\",\r\n      \"lightLevel\": \"Dim\"\r\n    }\r\n  ],\r\n  \"objects\": {\r\n    \"lantern\": {\r\n      \"id\": \"lantern\",\r\n      \"name\": \"Rusty Lantern\",\r\n      \"description\": \"An old brass lantern covered in rust and cobwebs. Oil sloshes inside when you shake it.\",\r\n      \"type\": \"Light\",\r\n      \"state\": {\r\n        \"currentState\": \"unlit\",\r\n        \"flags\": {\r\n          \"has_oil\": true\r\n        },\r\n        \"usageCount\": 0\r\n      },\r\n      \"actions\": {\r\n        \"take\": {\r\n          \"verb\": \"take\",\r\n          \"successMessage\": \"You pick up the lantern. It feels heavy with oil.\",\r\n          \"failureMessage\": \"You can't take that.\",\r\n          \"stateChanges\": [\r\n            {\r\n              \"target\": \"self\",\r\n              \"property\": \"IsVisible\",\r\n              \"newValue\": false\r\n            }\r\n          ],\r\n          \"requiredFlags\": [],\r\n          \"consumesItem\": false\r\n        },\r\n        \"light\": {\r\n          \"verb\": \"light\",\r\n          \"successMessage\": \"The lantern flickers to life, casting dancing shadows on the walls.\",\r\n          \"failureMessage\": \"You need matches or a lighter.\",\r\n          \"stateChanges\": [\r\n            {\r\n              \"target\": \"self\",\r\n              \"property\": \"CurrentState\",\r\n              \"newValue\": \"lit\"\r\n            },\r\n            {\r\n              \"target\": \"room\",\r\n              \"property\": \"LightLevel\",\r\n              \"newValue\": \"Bright\"\r\n            }\r\n          ],\r\n          \"requiredFlags\": [\"has_matches\"],\r\n          \"consumesItem\": false\r\n        }\r\n      },\r\n      \"requiredItems\": [],\r\n      \"isCollectable\": true,\r\n      \"isVisible\": true,\r\n      \"weight\": 3\r\n    }\r\n  },\r\n  \"achievements\": [\r\n    {\r\n      \"id\": \"first_steps\",\r\n      \"name\": \"First Steps\",\r\n      \"description\": \"Enter the cabin for the first time\",\r\n      \"requiredFlags\": [\"cabin_entered\"],\r\n      \"isUnlocked\": false\r\n    },\r\n    {\r\n      \"id\": \"light_bringer\",\r\n      \"name\": \"Light Bringer\",\r\n      \"description\": \"Light the lantern\",\r\n      \"requiredFlags\": [\"lantern_lit\"],\r\n      \"isUnlocked\": false\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n## Story Pack Service\r\n\r\n```csharp\r\nnamespace TheCabin.Services\r\n{\r\n    public class StoryPackService : IStoryPackService\r\n    {\r\n        private readonly IStoryPackRepository _repository;\r\n        private readonly ILogger<StoryPackService> _logger;\r\n        private Dictionary<string, StoryPack> _loadedPacks;\r\n        \r\n        public StoryPackService(\r\n            IStoryPackRepository repository,\r\n            ILogger<StoryPackService> logger)\r\n        {\r\n            _repository = repository;\r\n            _logger = logger;\r\n            _loadedPacks = new Dictionary<string, StoryPack>();\r\n        }\r\n        \r\n        public async Task<List<StoryPackInfo>> GetAvailablePacksAsync()\r\n        {\r\n            var packs = await _repository.GetAllPacksAsync();\r\n            \r\n            return packs.Select(p => new StoryPackInfo\r\n            {\r\n                Id = p.Id,\r\n                Theme = p.Theme,\r\n                Description = p.Description,\r\n                Difficulty = p.Metadata.Difficulty,\r\n                EstimatedPlayTime = p.Metadata.EstimatedPlayTime,\r\n                Tags = p.Metadata.Tags,\r\n                CoverImage = p.Metadata.CoverImage\r\n            }).ToList();\r\n        }\r\n        \r\n        public async Task<StoryPack> LoadPackAsync(string packId)\r\n        {\r\n            // Check if already loaded\r\n            if (_loadedPacks.TryGetValue(packId, out var cached))\r\n            {\r\n                return cached;\r\n            }\r\n            \r\n            // Load from repository\r\n            var pack = await _repository.GetPackAsync(packId);\r\n            \r\n            if (pack == null)\r\n            {\r\n                throw new FileNotFoundException(\r\n                    $\"Story pack not found: {packId}\");\r\n            }\r\n            \r\n            // Validate pack\r\n            ValidatePack(pack);\r\n            \r\n            // Cache and return\r\n            _loadedPacks[packId] = pack;\r\n            \r\n            _logger.LogInformation(\r\n                \"Loaded story pack: {Theme} ({RoomCount} rooms, {ObjectCount} objects)\",\r\n                pack.Theme, pack.Rooms.Count, pack.Objects.Count);\r\n            \r\n            return pack;\r\n        }\r\n        \r\n        private void ValidatePack(StoryPack pack)\r\n        {\r\n            // Validate starting room exists\r\n            if (!pack.Rooms.Any(r => r.Id == pack.StartingRoomId))\r\n            {\r\n                throw new InvalidDataException(\r\n                    $\"Starting room not found: {pack.StartingRoomId}\");\r\n            }\r\n            \r\n            // Validate all room exits point to existing rooms\r\n            foreach (var room in pack.Rooms)\r\n            {\r\n                foreach (var exit in room.Exits.Values)\r\n                {\r\n                    if (!pack.Rooms.Any(r => r.Id == exit))\r\n                    {\r\n                        _logger.LogWarning(\r\n                            \"Room {RoomId} has exit to non-existent room: {ExitId}\",\r\n                            room.Id, exit);\r\n                    }\r\n                }\r\n                \r\n                // Validate all object references exist\r\n                foreach (var objId in room.ObjectIds)\r\n                {\r\n                    if (!pack.Objects.ContainsKey(objId))\r\n                    {\r\n                        _logger.LogWarning(\r\n                            \"Room {RoomId} references non-existent object: {ObjectId}\",\r\n                            room.Id, objId);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        public async Task<StoryPack> CreatePackFromTemplateAsync(\r\n            string templateId,\r\n            Dictionary<string, string> parameters)\r\n        {\r\n            // Load template\r\n            var template = await _repository.GetTemplateAsync(templateId);\r\n            \r\n            // Apply parameters (e.g., theme-specific replacements)\r\n            var pack = ApplyTemplate(template, parameters);\r\n            \r\n            return pack;\r\n        }\r\n        \r\n        public void UnloadPack(string packId)\r\n        {\r\n            _loadedPacks.Remove(packId);\r\n            _logger.LogInformation(\"Unloaded story pack: {PackId}\", packId);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Content Creation Workflow\r\n\r\n### 1. Manual Content Creation\r\n\r\n```csharp\r\npublic class StoryPackBuilder\r\n{\r\n    private StoryPack _pack;\r\n    \r\n    public StoryPackBuilder(string id, string theme)\r\n    {\r\n        _pack = new StoryPack\r\n        {\r\n            Id = id,\r\n            Theme = theme,\r\n            Metadata = new StoryMetadata\r\n            {\r\n                CreatedDate = DateTime.UtcNow,\r\n                ModifiedDate = DateTime.UtcNow\r\n            }\r\n        };\r\n    }\r\n    \r\n    public StoryPackBuilder WithDescription(string description)\r\n    {\r\n        _pack.Description = description;\r\n        return this;\r\n    }\r\n    \r\n    public StoryPackBuilder WithDifficulty(Difficulty difficulty)\r\n    {\r\n        _pack.Metadata.Difficulty = difficulty;\r\n        return this;\r\n    }\r\n    \r\n    public StoryPackBuilder AddRoom(Room room)\r\n    {\r\n        _pack.Rooms.Add(room);\r\n        return this;\r\n    }\r\n    \r\n    public StoryPackBuilder AddObject(GameObject obj)\r\n    {\r\n        _pack.Objects[obj.Id] = obj;\r\n        return this;\r\n    }\r\n    \r\n    public StoryPackBuilder SetStartingRoom(string roomId)\r\n    {\r\n        _pack.StartingRoomId = roomId;\r\n        return this;\r\n    }\r\n    \r\n    public StoryPack Build()\r\n    {\r\n        // Validate before building\r\n        if (string.IsNullOrEmpty(_pack.StartingRoomId))\r\n        {\r\n            throw new InvalidOperationException(\r\n                \"Starting room must be set\");\r\n        }\r\n        \r\n        if (_pack.Rooms.Count == 0)\r\n        {\r\n            throw new InvalidOperationException(\r\n                \"Pack must contain at least one room\");\r\n        }\r\n        \r\n        return _pack;\r\n    }\r\n}\r\n```\r\n\r\n### 2. AI-Assisted Content Generation\r\n\r\n```csharp\r\npublic class AiContentGenerator\r\n{\r\n    private readonly ILlmApiClient _llmClient;\r\n    private readonly ILogger _logger;\r\n    \r\n    public async Task<StoryPack> GenerateStoryPackAsync(\r\n        string theme,\r\n        ContentGenerationOptions options)\r\n    {\r\n        _logger.LogInformation(\r\n            \"Generating story pack for theme: {Theme}\", theme);\r\n        \r\n        // Step 1: Generate pack metadata\r\n        var metadata = await GenerateMetadataAsync(theme, options);\r\n        \r\n        // Step 2: Generate rooms\r\n        var rooms = await GenerateRoomsAsync(theme, options.RoomCount);\r\n        \r\n        // Step 3: Generate objects for each room\r\n        var objects = new Dictionary<string, GameObject>();\r\n        foreach (var room in rooms)\r\n        {\r\n            var roomObjects = await GenerateRoomObjectsAsync(\r\n                theme, room, options.ObjectsPerRoom);\r\n            \r\n            foreach (var obj in roomObjects)\r\n            {\r\n                objects[obj.Id] = obj;\r\n                room.ObjectIds.Add(obj.Id);\r\n            }\r\n        }\r\n        \r\n        // Step 4: Create interconnections\r\n        ConnectRooms(rooms, options.Connectivity);\r\n        \r\n        // Step 5: Add puzzles and special items\r\n        await AddPuzzlesAsync(rooms, objects, options.PuzzleCount);\r\n        \r\n        var pack = new StoryPack\r\n        {\r\n            Id = GenerateId(theme),\r\n            Theme = theme,\r\n            Description = metadata.Description,\r\n            Version = \"1.0.0\",\r\n            Author = \"AI Generated\",\r\n            StartingRoomId = rooms.First().Id,\r\n            Rooms = rooms,\r\n            Objects = objects,\r\n            Metadata = metadata\r\n        };\r\n        \r\n        _logger.LogInformation(\r\n            \"Generated story pack: {Rooms} rooms, {Objects} objects\",\r\n            pack.Rooms.Count, pack.Objects.Count);\r\n        \r\n        return pack;\r\n    }\r\n    \r\n    private async Task<StoryMetadata> GenerateMetadataAsync(\r\n        string theme,\r\n        ContentGenerationOptions options)\r\n    {\r\n        var prompt = $@\"\r\nGenerate metadata for a text adventure game with theme: '{theme}'.\r\nInclude a compelling description (2-3 sentences), difficulty level, \r\nestimated play time, and 3-5 relevant tags.\r\n\r\nOutput as JSON:\r\n{{\r\n  \"\"description\"\": \"\"...\"\",\r\n  \"\"difficulty\"\": \"\"Easy|Medium|Hard\"\",\r\n  \"\"estimatedPlayTime\"\": 30,\r\n  \"\"tags\"\": [\"\"tag1\"\", \"\"tag2\"\", \"\"tag3\"\"]\r\n}}\";\r\n        \r\n        var response = await _llmClient.GenerateAsync(prompt);\r\n        return JsonSerializer.Deserialize<StoryMetadata>(response);\r\n    }\r\n    \r\n    private async Task<List<Room>> GenerateRoomsAsync(\r\n        string theme,\r\n        int count)\r\n    {\r\n        var prompt = $@\"\r\nGenerate {count} interconnected rooms for a '{theme}' themed adventure game.\r\nEach room should have:\r\n- Unique ID (lowercase, underscores)\r\n- Vivid description (2-3 sentences)\r\n- Light level (Bright, Normal, Dim, Dark, PitchBlack)\r\n- Suggested ambient sound\r\n\r\nOutput as JSON array.\";\r\n        \r\n        var response = await _llmClient.GenerateAsync(prompt);\r\n        return JsonSerializer.Deserialize<List<Room>>(response);\r\n    }\r\n    \r\n    private async Task<List<GameObject>> GenerateRoomObjectsAsync(\r\n        string theme,\r\n        Room room,\r\n        int count)\r\n    {\r\n        var prompt = $@\"\r\nGenerate {count} interactive objects for this room:\r\nTheme: {theme}\r\nRoom: {room.Description}\r\n\r\nObjects should include:\r\n- Mix of collectible items and furniture\r\n- Appropriate actions (take, use, examine, etc.)\r\n- Success/failure messages\r\n- State changes where relevant\r\n\r\nOutput as JSON array.\";\r\n        \r\n        var response = await _llmClient.GenerateAsync(prompt);\r\n        return JsonSerializer.Deserialize<List<GameObject>>(response);\r\n    }\r\n    \r\n    private void ConnectRooms(\r\n        List<Room> rooms,\r\n        double connectivity)\r\n    {\r\n        // Create a network of room connections\r\n        // Higher connectivity = more paths between rooms\r\n        \r\n        var random = new Random();\r\n        \r\n        for (int i = 0; i < rooms.Count - 1; i++)\r\n        {\r\n            // Always connect to next room (minimum connectivity)\r\n            var direction = GetRandomDirection();\r\n            rooms[i].Exits[direction] = rooms[i + 1].Id;\r\n            rooms[i + 1].Exits[GetOppositeDirection(direction)] = \r\n                rooms[i].Id;\r\n            \r\n            // Add extra connections based on connectivity factor\r\n            if (random.NextDouble() < connectivity)\r\n            {\r\n                var targetIndex = random.Next(rooms.Count);\r\n                if (targetIndex != i)\r\n                {\r\n                    direction = GetRandomDirection();\r\n                    if (!rooms[i].Exits.ContainsKey(direction))\r\n                    {\r\n                        rooms[i].Exits[direction] = rooms[targetIndex].Id;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    private async Task AddPuzzlesAsync(\r\n        List<Room> rooms,\r\n        Dictionary<string, GameObject> objects,\r\n        int puzzleCount)\r\n    {\r\n        // Generate puzzle scenarios\r\n        for (int i = 0; i < puzzleCount; i++)\r\n        {\r\n            var prompt = $@\"\r\nGenerate a puzzle for a text adventure game.\r\nInclude:\r\n- Locked door or container\r\n- Key or solution item\r\n- Clues in room descriptions\r\n- Satisfying resolution\r\n\r\nOutput as JSON with room IDs and object definitions.\";\r\n            \r\n            var response = await _llmClient.GenerateAsync(prompt);\r\n            // Parse and integrate puzzle into rooms and objects\r\n        }\r\n    }\r\n    \r\n    private string GetRandomDirection()\r\n    {\r\n        var directions = new[] { \"north\", \"south\", \"east\", \"west\", \r\n                                \"up\", \"down\" };\r\n        return directions[new Random().Next(directions.Length)];\r\n    }\r\n    \r\n    private string GetOppositeDirection(string direction)\r\n    {\r\n        return direction switch\r\n        {\r\n            \"north\" => \"south\",\r\n            \"south\" => \"north\",\r\n            \"east\" => \"west\",\r\n            \"west\" => \"east\",\r\n            \"up\" => \"down\",\r\n            \"down\" => \"up\",\r\n            _ => direction\r\n        };\r\n    }\r\n    \r\n    private string GenerateId(string theme)\r\n    {\r\n        return theme.ToLowerInvariant()\r\n            .Replace(\" \", \"_\")\r\n            .Replace(\"-\", \"_\");\r\n    }\r\n}\r\n\r\npublic class ContentGenerationOptions\r\n{\r\n    public int RoomCount { get; set; } = 6;\r\n    public int ObjectsPerRoom { get; set; } = 3;\r\n    public int PuzzleCount { get; set; } = 2;\r\n    public double Connectivity { get; set; } = 0.3;\r\n}\r\n```\r\n\r\n## Content Validation\r\n\r\n```csharp\r\npublic class StoryPackValidator\r\n{\r\n    public ValidationResult Validate(StoryPack pack)\r\n    {\r\n        var errors = new List<string>();\r\n        var warnings = new List<string>();\r\n        \r\n        // Check required fields\r\n        if (string.IsNullOrEmpty(pack.Id))\r\n            errors.Add(\"Pack ID is required\");\r\n        \r\n        if (string.IsNullOrEmpty(pack.Theme))\r\n            errors.Add(\"Theme is required\");\r\n        \r\n        if (pack.Rooms.Count == 0)\r\n            errors.Add(\"Pack must contain at least one room\");\r\n        \r\n        // Check starting room\r\n        if (!pack.Rooms.Any(r => r.Id == pack.StartingRoomId))\r\n            errors.Add($\"Starting room not found: {pack.StartingRoomId}\");\r\n        \r\n        // Validate rooms\r\n        foreach (var room in pack.Rooms)\r\n        {\r\n            ValidateRoom(room, pack, errors, warnings);\r\n        }\r\n        \r\n        // Validate objects\r\n        foreach (var obj in pack.Objects.Values)\r\n        {\r\n            ValidateObject(obj, errors, warnings);\r\n        }\r\n        \r\n        return new ValidationResult\r\n        {\r\n            IsValid = errors.Count == 0,\r\n            Errors = errors,\r\n            Warnings = warnings\r\n        };\r\n    }\r\n    \r\n    private void ValidateRoom(\r\n        Room room,\r\n        StoryPack pack,\r\n        List<string> errors,\r\n        List<string> warnings)\r\n    {\r\n        // Check description\r\n        if (string.IsNullOrWhiteSpace(room.Description))\r\n            errors.Add($\"Room {room.Id} has no description\");\r\n        \r\n        // Check exits\r\n        foreach (var exit in room.Exits)\r\n        {\r\n            if (!pack.Rooms.Any(r => r.Id == exit.Value))\r\n            {\r\n                warnings.Add(\r\n                    $\"Room {room.Id} exit '{exit.Key}' \" +\r\n                    $\"points to non-existent room: {exit.Value}\");\r\n            }\r\n        }\r\n        \r\n        // Check object references\r\n        foreach (var objId in room.ObjectIds)\r\n        {\r\n            if (!pack.Objects.ContainsKey(objId))\r\n            {\r\n                errors.Add(\r\n                    $\"Room {room.Id} references \" +\r\n                    $\"non-existent object: {objId}\");\r\n            }\r\n        }\r\n    }\r\n    \r\n    private void ValidateObject(\r\n        GameObject obj,\r\n        List<string> errors,\r\n        List<string> warnings)\r\n    {\r\n        if (string.IsNullOrEmpty(obj.Name))\r\n            errors.Add($\"Object {obj.Id} has no name\");\r\n        \r\n        if (string.IsNullOrEmpty(obj.Description))\r\n            warnings.Add($\"Object {obj.Id} has no description\");\r\n        \r\n        if (obj.Actions.Count == 0)\r\n            warnings.Add($\"Object {obj.Id} has no actions\");\r\n    }\r\n}\r\n```\r\n\r\n## Content Import/Export\r\n\r\n```csharp\r\npublic class ContentExporter\r\n{\r\n    public async Task ExportPackAsync(\r\n        StoryPack pack,\r\n        string outputPath)\r\n    {\r\n        var options = new JsonSerializerOptions\r\n        {\r\n            WriteIndented = true,\r\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\r\n        };\r\n        \r\n        var json = JsonSerializer.Serialize(pack, options);\r\n        await File.WriteAllTextAsync(outputPath, json);\r\n    }\r\n    \r\n    public async Task<StoryPack> ImportPackAsync(string filePath)\r\n    {\r\n        var json = await File.ReadAllTextAsync(filePath);\r\n        \r\n        var options = new JsonSerializerOptions\r\n        {\r\n            PropertyNameCaseInsensitive = true\r\n        };\r\n        \r\n        return JsonSerializer.Deserialize<StoryPack>(json, options);\r\n    }\r\n}\r\n```\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 04-data-models.md, 06-game-engine.md\r\n\n</file_content>\n\n<file_content path=\"docs/10-deployment-strategy.md\">\n# 10 - Deployment Strategy\r\n\r\n## Overview\r\n\r\nThis document outlines the deployment strategy for The Cabin, including build configurations, release management, distribution channels, and update mechanisms.\r\n\r\n## Build Configurations\r\n\r\n### Debug Build\r\n\r\n```xml\r\n<PropertyGroup Condition=\"'$(Configuration)' == 'Debug'\">\r\n    <AndroidEnableProfiledAot>false</AndroidEnableProfiledAot>\r\n    <AndroidLinkMode>None</AndroidLinkMode>\r\n    <AndroidUseInterpreter>true</AndroidUseInterpreter>\r\n    <DebugSymbols>true</DebugSymbols>\r\n    <Optimize>false</Optimize>\r\n    <DefineConstants>DEBUG;TRACE</DefineConstants>\r\n</PropertyGroup>\r\n```\r\n\r\n**Characteristics**:\r\n\r\n- Full debugging support\r\n- No code optimization\r\n- Larger APK size (~60-80 MB)\r\n- Faster build times\r\n- All logging enabled\r\n\r\n### Release Build\r\n\r\n```xml\r\n<PropertyGroup Condition=\"'$(Configuration)' == 'Release'\">\r\n    <AndroidPackageFormat>apk</AndroidPackageFormat>\r\n    <AndroidEnableProfiledAot>true</AndroidEnableProfiledAot>\r\n    <AndroidLinkMode>SdkOnly</AndroidLinkMode>\r\n    <AndroidUseAapt2>true</AndroidUseAapt2>\r\n    <AndroidCreatePackagePerAbi>false</AndroidCreatePackagePerAbi>\r\n    <DebugSymbols>false</DebugSymbols>\r\n    <Optimize>true</Optimize>\r\n    <EnableLLVM>false</EnableLLVM>\r\n    <AndroidEnableMultiDex>true</AndroidEnableMultiDex>\r\n</PropertyGroup>\r\n```\r\n\r\n**Characteristics**:\r\n\r\n- AOT compilation enabled\r\n- Code optimization\r\n- Smaller APK size (~40-50 MB)\r\n- Production-ready\r\n- Minimal logging\r\n\r\n## Version Management\r\n\r\n### Versioning Strategy\r\n\r\nFollowing Semantic Versioning (SemVer): `MAJOR.MINOR.PATCH`\r\n\r\n```xml\r\n<PropertyGroup>\r\n    <ApplicationDisplayVersion>1.0.0</ApplicationDisplayVersion>\r\n    <ApplicationVersion>1</ApplicationVersion>\r\n</PropertyGroup>\r\n```\r\n\r\n- **MAJOR**: Breaking changes, major features\r\n- **MINOR**: New features, backward compatible\r\n- **PATCH**: Bug fixes, minor improvements\r\n\r\n### Version Code (Android)\r\n\r\n```csharp\r\npublic static class VersionInfo\r\n{\r\n    public const string Version = \"1.0.0\";\r\n    public const int VersionCode = 1;\r\n    public const string BuildDate = \"2025-10-23\";\r\n    \r\n    public static string GetFullVersion()\r\n    {\r\n        return $\"{Version} ({VersionCode}) - {BuildDate}\";\r\n    }\r\n}\r\n```\r\n\r\n## Code Signing\r\n\r\n### Android App Signing\r\n\r\n#### Development/Debug Signing\r\n\r\n```bash\r\n# Uses debug keystore automatically\r\n# Location: %USERPROFILE%\\.android\\debug.keystore\r\nkeytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey\r\n```\r\n\r\n#### Production Signing\r\n\r\n```bash\r\n# Generate release keystore\r\nkeytool -genkey -v -keystore thecabin-release.keystore -alias thecabin -keyalg RSA -keysize 2048 -validity 10000\r\n\r\n# Sign APK\r\njarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 -keystore thecabin-release.keystore app-release-unsigned.apk thecabin\r\n\r\n# Verify signature\r\njarsigner -verify -verbose -certs app-release.apk\r\n```\r\n\r\n#### Keystore Configuration\r\n\r\n```xml\r\n<!-- In .csproj for automated signing -->\r\n<PropertyGroup Condition=\"'$(Configuration)' == 'Release'\">\r\n    <AndroidKeyStore>true</AndroidKeyStore>\r\n    <AndroidSigningKeyStore>thecabin-release.keystore</AndroidSigningKeyStore>\r\n    <AndroidSigningKeyAlias>thecabin</AndroidSigningKeyAlias>\r\n    <AndroidSigningKeyPass>$(KeystorePassword)</AndroidSigningKeyPass>\r\n    <AndroidSigningStorePass>$(KeystorePassword)</AndroidSigningStorePass>\r\n</PropertyGroup>\r\n```\r\n\r\n**IMPORTANT**: Never commit keystore files or passwords to source control!\r\n\r\n## Build Pipeline\r\n\r\n### GitHub Actions Workflow\r\n\r\n```yaml\r\nname: Android Build\r\n\r\non:\r\n  push:\r\n    branches: [ main, develop ]\r\n  pull_request:\r\n    branches: [ main ]\r\n  release:\r\n    types: [ published ]\r\n\r\njobs:\r\n  build:\r\n    runs-on: windows-latest\r\n    \r\n    steps:\r\n    - uses: actions/checkout@v3\r\n    \r\n    - name: Setup .NET\r\n      uses: actions/setup-dotnet@v3\r\n      with:\r\n        dotnet-version: 8.0.x\r\n    \r\n    - name: Install MAUI Workloads\r\n      run: dotnet workload install maui\r\n    \r\n    - name: Restore Dependencies\r\n      run: dotnet restore TheCabin.csproj\r\n    \r\n    - name: Build Debug APK\r\n      if: github.event_name == 'pull_request'\r\n      run: dotnet build TheCabin.csproj -c Debug -f net8.0-android\r\n    \r\n    - name: Build Release APK\r\n      if: github.ref == 'refs/heads/main'\r\n      env:\r\n        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}\r\n      run: dotnet publish TheCabin.csproj -c Release -f net8.0-android\r\n    \r\n    - name: Upload APK Artifact\r\n      uses: actions/upload-artifact@v3\r\n      with:\r\n        name: android-apk\r\n        path: bin/Release/net8.0-android/publish/*.apk\r\n    \r\n    - name: Run Tests\r\n      run: dotnet test TheCabin.Tests/TheCabin.Tests.csproj\r\n```\r\n\r\n### Azure DevOps Pipeline\r\n\r\n```yaml\r\ntrigger:\r\n  branches:\r\n    include:\r\n    - main\r\n    - develop\r\n\r\npool:\r\n  vmImage: 'windows-latest'\r\n\r\nvariables:\r\n  buildConfiguration: 'Release'\r\n  \r\nsteps:\r\n- task: UseDotNet@2\r\n  inputs:\r\n    version: '8.0.x'\r\n\r\n- script: dotnet workload install maui\r\n  displayName: 'Install MAUI Workloads'\r\n\r\n- task: DotNetCoreCLI@2\r\n  displayName: 'Restore NuGet Packages'\r\n  inputs:\r\n    command: 'restore'\r\n    projects: '**/*.csproj'\r\n\r\n- task: DotNetCoreCLI@2\r\n  displayName: 'Build Release APK'\r\n  inputs:\r\n    command: 'publish'\r\n    projects: 'TheCabin.csproj'\r\n    arguments: '-c $(buildConfiguration) -f net8.0-android'\r\n    \r\n- task: CopyFiles@2\r\n  displayName: 'Copy APK to Staging'\r\n  inputs:\r\n    contents: '**/*.apk'\r\n    targetFolder: '$(Build.ArtifactStagingDirectory)'\r\n\r\n- task: PublishBuildArtifacts@1\r\n  displayName: 'Publish APK Artifact'\r\n  inputs:\r\n    pathToPublish: '$(Build.ArtifactStagingDirectory)'\r\n    artifactName: 'android-build'\r\n```\r\n\r\n## Distribution Channels\r\n\r\n### 1. Google Play Store\r\n\r\n#### Preparation Checklist\r\n\r\n- [x] Create Google Play Console account ($25 one-time fee)\r\n- [x] Prepare app listing materials:\r\n  - App name, short description, full description\r\n  - Screenshots (phone, tablet, 7-inch tablet, 10-inch tablet)\r\n  - Feature graphic (1024 x 500 px)\r\n  - App icon (512 x 512 px)\r\n  - Promo video (optional)\r\n- [x] Set content rating questionnaire\r\n- [x] Set target audience and content\r\n- [x] Prepare privacy policy URL\r\n- [x] Configure app pricing (Free)\r\n\r\n#### Play Store Metadata\r\n\r\n```text\r\nTitle: The Cabin - Voice Adventure\r\nShort Description: \r\nExperience immersive voice-controlled text adventures in The Cabin.\r\n\r\nFull Description:\r\n🎙️ VOICE-CONTROLLED ADVENTURE\r\nThe Cabin brings classic text adventures into the modern era with cutting-edge voice recognition. Speak your commands naturally and watch the story unfold.\r\n\r\n✨ KEY FEATURES\r\n• Hands-free gameplay with voice commands\r\n• Multiple atmospheric story packs\r\n• Dynamic AI-powered narrative\r\n• Save your progress and return anytime\r\n• Offline play mode available\r\n\r\n🎭 STORY PACKS INCLUDED\r\n• Classic Horror: Haunted cabin mystery\r\n• Arctic Survival: Frozen isolation\r\n• Fantasy Magic: Wizard's workshop\r\n• Sci-Fi Isolation: Derelict space module\r\n• Cozy Mystery: Snowbound secrets\r\n\r\n🎮 HOW TO PLAY\r\nSimply tap the microphone and speak your commands: \"look around\", \"take lantern\", \"go north\". The game understands natural language, so talk as you would to a friend.\r\n\r\nPrivacy Policy: https://thecabin.app/privacy\r\n```\r\n\r\n#### Release Tracks\r\n\r\n1. **Internal Testing**: Team members only (1-100 testers)\r\n2. **Closed Testing**: Limited audience (up to 100,000 testers)\r\n3. **Open Testing**: Public beta (unlimited)\r\n4. **Production**: Full release\r\n\r\n#### Staged Rollout\r\n\r\n```text\r\nDay 1:  5% of users\r\nDay 3:  20% of users\r\nDay 5:  50% of users\r\nDay 7:  100% of users\r\n```\r\n\r\n### 2. Direct APK Distribution (Side-loading)\r\n\r\nFor beta testers or regions without Play Store access:\r\n\r\n```bash\r\n# Generate signed APK\r\ndotnet publish -c Release -f net8.0-android\r\n\r\n# APK location\r\nbin/Release/net8.0-android/publish/com.thecabin.voiceadventure-Signed.apk\r\n```\r\n\r\n**Distribution Methods**:\r\n\r\n- GitHub Releases\r\n- Direct download from website\r\n- Enterprise MDM systems\r\n\r\n### 3. Third-Party App Stores\r\n\r\nConsider additional distribution through:\r\n\r\n- Amazon Appstore\r\n- Samsung Galaxy Store\r\n- Huawei AppGallery\r\n\r\n## Update Mechanism\r\n\r\n### In-App Update Implementation\r\n\r\n```csharp\r\npublic class UpdateService\r\n{\r\n    private readonly HttpClient _httpClient;\r\n    private readonly ILogger _logger;\r\n    \r\n    private const string UpdateCheckUrl = \r\n        \"https://api.thecabin.app/version/check\";\r\n    \r\n    public async Task<UpdateInfo> CheckForUpdatesAsync()\r\n    {\r\n        try\r\n        {\r\n            var currentVersion = VersionInfo.Version;\r\n            var response = await _httpClient.GetAsync(\r\n                $\"{UpdateCheckUrl}?current={currentVersion}&platform=android\");\r\n            \r\n            if (response.IsSuccessStatusCode)\r\n            {\r\n                var json = await response.Content.ReadAsStringAsync();\r\n                return JsonSerializer.Deserialize<UpdateInfo>(json);\r\n            }\r\n        }\r\n        catch (Exception ex)\r\n        {\r\n            _logger.LogError(ex, \"Failed to check for updates\");\r\n        }\r\n        \r\n        return new UpdateInfo { UpdateAvailable = false };\r\n    }\r\n    \r\n    public async Task<bool> PromptUpdateAsync(UpdateInfo update)\r\n    {\r\n        if (!update.UpdateAvailable)\r\n            return false;\r\n        \r\n        var message = update.IsCritical\r\n            ? $\"Critical update available: {update.NewVersion}\\n\\n\" +\r\n              $\"{update.ReleaseNotes}\\n\\nThis update is required to continue.\"\r\n            : $\"Update available: {update.NewVersion}\\n\\n\" +\r\n              $\"{update.ReleaseNotes}\\n\\nWould you like to update now?\";\r\n        \r\n        var result = await Application.Current.MainPage.DisplayAlert(\r\n            \"Update Available\",\r\n            message,\r\n            update.IsCritical ? \"Update Now\" : \"Update\",\r\n            update.IsCritical ? null : \"Later\");\r\n        \r\n        if (result)\r\n        {\r\n            await OpenUpdateLinkAsync(update.UpdateUrl);\r\n            return true;\r\n        }\r\n        \r\n        return false;\r\n    }\r\n    \r\n    private async Task OpenUpdateLinkAsync(string url)\r\n    {\r\n        await Launcher.OpenAsync(new Uri(url));\r\n    }\r\n}\r\n\r\npublic class UpdateInfo\r\n{\r\n    public bool UpdateAvailable { get; set; }\r\n    public string NewVersion { get; set; }\r\n    public string ReleaseNotes { get; set; }\r\n    public string UpdateUrl { get; set; }\r\n    public bool IsCritical { get; set; }\r\n}\r\n```\r\n\r\n### Content Pack Updates\r\n\r\n```csharp\r\npublic class ContentUpdateService\r\n{\r\n    private const string ContentManifestUrl = \r\n        \"https://cdn.thecabin.app/content/manifest.json\";\r\n    \r\n    public async Task<List<StoryPackUpdate>> CheckContentUpdatesAsync()\r\n    {\r\n        var manifest = await FetchManifestAsync();\r\n        var updates = new List<StoryPackUpdate>();\r\n        \r\n        foreach (var pack in manifest.Packs)\r\n        {\r\n            var localVersion = await GetLocalPackVersionAsync(pack.Id);\r\n            if (localVersion == null || \r\n                Version.Parse(pack.Version) > Version.Parse(localVersion))\r\n            {\r\n                updates.Add(new StoryPackUpdate\r\n                {\r\n                    PackId = pack.Id,\r\n                    NewVersion = pack.Version,\r\n                    DownloadUrl = pack.DownloadUrl,\r\n                    SizeInMb = pack.SizeInMb\r\n                });\r\n            }\r\n        }\r\n        \r\n        return updates;\r\n    }\r\n    \r\n    public async Task DownloadContentPackAsync(\r\n        StoryPackUpdate update,\r\n        IProgress<double> progress)\r\n    {\r\n        var httpClient = new HttpClient();\r\n        var response = await httpClient.GetAsync(\r\n            update.DownloadUrl,\r\n            HttpCompletionOption.ResponseHeadersRead);\r\n        \r\n        var totalBytes = response.Content.Headers.ContentLength ?? 0;\r\n        var downloadedBytes = 0L;\r\n        \r\n        using var contentStream = await response.Content.ReadAsStreamAsync();\r\n        using var fileStream = File.Create(\r\n            GetContentPackPath(update.PackId));\r\n        \r\n        var buffer = new byte[8192];\r\n        int bytesRead;\r\n        \r\n        while ((bytesRead = await contentStream.ReadAsync(buffer, 0, buffer.Length)) > 0)\r\n        {\r\n            await fileStream.WriteAsync(buffer, 0, bytesRead);\r\n            downloadedBytes += bytesRead;\r\n            \r\n            if (totalBytes > 0)\r\n            {\r\n                progress?.Report((double)downloadedBytes / totalBytes);\r\n            }\r\n        }\r\n    }\r\n    \r\n    private string GetContentPackPath(string packId)\r\n    {\r\n        return Path.Combine(\r\n            FileSystem.AppDataDirectory,\r\n            \"StorePacks\",\r\n            $\"{packId}.json\");\r\n    }\r\n}\r\n```\r\n\r\n## Monitoring and Analytics\r\n\r\n### Crash Reporting\r\n\r\n```csharp\r\n// Using Microsoft App Center\r\npublic static class AppCenterConfig\r\n{\r\n    public static void Initialize()\r\n    {\r\n        AppCenter.Start(\r\n            \"android={APPCENTER_SECRET}\",\r\n            typeof(Analytics),\r\n            typeof(Crashes));\r\n        \r\n        Crashes.GetErrorAttachments = (ErrorReport report) =>\r\n        {\r\n            return new[]\r\n            {\r\n                ErrorAttachmentLog.AttachmentWithText(\r\n                    GetDiagnosticInfo(),\r\n                    \"diagnostic_info.txt\")\r\n            };\r\n        };\r\n    }\r\n    \r\n    private static string GetDiagnosticInfo()\r\n    {\r\n        return $@\"\r\nApp Version: {VersionInfo.Version}\r\nDevice: {DeviceInfo.Model}\r\nOS: {DeviceInfo.Platform} {DeviceInfo.VersionString}\r\nMemory: {DeviceInfo.Idiom}\r\n        \";\r\n    }\r\n}\r\n```\r\n\r\n### Usage Analytics\r\n\r\n```csharp\r\npublic class AnalyticsService\r\n{\r\n    public void TrackEvent(string eventName, \r\n        Dictionary<string, string> properties = null)\r\n    {\r\n        Analytics.TrackEvent(eventName, properties);\r\n    }\r\n    \r\n    public void TrackGameSession(GameSession session)\r\n    {\r\n        TrackEvent(\"game_session_completed\", new Dictionary<string, string>\r\n        {\r\n            { \"theme\", session.ThemeId },\r\n            { \"duration_minutes\", session.Duration.TotalMinutes.ToString(\"F0\") },\r\n            { \"commands_executed\", session.CommandsExecuted.ToString() },\r\n            { \"puzzles_solved\", session.PuzzlesSolved.ToString() }\r\n        });\r\n    }\r\n    \r\n    public void TrackVoiceCommand(string command, bool success)\r\n    {\r\n        TrackEvent(\"voice_command\", new Dictionary<string, string>\r\n        {\r\n            { \"command_type\", command },\r\n            { \"success\", success.ToString() }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n## Rollback Strategy\r\n\r\n### Detecting Issues\r\n\r\n```csharp\r\npublic class RollbackDetector\r\n{\r\n    private readonly IAnalyticsService _analytics;\r\n    \r\n    public async Task<RollbackRecommendation> AnalyzeDeploymentAsync(\r\n        string version)\r\n    {\r\n        var metrics = await _analytics.GetMetricsAsync(version);\r\n        \r\n        var crashRate = metrics.Crashes / (double)metrics.Sessions;\r\n        var errorRate = metrics.Errors / (double)metrics.Commands;\r\n        \r\n        if (crashRate > 0.05) // 5% crash rate\r\n        {\r\n            return new RollbackRecommendation\r\n            {\r\n                ShouldRollback = true,\r\n                Reason = $\"High crash rate: {crashRate:P}\"\r\n            };\r\n        }\r\n        \r\n        if (errorRate > 0.20) // 20% error rate\r\n        {\r\n            return new RollbackRecommendation\r\n            {\r\n                ShouldRollback = true,\r\n                Reason = $\"High error rate: {errorRate:P}\"\r\n            };\r\n        }\r\n        \r\n        return new RollbackRecommendation\r\n        {\r\n            ShouldRollback = false\r\n        };\r\n    }\r\n}\r\n```\r\n\r\n### Rollback Process\r\n\r\n1. **Halt Production Rollout**: Pause staged rollout at current percentage\r\n2. **Investigate**: Review crash logs and user feedback\r\n3. **Fix or Revert**: Either hotfix and re-release, or revert to previous version\r\n4. **Communicate**: Notify users of issues and resolution timeline\r\n\r\n## Security Considerations\r\n\r\n### API Key Management\r\n\r\n```csharp\r\n// Store sensitive keys in secure storage\r\npublic class SecureConfigService\r\n{\r\n    public async Task<string> GetApiKeyAsync(string keyName)\r\n    {\r\n        return await SecureStorage.GetAsync(keyName);\r\n    }\r\n    \r\n    public async Task SetApiKeyAsync(string keyName, string value)\r\n    {\r\n        await SecureStorage.SetAsync(keyName, value);\r\n    }\r\n}\r\n```\r\n\r\n### ProGuard/R8 Configuration\r\n\r\n```text\r\n# Keep model classes\r\n-keep class TheCabin.Models.** { *; }\r\n\r\n# Keep API client interfaces\r\n-keep interface TheCabin.Services.I** { *; }\r\n\r\n# Keep custom exceptions\r\n-keep class TheCabin.Exceptions.** { *; }\r\n```\r\n\r\n## Release Checklist\r\n\r\n### Pre-Release\r\n\r\n- [ ] All tests passing\r\n- [ ] Code review completed\r\n- [ ] Version numbers updated\r\n- [ ] Release notes prepared\r\n- [ ] Screenshots updated\r\n- [ ] Privacy policy current\r\n- [ ] Terms of service current\r\n- [ ] APK signed with release key\r\n- [ ] APK tested on multiple devices\r\n- [ ] Analytics configured\r\n- [ ] Crash reporting tested\r\n\r\n### Release\r\n\r\n- [ ] Upload to Play Console\r\n- [ ] Set release notes\r\n- [ ] Configure rollout percentage\r\n- [ ] Submit for review\r\n\r\n### Post-Release\r\n\r\n- [ ] Monitor crash reports\r\n- [ ] Monitor user reviews\r\n- [ ] Track key metrics\r\n- [ ] Prepare hotfix if needed\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 03-technical-stack.md, 08-maui-implementation.md\r\n\n</file_content>\n\n<file_content path=\"docs/11-future-roadmap.md\">\n# 11 - Future Roadmap\r\n\r\n## Overview\r\n\r\nThis document outlines the future development roadmap for The Cabin, including planned features, platform expansions, and long-term vision.\r\n\r\n## Version Roadmap\r\n\r\n### Version 1.0 - Initial Release (Q1 2025)\r\n\r\n**Status**: Foundation Release\r\n\r\n**Core Features**:\r\n\r\n- ✅ Voice-controlled text adventure gameplay\r\n- ✅ 5 pre-built story packs\r\n- ✅ Android platform support\r\n- ✅ Offline play mode\r\n- ✅ Save/load game functionality\r\n- ✅ Basic TTS narration\r\n- ✅ LLM-powered command parsing\r\n\r\n**Target Metrics**:\r\n\r\n- 10,000 downloads in first month\r\n- 4.0+ star rating\r\n- < 2% crash rate\r\n\r\n---\r\n\r\n### Version 1.1 - Polish & Refinement (Q2 2025)\r\n\r\n**Status**: Planned\r\n\r\n**Features**:\r\n\r\n- [ ] Improved voice recognition accuracy\r\n- [ ] Enhanced UI animations and transitions\r\n- [ ] Additional voice customization options\r\n- [ ] Cloud save sync (optional)\r\n- [ ] Achievement system\r\n- [ ] Daily challenges\r\n- [ ] Performance optimizations\r\n\r\n**Bug Fixes & Improvements**:\r\n\r\n- Address user feedback from v1.0\r\n- Optimize battery usage during voice sessions\r\n- Reduce APK size by 15-20%\r\n- Improve offline mode reliability\r\n\r\n---\r\n\r\n### Version 1.5 - Content Expansion (Q3 2025)\r\n\r\n**Status**: Planned\r\n\r\n**Features**:\r\n\r\n- [ ] 5 new story packs (total: 10)\r\n- [ ] User-generated content support\r\n- [ ] Story pack workshop/marketplace\r\n- [ ] Advanced puzzle mechanics\r\n- [ ] Multi-ending narratives\r\n- [ ] Character customization\r\n- [ ] Inventory management improvements\r\n\r\n**New Story Themes**:\r\n\r\n1. **Noir Detective**: 1940s mystery investigation\r\n2. **Post-Apocalyptic**: Survival in wasteland\r\n3. **Victorian Ghost**: Haunted manor mystery\r\n4. **Cyberpunk Runner**: Futuristic street survival\r\n5. **Medieval Quest**: Fantasy adventure\r\n\r\n---\r\n\r\n### Version 2.0 - Multiplayer & Social (Q4 2025)\r\n\r\n**Status**: Conceptual\r\n\r\n**Major Features**:\r\n\r\n- [ ] **Cooperative Voice Sessions**: 2-player shared adventures\r\n- [ ] **Competitive Challenges**: Timed puzzle races\r\n- [ ] **Social Hub**: Share progress and achievements\r\n- [ ] **Leaderboards**: Global and friends rankings\r\n- [ ] **Live Events**: Weekly themed challenges\r\n\r\n**Technical Requirements**:\r\n\r\n- Real-time communication infrastructure\r\n- Game state synchronization\r\n- Voice chat integration\r\n- Anti-cheat measures\r\n- Matchmaking system\r\n\r\n**Implementation Approach**:\r\n\r\n```csharp\r\npublic interface IMultiplayerSession\r\n{\r\n    Task<SessionInfo> CreateSessionAsync(string storyPackId);\r\n    Task JoinSessionAsync(string sessionId);\r\n    Task<PlayerAction> WaitForPlayerTurnAsync();\r\n    Task BroadcastActionAsync(PlayerAction action);\r\n    Task SyncGameStateAsync(GameState state);\r\n}\r\n```\r\n\r\n---\r\n\r\n### Version 2.5 - AI-Generated Content (Q1 2026)\r\n\r\n**Status**: Research Phase\r\n\r\n**Features**:\r\n\r\n- [ ] **Dynamic Story Generation**: AI creates unique adventures\r\n- [ ] **Procedural Narratives**: Infinite replayability\r\n- [ ] **Adaptive Difficulty**: AI adjusts to player skill\r\n- [ ] **Natural Dialogue**: More fluid NPC conversations\r\n- [ ] **Context-Aware Responses**: Better understanding of player intent\r\n\r\n**AI Integration**:\r\n\r\n```csharp\r\npublic class DynamicStoryGenerator\r\n{\r\n    public async Task<StoryPack> GenerateDynamicAdventureAsync(\r\n        GenerationParameters parameters)\r\n    {\r\n        // Use GPT-4 or similar to create:\r\n        // - Unique setting and theme\r\n        // - Interconnected rooms\r\n        // - Puzzles and challenges\r\n        // - Multiple endings\r\n        // - Character arcs\r\n        \r\n        var story = await _aiEngine.GenerateAsync(parameters);\r\n        return await ValidateAndOptimizeAsync(story);\r\n    }\r\n}\r\n```\r\n\r\n---\r\n\r\n## Platform Expansions\r\n\r\n### iOS Support (Q2 2026)\r\n\r\n**Priority**: High\r\n\r\n**Requirements**:\r\n\r\n- Xcode 15+ and macOS development environment\r\n- iOS 15.0+ target\r\n- Swift/Objective-C platform-specific code\r\n- Apple App Store submission\r\n\r\n**Implementation Considerations**:\r\n\r\n- iOS Speech Recognition framework\r\n- AVFoundation for TTS\r\n- SwiftUI integration options\r\n- TestFlight beta testing\r\n- App Store review guidelines compliance\r\n\r\n**Estimated Effort**: 3-4 months\r\n\r\n---\r\n\r\n### Windows Desktop (Q3 2026)\r\n\r\n**Priority**: Medium\r\n\r\n**Features**:\r\n\r\n- Native Windows 11 application\r\n- Keyboard shortcuts for power users\r\n- Mouse and keyboard input alternatives\r\n- Larger screen optimizations\r\n- Desktop-specific features (e.g., multiple windows)\r\n\r\n**Technical Stack**:\r\n\r\n- WinUI 3 / Windows App SDK\r\n- Windows Speech Platform\r\n- Microsoft Store distribution\r\n\r\n**Estimated Effort**: 2-3 months\r\n\r\n---\r\n\r\n### Web Version (Q4 2026)\r\n\r\n**Priority**: Low-Medium\r\n\r\n**Features**:\r\n\r\n- Browser-based gameplay\r\n- Progressive Web App (PWA)\r\n- Cross-platform compatibility\r\n- Web Speech API integration\r\n- Cloud-only saves\r\n\r\n**Technical Approach**:\r\n\r\n- Blazor WebAssembly\r\n- SignalR for real-time features\r\n- IndexedDB for offline storage\r\n- Web Workers for background processing\r\n\r\n**Estimated Effort**: 4-5 months\r\n\r\n---\r\n\r\n## Advanced Features\r\n\r\n### AR Integration (2027+)\r\n\r\n**Status**: Experimental\r\n\r\n**Vision**:\r\nTransform physical spaces into game environments using augmented reality.\r\n\r\n**Concepts**:\r\n\r\n- **Room Scanning**: Map real rooms to game locations\r\n- **Object Recognition**: Real items become game objects\r\n- **Spatial Audio**: 3D sound positioning\r\n- **Physical Interaction**: Move around to explore\r\n\r\n**Technical Challenges**:\r\n\r\n- ARCore/ARKit integration\r\n- Indoor positioning accuracy\r\n- Battery consumption\r\n- Device compatibility\r\n\r\n---\r\n\r\n### Smart Speaker Integration (2027+)\r\n\r\n**Status**: Experimental\r\n\r\n**Platforms**:\r\n\r\n- Amazon Alexa\r\n- Google Assistant\r\n- Apple HomePod\r\n\r\n**Features**:\r\n\r\n- Voice-only gameplay (no screen required)\r\n- Ambient sound effects through smart speakers\r\n- Multi-room audio support\r\n- Household multiplayer sessions\r\n\r\n**Implementation**:\r\n\r\n```javascript\r\n// Alexa Skill Example\r\nconst LaunchRequestHandler = {\r\n    canHandle(handlerInput) {\r\n        return handlerInput.requestEnvelope.request.type === 'LaunchRequest';\r\n    },\r\n    handle(handlerInput) {\r\n        const speechText = 'Welcome to The Cabin. Begin your adventure.';\r\n        return handlerInput.responseBuilder\r\n            .speak(speechText)\r\n            .reprompt(speechText)\r\n            .getResponse();\r\n    }\r\n};\r\n```\r\n\r\n---\r\n\r\n### Accessibility Enhancements\r\n\r\n#### Phase 1 (v1.2)\r\n\r\n- [ ] Screen reader optimization\r\n- [ ] High contrast mode\r\n- [ ] Colorblind-friendly palette\r\n- [ ] Adjustable text sizes\r\n- [ ] Voice command alternatives\r\n\r\n#### Phase 2 (v1.5)\r\n\r\n- [ ] Closed captioning for audio\r\n- [ ] Switch control support\r\n- [ ] Haptic feedback options\r\n- [ ] Reduced motion mode\r\n- [ ] Dyslexia-friendly fonts\r\n\r\n#### Phase 3 (v2.0)\r\n\r\n- [ ] Audio descriptions for all scenes\r\n- [ ] Customizable control schemes\r\n- [ ] One-handed mode\r\n- [ ] Eye-tracking support (experimental)\r\n\r\n---\r\n\r\n## Content Strategy\r\n\r\n### Year 1 (2025)\r\n\r\n- **10 story packs** (5 at launch + 5 updates)\r\n- **Monthly mini-adventures**: Short 15-minute stories\r\n- **Seasonal events**: Halloween, Winter, Spring themes\r\n- **Community contests**: Best user-generated story\r\n\r\n### Year 2 (2026)\r\n\r\n- **20 additional story packs**\r\n- **Genre expansions**: Romance, Comedy, Thriller\r\n- **Celebrity voice packs**: Professional narrators\r\n- **Educational content**: History, Science themes\r\n- **Licensed content partnerships**: Books, movies, games\r\n\r\n### Year 3 (2027+)\r\n\r\n- **User workshop marketplace**\r\n- **AI-generated infinite content**\r\n- **Modding tools and API**\r\n- **Content creator program**\r\n\r\n---\r\n\r\n## Monetization Strategy\r\n\r\n### Free Tier\r\n\r\n- 5 base story packs\r\n- Local save only\r\n- Standard voice options\r\n- Ads between sessions (optional)\r\n\r\n### Premium Subscription ($4.99/month or $39.99/year)\r\n\r\n- All story packs included\r\n- Cloud saves and sync\r\n- Premium voice options\r\n- Ad-free experience\r\n- Early access to new content\r\n- Exclusive monthly stories\r\n\r\n### One-Time Purchases\r\n\r\n- Individual story packs: $1.99 - $3.99\r\n- Story pack bundles: $9.99 (5 packs)\r\n- Voice pack DLC: $2.99\r\n- Special editions: $4.99\r\n\r\n### In-App Purchases (Optional)\r\n\r\n- Cosmetic themes\r\n- Custom voice narrators\r\n- Achievement boosters\r\n- Hint systems\r\n\r\n**Projected Revenue Model**:\r\n\r\n```text\r\nYear 1: 70% Free, 25% Premium, 5% Purchases\r\nYear 2: 60% Free, 30% Premium, 10% Purchases\r\nYear 3: 50% Free, 35% Premium, 15% Purchases\r\n```\r\n\r\n---\r\n\r\n## Technical Debt & Refactoring\r\n\r\n### Priority 1 (Before v2.0)\r\n\r\n- [ ] Migrate to .NET 9\r\n- [ ] Implement comprehensive unit test coverage (80%+)\r\n- [ ] Refactor command parsing for better extensibility\r\n- [ ] Optimize database queries and caching\r\n- [ ] Improve error handling and recovery\r\n\r\n### Priority 2 (Before v3.0)\r\n\r\n- [ ] Microservices architecture for backend\r\n- [ ] GraphQL API implementation\r\n- [ ] Implement event sourcing for game state\r\n- [ ] Advanced telemetry and observability\r\n- [ ] A/B testing framework\r\n\r\n### Priority 3 (Ongoing)\r\n\r\n- [ ] Documentation maintenance\r\n- [ ] Code quality improvements\r\n- [ ] Dependency updates\r\n- [ ] Security audits\r\n- [ ] Performance profiling\r\n\r\n---\r\n\r\n## Community & Ecosystem\r\n\r\n### Developer Tools\r\n\r\n- [ ] **Story Pack Editor**: Visual tool for content creation\r\n- [ ] **Testing Simulator**: Test stories without building\r\n- [ ] **API Documentation**: For integrations\r\n- [ ] **SDK**: For third-party extensions\r\n- [ ] **Plugin System**: Extensibility framework\r\n\r\n### Community Features\r\n\r\n- [ ] **Official Forum**: Discussion and support\r\n- [ ] **Discord Server**: Real-time community\r\n- [ ] **Reddit Community**: User-driven content\r\n- [ ] **YouTube Channel**: Tutorials and showcases\r\n- [ ] **Wiki**: Community-maintained documentation\r\n\r\n### Content Creator Support\r\n\r\n- [ ] Revenue sharing for popular packs\r\n- [ ] Featured creator spotlight\r\n- [ ] Creation tutorials and templates\r\n- [ ] Quality assurance tools\r\n- [ ] Analytics dashboard\r\n\r\n---\r\n\r\n## Research & Innovation\r\n\r\n### AI/ML Research Areas\r\n\r\n1. **Better Voice Understanding**: Context-aware parsing\r\n2. **Emotion Detection**: Respond to player tone\r\n3. **Adaptive Storytelling**: Learn player preferences\r\n4. **Natural Language Generation**: More varied responses\r\n5. **Voice Cloning**: Personalized narration\r\n\r\n### Experimental Features\r\n\r\n- **Binaural Audio**: Immersive 3D sound\r\n- **Gesture Control**: Supplement voice commands\r\n- **Brain-Computer Interface**: Accessibility research\r\n- **Procedural Music**: Dynamic soundtracks\r\n- **Haptic Storytelling**: Tactile feedback\r\n\r\n---\r\n\r\n## Success Metrics\r\n\r\n### App Performance\r\n\r\n- Monthly Active Users (MAU): Target 100K by end of Year 1\r\n- Daily Active Users (DAU): 30-day retention > 40%\r\n- Average session duration: > 20 minutes\r\n- Crash-free rate: > 99%\r\n- App Store rating: > 4.5 stars\r\n\r\n### Engagement\r\n\r\n- Stories completed per user: > 3\r\n- Average commands per session: > 15\r\n- Voice recognition accuracy: > 90%\r\n- User-generated content submissions: 100+ per month\r\n- Community forum active users: 1000+\r\n\r\n### Revenue\r\n\r\n- Conversion to premium: > 5% of users\r\n- Average revenue per user (ARPU): > $2/year\r\n- Churn rate: < 10% monthly for premium\r\n- Customer lifetime value (LTV): > $25\r\n\r\n---\r\n\r\n## Risk Management\r\n\r\n### Technical Risks\r\n\r\n| Risk | Impact | Mitigation |\r\n|------|--------|------------|\r\n| Voice recognition accuracy issues | High | Multiple STT providers, fallback options |\r\n| LLM API costs too high | Medium | Local models, caching, rate limiting |\r\n| Platform policy changes | Medium | Diversify distribution channels |\r\n| Performance on low-end devices | Medium | Tiered graphics, optimization |\r\n\r\n### Business Risks\r\n\r\n| Risk | Impact | Mitigation |\r\n|------|--------|------------|\r\n| Low user adoption | High | Marketing campaign, PR, influencers |\r\n| Competition from similar apps | Medium | Unique features, quality content |\r\n| Monetization doesn't meet goals | High | Flexible pricing, A/B testing |\r\n| Content creation costs | Medium | AI generation, community content |\r\n\r\n### Legal Risks\r\n\r\n| Risk | Impact | Mitigation |\r\n|------|--------|------------|\r\n| Voice data privacy concerns | High | Clear policies, minimal data collection |\r\n| Content licensing issues | Medium | Original content, proper licensing |\r\n| Accessibility compliance | Low | Follow WCAG guidelines |\r\n| Age rating changes | Medium | Content moderation, parental controls |\r\n\r\n---\r\n\r\n## Long-Term Vision (2028+)\r\n\r\n**The Cabin Platform**: An ecosystem for interactive voice-driven storytelling\r\n\r\n**Key Pillars**:\r\n\r\n1. **Open Platform**: Anyone can create and publish\r\n2. **AI-Powered**: Infinite, personalized stories\r\n3. **Multi-Modal**: Voice, text, AR, VR integration\r\n4. **Social Experience**: Shared adventures globally\r\n5. **Educational**: Learning through interactive fiction\r\n\r\n**Ultimate Goal**: Become the leading platform for voice-controlled interactive storytelling, democratizing content creation and making adventures accessible to everyone, everywhere.\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Related Documents**: 01-project-overview.md, 10-deployment-strategy.md\r\n\n</file_content>\n</file_content>"},{"type":"text","text":"\n\n# Todo List (Optional - Plan Mode)\n\n\n\nWhile in PLAN MODE, if you've outlined concrete steps or requirements for the user, you may include a preliminary todo list using the task_progress parameter.\n\nReminder on how to use the task_progress parameter:\n\n\n\n1. To create or update a todo list, include the task_progress parameter in the next tool call\n\n2. Review each item and update its status:\n\n   - Mark completed items with: - [x]\n\n   - Keep incomplete items as: - [ ]\n\n   - Add new items if you discover additional steps\n\n3. Modify the list as needed:\n\n\t\t- Add any new steps you've discovered\n\n\t\t- Reorder if the sequence has changed\n\n4. Ensure the list accurately reflects the current state\n\n\n\n**Remember:** Keeping the todo list updated helps track progress and ensures nothing is missed."},{"type":"text","text":"<environment_details>\n# Visual Studio Code Visible Files\ndocs/11-future-roadmap.md\n\n# Visual Studio Code Open Tabs\ndocs/01-project-overview.md\ndocs/02-system-architecture.md\ndocs/04-data-models.md\ndocs/07-ui-ux-design.md\ndocs/08-maui-implementation.md\ndocs/09-content-management.md\ndocs/10-deployment-strategy.md\ndocs/11-future-roadmap.md\ndocs/06-game-engine.md\ndocs/03-technical-stack.md\ndocs/05-voice-pipeline.md\n\n# Current Time\n10/23/2025, 7:33:10 PM (America/Los_Angeles, UTC-7:00)\n\n# Current Working Directory (c:/GIT/agorevski/TheCabin) Files\nThe_Cabin_Game_Design_Doc.md\ndocs/\ndocs/01-project-overview.md\ndocs/02-system-architecture.md\ndocs/03-technical-stack.md\ndocs/04-data-models.md\ndocs/05-voice-pipeline.md\ndocs/06-game-engine.md\ndocs/07-ui-ux-design.md\ndocs/08-maui-implementation.md\ndocs/09-content-management.md\ndocs/10-deployment-strategy.md\ndocs/11-future-roadmap.md\nstory_packs/\nstory_packs/arctic_survival.json\nstory_packs/classic_horror.json\nstory_packs/cozy_mystery.json\nstory_packs/fantasy_magic.json\nstory_packs/sci_fi_isolation.json\n\n# Workspace Configuration\n{\n  \"workspaces\": {\n    \"c:\\\\GIT\\\\agorevski\\\\TheCabin\": {\n      \"hint\": \"TheCabin\",\n      \"associatedRemoteUrls\": [\n        \"origin: https://github.com/agorevski/TheCabin.git\"\n      ],\n      \"latestGitCommitHash\": \"107486f3fbd00ecde524e30ed02d8f3d0f5a0b3c\"\n    }\n  }\n}\n\n# Detected CLI Tools\nThese are some of the tools on the user's machine, and may be useful if needed to accomplish the task: git, docker, kubectl, az, npm, yarn, pnpm, pip, go, curl, cmake, python, node, code, dotnet. This list is not exhaustive, and other tools may be available.\n\n# Context Window Usage\n0 / 128K tokens used (0%)\n\n# Current Mode\nPLAN MODE\nIn this mode you should focus on information gathering, asking questions, and architecting a solution. Once you have a plan, use the plan_mode_respond tool to engage in a conversational back and forth with the user. Do not use the plan_mode_respond tool until you've gathered all the information you need e.g. with read_file or ask_followup_question.\n(Remember: If it seems the user wants you to use tools only available in Act Mode, you should ask the user to \"toggle to Act mode\" (use those words) - they will have to manually do this themselves with the Plan/Act toggle button below. You do not have the ability to switch to Act Mode yourself, and must wait for the user to do it themselves once they are satisfied with the plan. You also cannot present an option to toggle to Act mode, as this will be something you need to direct the user to do manually themselves.)\n</environment_details>"}]},{"role":"assistant","content":[{"type":"text","text":"I'll analyze the documentation and create a comprehensive plan for designing and implementing this Android app. Let me start by reviewing the key documents to understand the full scope.\n\n<read_file>\n<path>docs/01-project-overview.md</path>\n</read_file>\n\n<read_file>\n<path>docs/\n\n[Response interrupted by a tool use result. Only one tool may be used at a time and should be placed at the end of the message.]"}]},{"role":"user","content":[{"type":"text","text":"[read_file for 'docs/01-project-overview.md'] Result:"},{"type":"text","text":"# 01 - Project Overview\r\n\r\n## Executive Summary\r\n\r\n**The Cabin** is a voice-controlled interactive fiction game for Android, built using .NET MAUI. Players explore mysterious environments by speaking commands, experiencing an immersive narrative-driven adventure that combines classic text adventure gameplay with modern speech recognition and AI-powered natural language processing.\r\n\r\n## Project Goals\r\n\r\n### Primary Objectives\r\n\r\n1. **Voice-First Experience**: Create a hands-free gaming experience using speech recognition and text-to-speech\r\n2. **Cross-Platform Foundation**: Leverage .NET MAUI for potential future iOS support while initially targeting Android\r\n3. **AI-Enhanced Gameplay**: Integrate LLM-based command parsing for natural language understanding\r\n4. **Rich Narrative Content**: Support multiple thematic story packs with extensible content system\r\n5. **Offline Capability**: Ensure core gameplay functions without internet connectivity\r\n\r\n### Success Criteria\r\n\r\n- Speech recognition accuracy > 90% for common commands\r\n- Command processing latency < 2 seconds\r\n- Smooth 60 FPS UI performance\r\n- Support for 5+ thematic story packs\r\n- Battery consumption < 15% per hour of gameplay\r\n\r\n## Scope\r\n\r\n### In Scope\r\n\r\n- Android application (API Level 23+, Android 6.0+)\r\n- Voice input and output\r\n- 5 pre-built thematic story packs\r\n- Local game state persistence\r\n- Offline speech recognition option\r\n- Online LLM integration for command parsing\r\n- Text-based gameplay with voice narration\r\n- Inventory and puzzle systems\r\n- Save/load functionality\r\n\r\n### Out of Scope (MVP)\r\n\r\n- iOS implementation\r\n- Multiplayer functionality\r\n- AR/VR features\r\n- Smart speaker integration\r\n- Real-time voice synthesis during gameplay\r\n- User-generated content tools\r\n- Cloud save synchronization\r\n\r\n### Future Considerations\r\n\r\n- iOS version via MAUI\r\n- Procedurally generated content\r\n- Community content marketplace\r\n- Accessibility features (visual impairment support)\r\n- Localization and multi-language support\r\n\r\n## Technology Stack Justification\r\n\r\n### .NET MAUI\r\n\r\n**Chosen for:**\r\n\r\n- Native Android performance\r\n- C# language benefits (strong typing, async/await, LINQ)\r\n- Extensive library ecosystem\r\n- Future cross-platform expansion (iOS, Windows)\r\n- Mature MVVM framework support\r\n- Microsoft backing and long-term support\r\n\r\n**Alternatives Considered:**\r\n\r\n- Native Kotlin: Limited to Android only\r\n- Flutter: Dart language less familiar to .NET developers\r\n- React Native: Performance concerns for real-time audio\r\n- Xamarin.Forms: Deprecated in favor of MAUI\r\n\r\n### Android Target Platform\r\n\r\n**Minimum SDK**: API Level 23 (Android 6.0 Marshmallow)\r\n\r\n- 95%+ device coverage\r\n- Runtime permissions model support\r\n- Modern speech recognition APIs\r\n\r\n**Target SDK**: API Level 34 (Android 14)\r\n\r\n- Latest security and performance features\r\n- Predictive back gesture support\r\n- Enhanced privacy controls\r\n\r\n## Key Technical Challenges\r\n\r\n### 1. Speech Recognition Accuracy\r\n\r\n**Challenge**: Ambient noise, accents, and command variations\r\n**Mitigation**:\r\n\r\n- Confidence threshold filtering\r\n- Context-aware re-prompting\r\n- Multiple recognition engine support\r\n- User calibration option\r\n\r\n### 2. LLM Integration Latency\r\n\r\n**Challenge**: Network delays affecting gameplay flow\r\n**Mitigation**:\r\n\r\n- Command caching for common actions\r\n- Local fallback parser for basic commands\r\n- Async processing with loading indicators\r\n- Optimistic UI updates\r\n\r\n### 3. Battery Consumption\r\n\r\n**Challenge**: Continuous microphone and CPU usage\r\n**Mitigation**:\r\n\r\n- Push-to-talk option alongside voice activation\r\n- Efficient audio processing\r\n- TTS caching\r\n- Background processing optimization\r\n\r\n### 4. Offline Functionality\r\n\r\n**Challenge**: LLM dependency for command parsing\r\n**Mitigation**:\r\n\r\n- Local rule-based parser for standard commands\r\n- Offline-capable ML model integration (optional)\r\n- Graceful degradation of features\r\n- Clear online/offline mode indicators\r\n\r\n## Project Timeline (Estimated)\r\n\r\n### Phase 1: Foundation (4-6 weeks)\r\n\r\n- Project setup and architecture\r\n- Core MAUI application structure\r\n- Basic UI implementation\r\n- Data models and storage layer\r\n\r\n### Phase 2: Voice Pipeline (4-6 weeks)\r\n\r\n- Speech recognition integration\r\n- LLM parser implementation\r\n- TTS integration\r\n- Command processing engine\r\n\r\n### Phase 3: Game Engine (6-8 weeks)\r\n\r\n- State machine implementation\r\n- Room navigation system\r\n- Inventory and puzzle mechanics\r\n- Story pack loader\r\n\r\n### Phase 4: Polish & Testing (4-6 weeks)\r\n\r\n- UI/UX refinement\r\n- Performance optimization\r\n- Testing and bug fixes\r\n- Documentation\r\n\r\n### Phase 5: Deployment (2-3 weeks)\r\n\r\n- Google Play preparation\r\n- Beta testing\r\n- Release preparation\r\n\r\n**Total Estimated Timeline**: 20-29 weeks (5-7 months)\r\n\r\n## Success Metrics\r\n\r\n### Technical Metrics\r\n\r\n- App startup time < 3 seconds\r\n- Memory usage < 150 MB\r\n- APK size < 50 MB\r\n- Crash rate < 1%\r\n\r\n### User Experience Metrics\r\n\r\n- Voice command success rate > 85%\r\n- Average session length > 15 minutes\r\n- Game completion rate > 40%\r\n- User rating target: 4.0+ stars\r\n\r\n### Performance Metrics\r\n\r\n- 60 FPS UI rendering\r\n- Audio latency < 200ms\r\n- Command processing < 2 seconds\r\n- Battery drain < 15% per hour\r\n\r\n## Risk Assessment\r\n\r\n| Risk | Probability | Impact | Mitigation |\r\n|------|-------------|--------|------------|\r\n| Speech recognition accuracy insufficient | Medium | High | Multiple engine support, fallback text input |\r\n| LLM costs too high | Medium | Medium | Local parser fallback, command caching |\r\n| Battery drain excessive | Low | High | Push-to-talk mode, optimization |\r\n| Content creation bottleneck | Medium | Medium | AI-assisted content generation tools |\r\n| Android fragmentation issues | Medium | Medium | Extensive device testing, graceful degradation |\r\n\r\n## Team Structure Requirements\r\n\r\n### Core Team\r\n\r\n- **Lead Developer/Architect**: MAUI & Android expertise\r\n- **ML/AI Engineer**: Speech recognition & LLM integration\r\n- **Game Designer**: Narrative and puzzle design\r\n- **UI/UX Designer**: Voice interface patterns\r\n- **QA Engineer**: Mobile testing expertise\r\n\r\n### Supporting Roles\r\n\r\n- Technical Writer (documentation)\r\n- Sound Designer (audio feedback)\r\n- Content Writer (story packs)\r\n\r\n## Next Steps\r\n\r\n1. Review and approve architecture documents (02-11)\r\n2. Set up development environment and project structure\r\n3. Implement proof-of-concept for voice pipeline\r\n4. Design and validate data models\r\n5. Create first MVP iteration\r\n\r\n---\r\n\r\n**Document Version**: 1.0  \r\n**Last Updated**: 2025-10-23  \r\n**Status**: Draft for Review\r\n"},{"type":"text","text":"\n\n# Todo List (Optional - Plan Mode)\n\n\n\nWhile in PLAN MODE, if you've outlined concrete steps or requirements for the user, you may include a preliminary todo list using the task_progress parameter.\n\nReminder on how to use the task_progress parameter:\n\n\n\n1. To create or update a todo list, include the task_progress parameter in the next tool call\n\n2. Review each item and update its status:\n\n   - Mark completed items with: - [x]\n\n   - Keep incomplete items as: - [ ]\n\n   - Add new items if you discover additional steps\n\n3. Modify the list as needed:\n\n\t\t- Add any new steps you've discovered\n\n\t\t- Reorder if the sequence has changed\n\n4. Ensure the list accurately reflects the current state\n\n\n\n**Remember:** Keeping the todo list updated helps track progress and ensures nothing is missed."},{"type":"text","text":"<environment_details>\n# Visual Studio Code Visible Files\ndocs/11-future-roadmap.md\n\n# Visual Studio Code Open Tabs\ndocs/01-project-overview.md\ndocs/02-system-architecture.md\ndocs/04-data-models.md\ndocs/07-ui-ux-design.md\ndocs/08-maui-implementation.md\ndocs/09-content-management.md\ndocs/10-deployment-strategy.md\ndocs/11-future-roadmap.md\ndocs/06-game-engine.md\ndocs/03-technical-stack.md\ndocs/05-voice-pipeline.md\n\n# Current Time\n10/23/2025, 7:33:21 PM (America/Los_Angeles, UTC-7:00)\n\n# Context Window Usage\n0 / 127.805K tokens used (0%)\n\n# Current Mode\nPLAN MODE\nIn this mode you should focus on information gathering, asking questions, and architecting a solution. Once you have a plan, use the plan_mode_respond tool to engage in a conversational back and forth with the user. Do not use the plan_mode_respond tool until you've gathered all the information you need e.g. with read_file or ask_followup_question.\n(Remember: If it seems the user wants you to use tools only available in Act Mode, you should ask the user to \"toggle to Act mode\" (use those words) - they will have to manually do this themselves with the Plan/Act toggle button below. You do not have the ability to switch to Act Mode yourself, and must wait for the user to do it themselves once they are satisfied with the plan. You also cannot present an option to toggle to Act mode, as this will be something you need to direct the user to do manually themselves.)\n</environment_details>"}]},{"role":"assistant","content":[{"type":"text","text":"<plan_mode_respond>\n<response>\nI've reviewed the comprehensive documentation for **The Cabin** voice-controlled interactive fiction game. This is an excellent foundation for an Android app. Let me present a structured implementation plan based on the documentation.\n\n## Project Analysis\n\n**The Cabin** is a voice-first text adventure game with these key characteristics:\n- **Platform**: Android (API 23+) using .NET MAUI\n- **Core Feature**: Voice-controlled gameplay with speech recognition + LLM parsing\n- **Content**: 5 story packs with room-based navigation and puzzles\n- **Architecture**: Layered MVVM architecture with offline capability\n- **Timeline**: 5-7 months estimated development\n\n## Proposed Implementation Plan\n\n### Phase 1: Project Foundation (Weeks 1-6)\n\n**1.1 Development Environment Setup**\n- Install Visual Studio 2022 (17.8+) with .NET 8.0 SDK\n- Install Android SDK (API 23-34) and emulators\n- Set up Git repository structure\n- Configure NuGet packages (MAUI, CommunityToolkit.Mvvm, SQLite, Azure.AI.OpenAI)\n\n**1.2 Project Structure**\n- Create .NET MAUI Android project with proper folder organization\n- Implement dependency injection in MauiProgram.cs\n- Set up base MVVM infrastructure (BaseViewModel, services)\n- Configure Android permissions (microphone, storage)\n\n**1.3 Data Layer**\n- Implement SQLite database schema (GameSaves, CommandCache, Settings)\n- Create repository pattern for data access\n- Build domain models (Room, GameObject, Player, GameState)\n- Set up JSON-based story pack loading system\n\n### Phase 2: Voice Pipeline (Weeks 7-12)\n\n**2.1 Speech-to-Text Integration**\n- Implement Android SpeechRecognizer service\n- Add confidence threshold filtering\n- Create transcription preview UI component\n- Handle permissions and error cases\n\n**2.2 LLM Command Parser**\n- Integrate OpenAI API (gpt-4o-mini)\n- Implement command caching layer (memory + database)\n- Build local fallback parser for offline mode\n- Create context management for conversation history\n\n**2.3 Text-to-Speech**\n- Implement MAUI TTS service\n- Add voice customization options\n- Create audio caching for repeated narrations\n- Optimize for battery usage\n\n### Phase 3: Game Engine (Weeks 13-20)\n\n**3.1 State Machine**\n- Build GameStateMachine with room navigation\n- Implement state persistence and save/load\n- Create command routing system\n- Add validation and error handling\n\n**3.2 Command Handlers**\n- Implement core verbs (go, take, drop, use, examine, look)\n- Create action execution system with state changes\n- Build inventory management system\n- Add puzzle engine with completion detection\n\n**3.3 Story Pack System**\n- Load and validate story pack JSON files\n- Implement room interconnections\n- Create object interaction system\n- Ad\n\n[Response interrupted by user]"}]}]